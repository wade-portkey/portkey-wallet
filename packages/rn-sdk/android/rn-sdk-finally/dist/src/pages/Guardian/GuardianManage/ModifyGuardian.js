var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=exports.checkIsTheLastLoginGuardian=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _GStyles=_interopRequireDefault(require("../../../assets/theme/GStyles"));var _CommonButton=_interopRequireDefault(require("../../../components/CommonButton"));var _CommonText=require("../../../components/CommonText");var _Svg=_interopRequireDefault(require("../../../components/Svg"));var _react=_interopRequireWildcard(require("react"));var _reactNative=require("react-native");var _unit=require("../../../utils/unit");var _PageContainer=_interopRequireDefault(require("../../../components/PageContainer"));var _style=require("./style");var _ListItem=_interopRequireDefault(require("../../../components/ListItem"));var _hooks=require("../../../i18n/hooks");var _verifier=require("../../../packages/constants/verifier");var _verifier2=require("../../../packages/types/verifier");var _common=require("../../../constants/common");var _VerifierSelectOverlay=_interopRequireDefault(require("../components/VerifierSelectOverlay"));var _ActionSheet=_interopRequireDefault(require("../../../components/ActionSheet"));var _styles=require("../../../assets/theme/styles");var _Loading=_interopRequireDefault(require("../../../components/Loading"));var _CommonToast=_interopRequireDefault(require("../../../components/CommonToast"));var _wallet=require("../../../packages/types/types-ca/wallet");var _VerifierImage=require("../components/VerifierImage");var _GuardianAccountItem=_interopRequireDefault(require("../components/GuardianAccountItem"));var _constants=require("../../../global/constants");var _useEffectOnce=_interopRequireDefault(require("../../../hooks/useEffectOnce"));var _handler=require("../../../model/contract/handler");var _global=require("../../../model/global");var _core=require("../../../model/verify/core");var _wallet2=require("../../../model/wallet");var _controller=require("../../../network/controller");var _entries=require("../../../config/entries");var _UseBaseContainer=_interopRequireDefault(require("../../../model/container/UseBaseContainer"));var _hooks2=require("../../../model/verify/entry/hooks");var _socialRecovery=require("../../../model/verify/social-recovery");var _this=this,_jsxFileName="/Users/fengfeiyang/aelf/portkey-wallet/packages/rn-sdk/android/rn-sdk-finally/src/pages/Guardian/GuardianManage/ModifyGuardian.tsx";function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap(),t=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r;})(e);}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&Object.prototype.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u];}return n.default=e,t&&t.set(e,n),n;}var ModifyGuardian=function ModifyGuardian(config){var _useLanguage=(0,_hooks.useLanguage)(),t=_useLanguage.t;var _useState=(0,_react.useState)(),_useState2=(0,_slicedToArray2.default)(_useState,2),editGuardian=_useState2[0],setEditGuardian=_useState2[1];var _useState3=(0,_react.useState)(),_useState4=(0,_slicedToArray2.default)(_useState3,2),guardianItem=_useState4[0],setOriginalGuardianItem=_useState4[1];var _useState5=(0,_react.useState)([]),_useState6=(0,_slicedToArray2.default)(_useState5,2),userGuardiansList=_useState6[0],setUserGuardiansList=_useState6[1];var _useState7=(0,_react.useState)([]),_useState8=(0,_slicedToArray2.default)(_useState7,2),verifierMap=_useState8[0],setVerifierMap=_useState8[1];var verifierList=(0,_react.useMemo)(function(){return verifierMap?Object.values(verifierMap):[];},[verifierMap]);var _useState9=(0,_react.useState)(),_useState10=(0,_slicedToArray2.default)(_useState9,2),selectedType=_useState10[0],setSelectedType=_useState10[1];var _useState11=(0,_react.useState)(),_useState12=(0,_slicedToArray2.default)(_useState11,2),selectedVerifier=_useState12[0],setSelectedVerifier=_useState12[1];var _useState13=(0,_react.useState)(),_useState14=(0,_slicedToArray2.default)(_useState13,2),account=_useState14[0],setAccount=_useState14[1];var _useState15=(0,_react.useState)(Object.assign({},_common.INIT_NONE_ERROR)),_useState16=(0,_slicedToArray2.default)(_useState15,2),guardianError=_useState16[0],setGuardianError=_useState16[1];var _useBaseContainer=(0,_UseBaseContainer.default)({entryName:_entries.PortkeyEntries.MODIFY_GUARDIAN_ENTRY}),onFinish=_useBaseContainer.onFinish;var thirdPartyInfoRef=(0,_react.useRef)();(0,_useEffectOnce.default)((0,_asyncToGenerator2.default)(function*(){_Loading.default.show();try{var _yield$getOrReadCache2,_yield$getOrReadCache3,_guardiansInfo$guardi,_guardiansInfo$guardi2;var _ref2=JSON.parse(config.info),particularGuardianInfo=_ref2.particularGuardianInfo,originalGuardianItem=_ref2.originalGuardianItem;particularGuardianInfo&&setEditGuardian(particularGuardianInfo);originalGuardianItem&&setOriginalGuardianItem(originalGuardianItem);var _yield$getOrReadCache=yield(0,_handler.getOrReadCachedVerifierData)(),data=_yield$getOrReadCache.data;var _ref3=data||{},verifiers=_ref3.verifierServers;console.log('verifiers',JSON.stringify(verifiers));verifiers&&setVerifierMap(verifiers);var _yield$getUnlockedWal=yield(0,_wallet2.getUnlockedWallet)(),caHash=_yield$getUnlockedWal.caInfo.caHash;var chainId=yield _constants.PortkeyConfig.currChainId();var guardiansInfo=yield _controller.NetworkController.getGuardianInfo('',caHash);var cachedVerifierData=Object.values((_yield$getOrReadCache2=(_yield$getOrReadCache3=(yield(0,_handler.getOrReadCachedVerifierData)()).data)==null?void 0:_yield$getOrReadCache3.verifierServers)!=null?_yield$getOrReadCache2:{});var parsedGuardians=guardiansInfo==null?void 0:(_guardiansInfo$guardi=guardiansInfo.guardianList)==null?void 0:(_guardiansInfo$guardi2=_guardiansInfo$guardi.guardians)==null?void 0:_guardiansInfo$guardi2.map(function(guardian){return(0,_global.parseGuardianInfo)(guardian,chainId,cachedVerifierData,undefined,undefined,_core.AccountOriginalType.Email,_verifier2.OperationTypeEnum.editGuardian);});console.log('guardians:',JSON.stringify(parsedGuardians));parsedGuardians&&setUserGuardiansList(parsedGuardians);}catch(e){console.log('error',e);}_Loading.default.hide();}));(0,_react.useEffect)(function(){if(editGuardian){var typeEnum=(0,_global.guardianTypeStrToEnum)(editGuardian.sendVerifyCodeParams.type);setSelectedType(_verifier.LOGIN_TYPE_LIST.find(function(item){return item.value===typeEnum;}));if([_wallet.LoginType.Apple,_wallet.LoginType.Google].includes(typeEnum)){setAccount(editGuardian.thirdPartyEmail);}else{setAccount(editGuardian.sendVerifyCodeParams.guardianIdentifier);}!selectedVerifier&&setSelectedVerifier(verifierList.find(function(item){return item.id===editGuardian.sendVerifyCodeParams.verifierId;}));}},[editGuardian,selectedVerifier,verifierList]);var onChooseVerifier=(0,_react.useCallback)(function(item){setGuardianError(Object.assign({},_common.INIT_NONE_ERROR));setSelectedVerifier(item);},[]);var checkCurGuardianRepeat=(0,_react.useCallback)(function(){if(!selectedType){return Object.assign({},_common.INIT_HAS_ERROR);}if([_wallet.LoginType.Email,_wallet.LoginType.Phone].includes(selectedType.value)){if((userGuardiansList==null?void 0:userGuardiansList.findIndex(function(guardian){return(0,_global.guardianTypeStrToEnum)(guardian.sendVerifyCodeParams.type)===(selectedType==null?void 0:selectedType.value)&&guardian.sendVerifyCodeParams.guardianIdentifier===account&&guardian.sendVerifyCodeParams.verifierId===(selectedVerifier==null?void 0:selectedVerifier.id);}))!==-1){return Object.assign({},_common.INIT_HAS_ERROR,{errorMsg:t('This guardian already exists')});}else{return Object.assign({},_common.INIT_NONE_ERROR);}}if([_wallet.LoginType.Apple,_wallet.LoginType.Google].includes(selectedType.value)){var _thirdPartyInfoRef$cu;var guardianAccount=(_thirdPartyInfoRef$cu=thirdPartyInfoRef.current)==null?void 0:_thirdPartyInfoRef$cu.id;if((userGuardiansList==null?void 0:userGuardiansList.findIndex(function(guardian){return(0,_global.guardianTypeStrToEnum)(guardian.sendVerifyCodeParams.type)===(selectedType==null?void 0:selectedType.value)&&guardian.sendVerifyCodeParams.guardianIdentifier===guardianAccount&&guardian.sendVerifyCodeParams.verifierId===(selectedVerifier==null?void 0:selectedVerifier.id);}))!==-1){return Object.assign({},_common.INIT_HAS_ERROR,{errorMsg:t('This guardian already exists')});}else{return Object.assign({},_common.INIT_NONE_ERROR);}}return Object.assign({},_common.INIT_NONE_ERROR);},[account,selectedType,selectedVerifier==null?void 0:selectedVerifier.id,t,userGuardiansList]);var onApproval=(0,_react.useCallback)(function(){var _editGuardian$account,_editGuardian$account2;var _guardianError=checkCurGuardianRepeat();setGuardianError(_guardianError);if(_guardianError.isError||!editGuardian||!selectedVerifier)return;_Loading.default.show();var thisGuardian=JSON.parse(JSON.stringify(editGuardian));thisGuardian.sendVerifyCodeParams=Object.assign({},thisGuardian.sendVerifyCodeParams,{verifierId:selectedVerifier.id});thisGuardian.name=selectedVerifier.name;thisGuardian.imageUrl=selectedVerifier.imageUrl;var guardianList=userGuardiansList.filter(function(it){return it.sendVerifyCodeParams.verifierId!==editGuardian.sendVerifyCodeParams.verifierId||it.sendVerifyCodeParams.guardianIdentifier!==editGuardian.sendVerifyCodeParams.guardianIdentifier||it.sendVerifyCodeParams.type!==editGuardian.sendVerifyCodeParams.type;});guardianList.push(thisGuardian);(0,_hooks2.handleGuardiansApproval)({particularGuardian:thisGuardian,pastGuardian:editGuardian,guardianVerifyType:_socialRecovery.GuardianVerifyType.MODIFY_GUARDIAN,accountIdentifier:(_editGuardian$account=editGuardian.accountIdentifier)!=null?_editGuardian$account:'',accountOriginalType:(_editGuardian$account2=editGuardian.accountOriginalType)!=null?_editGuardian$account2:_core.AccountOriginalType.Email,guardians:guardianList,failHandler:function failHandler(){_CommonToast.default.fail('Edit guardian fail');}});},[checkCurGuardianRepeat,editGuardian,selectedVerifier,userGuardiansList]);var onRemove=(0,_react.useCallback)((0,_asyncToGenerator2.default)(function*(){var _editGuardian$account3,_editGuardian$account4;if(!editGuardian||!userGuardiansList)return;var isLastLoginAccount=checkIsTheLastLoginGuardian(userGuardiansList,editGuardian);if(isLastLoginAccount){_ActionSheet.default.alert({title2:t('This guardian is the only login account and cannot be removed'),buttons:[{title:t('OK')}]});return;}var isLoginAccount=editGuardian.isLoginGuardian;var result=yield new Promise(function(resolve){_ActionSheet.default.alert({title:isLoginAccount?undefined:'Are you sure you want to remove this guardian?',title2:isLoginAccount?"This guardian is set as a login account. Click \"Confirm\" to unset and remove this guardian":undefined,message:isLoginAccount?undefined:"Removing a guardian requires guardians' approval",buttons:[{title:isLoginAccount?'Cancel':'Close',type:'outline',onPress:function onPress(){resolve(false);}},{title:isLoginAccount?'Confirm':'Send Request',onPress:function onPress(){resolve(true);}}]});});if(!result)return;if(editGuardian.isLoginGuardian){_Loading.default.show();try{var req=yield(0,_handler.callCancelLoginGuardianMethod)(editGuardian);if(req&&!req.error){onFinish({status:'success'});}else{var _req$error;_CommonToast.default.fail((req==null?void 0:(_req$error=req.error)==null?void 0:_req$error.message)||'');}return;}catch(error){_CommonToast.default.failError(error);return;}finally{_Loading.default.hide();}}(0,_hooks2.handleGuardiansApproval)({guardianVerifyType:_socialRecovery.GuardianVerifyType.REMOVE_GUARDIAN,particularGuardian:editGuardian,accountIdentifier:(_editGuardian$account3=editGuardian.accountIdentifier)!=null?_editGuardian$account3:'',accountOriginalType:(_editGuardian$account4=editGuardian.accountOriginalType)!=null?_editGuardian$account4:_core.AccountOriginalType.Email,guardians:userGuardiansList.map(function(it){it.sendVerifyCodeParams.operationType=_verifier2.OperationTypeEnum.deleteGuardian;return it;}),failHandler:function failHandler(){_CommonToast.default.fail('Remove guardian fail');}});}),[editGuardian,onFinish,t,userGuardiansList]);var isApprovalDisable=(0,_react.useMemo)(function(){var _editGuardian$sendVer;return(selectedVerifier==null?void 0:selectedVerifier.id)===(editGuardian==null?void 0:(_editGuardian$sendVer=editGuardian.sendVerifyCodeParams)==null?void 0:_editGuardian$sendVer.verifierId);},[editGuardian,selectedVerifier]);var renderGuardianAccount=(0,_react.useCallback)(function(){return _react.default.createElement(_reactNative.View,{style:_style.pageStyles.accountWrap,__self:_this,__source:{fileName:_jsxFileName,lineNumber:272,columnNumber:7}},_react.default.createElement(_CommonText.TextM,{style:_style.pageStyles.accountLabel,__self:_this,__source:{fileName:_jsxFileName,lineNumber:273,columnNumber:9}},"Guardian Info"),guardianItem&&_react.default.createElement(_GuardianAccountItem.default,{guardian:guardianItem,__self:_this,__source:{fileName:_jsxFileName,lineNumber:274,columnNumber:26}}));},[guardianItem]);return _react.default.createElement(_PageContainer.default,{safeAreaColor:['blue','gray'],titleDom:t('Edit Guardians'),leftCallback:function leftCallback(){onFinish({status:'cancel'});},containerStyles:_style.pageStyles.pageWrap,scrollViewProps:{disabled:true},__self:_this,__source:{fileName:_jsxFileName,lineNumber:280,columnNumber:5}},_react.default.createElement(_reactNative.View,{style:_style.pageStyles.contentWrap,__self:_this,__source:{fileName:_jsxFileName,lineNumber:290,columnNumber:7}},renderGuardianAccount(),_react.default.createElement(_CommonText.TextM,{style:_style.pageStyles.titleLabel,__self:_this,__source:{fileName:_jsxFileName,lineNumber:292,columnNumber:9}},t('Verifier')),_react.default.createElement(_ListItem.default,{onPress:function onPress(){_VerifierSelectOverlay.default.showList({id:selectedVerifier==null?void 0:selectedVerifier.id,labelAttrName:'name',list:verifierList,callBack:onChooseVerifier});},titleLeftElement:selectedVerifier&&_react.default.createElement(_VerifierImage.VerifierImage,{style:_style.pageStyles.verifierImageStyle,size:(0,_unit.pTd)(30),label:selectedVerifier.name,uri:selectedVerifier.imageUrl,__self:_this,__source:{fileName:_jsxFileName,lineNumber:304,columnNumber:15}}),titleStyle:[_GStyles.default.flexRowWrap,_GStyles.default.itemCenter],titleTextStyle:[_style.pageStyles.titleTextStyle,!selectedVerifier&&_styles.FontStyles.font7],style:_style.pageStyles.verifierWrap,title:(selectedVerifier==null?void 0:selectedVerifier.name)||t('Select guardian verifiers'),rightElement:_react.default.createElement(_Svg.default,{size:(0,_unit.pTd)(20),icon:"down-arrow",__self:_this,__source:{fileName:_jsxFileName,lineNumber:316,columnNumber:25}}),__self:_this,__source:{fileName:_jsxFileName,lineNumber:293,columnNumber:9}}),guardianError.isError&&_react.default.createElement(_CommonText.TextS,{style:_style.pageStyles.errorTips,__self:_this,__source:{fileName:_jsxFileName,lineNumber:318,columnNumber:35}},guardianError.errorMsg||'')),_react.default.createElement(_reactNative.View,{__self:_this,__source:{fileName:_jsxFileName,lineNumber:321,columnNumber:7}},_react.default.createElement(_react.default.Fragment,null,_react.default.createElement(_CommonButton.default,{disabled:isApprovalDisable,type:"primary",onPress:onApproval,__self:_this,__source:{fileName:_jsxFileName,lineNumber:323,columnNumber:11}},t('Send Request')),_react.default.createElement(_CommonButton.default,{style:_style.pageStyles.removeBtnWrap,type:"clear",onPress:onRemove,titleStyle:_styles.FontStyles.font12,__self:_this,__source:{fileName:_jsxFileName,lineNumber:326,columnNumber:11}},t('Remove')))));};var checkIsTheLastLoginGuardian=exports.checkIsTheLastLoginGuardian=function checkIsTheLastLoginGuardian(guardianList,thisGuardian){if(!thisGuardian.isLoginGuardian){return false;}return!guardianList.filter(function(it){return it.sendVerifyCodeParams.verifierId!==thisGuardian.sendVerifyCodeParams.verifierId||it.sendVerifyCodeParams.guardianIdentifier!==thisGuardian.sendVerifyCodeParams.guardianIdentifier||it.sendVerifyCodeParams.type!==thisGuardian.sendVerifyCodeParams.type;}).find(function(it){return it.isLoginGuardian;});};var _default=exports.default=ModifyGuardian;