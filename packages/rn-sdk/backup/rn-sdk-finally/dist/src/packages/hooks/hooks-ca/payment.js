var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.useSellTransfer=exports.usePayment=exports.useGetAchTokenInfo=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _index=require("./index");var _util=require("../../api/api-did/payment/util");var _react=require("react");var _guardian=require("./guardian");var _wallet=require("../../types/types-ca/wallet");var _network=require("./network");var _payment=require("../../constants/constants-ca/payment");var _socketSell=_interopRequireDefault(require("../../socket/socket-sell"));var _apiDid=require("../../api/api-did");var _utils=require("../../utils");var usePayment=exports.usePayment=function usePayment(){return(0,_index.useAppCASelector)(function(state){return state.payment;});};var useGetAchTokenInfo=exports.useGetAchTokenInfo=function useGetAchTokenInfo(){var _useGuardiansInfo=(0,_guardian.useGuardiansInfo)(),userGuardiansList=_useGuardiansInfo.userGuardiansList;return(0,_react.useCallback)((0,_asyncToGenerator2.default)(function*(){if(userGuardiansList===undefined){throw new Error('userGuardiansList is undefined');}var emailGuardian=userGuardiansList==null?void 0:userGuardiansList.find(function(item){return item.guardianType===_wallet.LoginType.Email&&item.isLoginAccount;});if(emailGuardian===undefined){return undefined;}var rst=yield(0,_util.getAchToken)({email:emailGuardian.guardianAccount});var achTokenInfo={token:rst.accessToken,expires:Date.now()+24*60*60*1000};return achTokenInfo;}),[userGuardiansList]);};var STAGE=function(STAGE){STAGE[STAGE["ACHTXADS"]=0]="ACHTXADS";STAGE[STAGE["TRANSACTION"]=1]="TRANSACTION";STAGE[STAGE["ORDER"]=2]="ORDER";return STAGE;}(STAGE||{});var useSellTransfer=exports.useSellTransfer=function useSellTransfer(){var isMainnet=(0,_network.useIsMainnet)();var status=(0,_react.useRef)(STAGE.ACHTXADS);return(0,_react.useCallback)(function(){var _ref3=(0,_asyncToGenerator2.default)(function*(_ref2){var merchantName=_ref2.merchantName,orderId=_ref2.orderId,paymentSellTransfer=_ref2.paymentSellTransfer;if(!isMainnet||merchantName!==_payment.ACH_MERCHANT_NAME)return;var signalrAchTxRemove;var signalrOrderRemove;var timer=undefined;var clientId=(0,_utils.randomId)();try{yield _socketSell.default.doOpen({url:_apiDid.request.defaultConfig.baseURL+"/ca",clientId:clientId});}catch(error){throw new Error('Transaction failed.');}var timerPromise=new Promise(function(resolve){timer=setTimeout(function(){resolve('timeout');},_payment.SELL_SOCKET_TIMEOUT);});var signalrSellPromise=new Promise(function(resolve){var _signalrSell$onAchTxA=_socketSell.default.onAchTxAddressReceived({clientId:clientId,orderId:orderId},function(){var _ref4=(0,_asyncToGenerator2.default)(function*(data){if(data===null){throw new Error('Transaction failed.');}try{status.current=STAGE.TRANSACTION;var result=yield paymentSellTransfer(data);yield _apiDid.request.payment.sendSellTransaction({params:{merchantName:_payment.ACH_MERCHANT_NAME,orderId:orderId,rawTransaction:result.rawTransaction,signature:result.signature,publicKey:result.publicKey}});}catch(e){resolve(null);return;}var _signalrSell$onReques=_socketSell.default.onRequestOrderTransferred({clientId:clientId,orderId:orderId},function(){var _ref5=(0,_asyncToGenerator2.default)(function*(data){status.current=STAGE.ORDER;resolve(data);});return function(_x3){return _ref5.apply(this,arguments);};}()),removeRes=_signalrSell$onReques.remove;signalrOrderRemove=removeRes;_socketSell.default.requestOrderTransferred(clientId,orderId);});return function(_x2){return _ref4.apply(this,arguments);};}()),removeAchTx=_signalrSell$onAchTxA.remove;signalrAchTxRemove=removeAchTx;_socketSell.default.requestAchTxAddress(clientId,orderId);});var signalrSellResult=yield Promise.race([timerPromise,signalrSellPromise]);if(signalrSellResult===null)throw new Error('Transaction failed.');if(signalrSellResult==='timeout'){if(status.current===STAGE.ACHTXADS)throw new Error('Transaction failed.');throw{code:'TIMEOUT',message:'The waiting time is too long, it will be put on hold in the background.'};}if(signalrSellResult.status!=='Transferred')throw new Error('Transaction failed.');signalrAchTxRemove==null?void 0:signalrAchTxRemove();signalrAchTxRemove=undefined;signalrOrderRemove==null?void 0:signalrOrderRemove();signalrOrderRemove=undefined;if(timer){clearTimeout(timer);timer=undefined;}_socketSell.default.stop();});return function(_x){return _ref3.apply(this,arguments);};}(),[isMainnet]);};