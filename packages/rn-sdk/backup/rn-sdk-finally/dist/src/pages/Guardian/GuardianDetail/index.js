var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=GuardianDetail;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _CommonButton=_interopRequireDefault(require("../../../components/CommonButton"));var _CommonText=require("../../../components/CommonText");var _react=_interopRequireWildcard(require("react"));var _reactNative=require("react-native");var _unit=require("../../../utils/unit");var _PageContainer=_interopRequireDefault(require("../../../components/PageContainer"));var _style=require("./style");var _hooks=require("../../../i18n/hooks");var _CommonSwitch=_interopRequireDefault(require("../../../components/CommonSwitch"));var _ActionSheet=_interopRequireDefault(require("../../../components/ActionSheet"));var _Loading=_interopRequireDefault(require("../../../components/Loading"));var _CommonToast=_interopRequireDefault(require("../../../components/CommonToast"));var _verifier=require("../../../packages/types/verifier");var _VerifierImage=require("../components/VerifierImage");var _guardian=require("../../../utils/guardian");var _wallet=require("../../../packages/types/types-ca/wallet");var _fonts=_interopRequireDefault(require("../../../assets/theme/fonts"));var _GuardianAccountItem=_interopRequireDefault(require("../components/GuardianAccountItem"));var _Divider=_interopRequireDefault(require("../../../components/Divider"));var _authentication=require("../../../model/hooks/authentication");var _constants=require("../../../global/constants");var _useEffectOnce=_interopRequireDefault(require("../../../hooks/useEffectOnce"));var _handler=require("../../../model/contract/handler");var _global=require("../../../model/global");var _core=require("../../../model/verify/core");var _wallet2=require("../../../model/wallet");var _controller=require("../../../network/controller");var _ModifyGuardian=require("../GuardianManage/ModifyGuardian");var _hooks2=require("../../../model/verify/entry/hooks");var _UseBaseContainer=_interopRequireDefault(require("../../../model/container/UseBaseContainer"));var _entries=require("../../../config/entries");var _VerifyHumanMachine=require("../../../components/VerifyHumanMachine");var _jsxFileName="/Users/fengfeiyang/aelf/portkey-wallet/packages/rn-sdk/android/rn-sdk-finally/src/pages/Guardian/GuardianDetail/index.tsx";function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap(),t=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r;})(e);}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&Object.prototype.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u];}return n.default=e,t&&t.set(e,n),n;}function GuardianDetail(config){var _this=this,_guardian$verifier4,_guardian$verifier5,_guardian$verifier6;var _useLanguage=(0,_hooks.useLanguage)(),t=_useLanguage.t;var _useState=(0,_react.useState)(),_useState2=(0,_slicedToArray2.default)(_useState,2),editGuardian=_useState2[0],setEditGuardian=_useState2[1];var _useState3=(0,_react.useState)(),_useState4=(0,_slicedToArray2.default)(_useState3,2),guardian=_useState4[0],setOriginalGuardianItem=_useState4[1];var _useState5=(0,_react.useState)([]),_useState6=(0,_slicedToArray2.default)(_useState5,2),userGuardiansList=_useState6[0],setUserGuardiansList=_useState6[1];var _useAppleAuthenticati=(0,_authentication.useAppleAuthentication)(),appleSign=_useAppleAuthenticati.appleSign;var _useGoogleAuthenticat=(0,_authentication.useGoogleAuthentication)(),googleSign=_useGoogleAuthenticat.googleSign;var _useBaseContainer=(0,_UseBaseContainer.default)({entryName:_entries.PortkeyEntries.GUARDIAN_DETAIL_ENTRY}),navigationTo=_useBaseContainer.navigateTo,onFinish=_useBaseContainer.onFinish;var changeLoginAccountStatus=(0,_react.useCallback)(function(newStatus){if(guardian){setOriginalGuardianItem(Object.assign({},guardian,{isLoginAccount:newStatus}));}if(editGuardian){setEditGuardian(Object.assign({},editGuardian,{isLoginGuardian:newStatus}));}},[editGuardian,guardian]);(0,_useEffectOnce.default)((0,_asyncToGenerator2.default)(function*(){var _yield$getOrReadCache,_yield$getOrReadCache2,_guardiansInfo$guardi,_guardiansInfo$guardi2;_Loading.default.show();var _ref2=JSON.parse(config.info),particularGuardianInfo=_ref2.particularGuardianInfo,originalGuardianItem=_ref2.originalGuardianItem;console.log('GuardianDetail info: ',config.info);particularGuardianInfo&&setEditGuardian(particularGuardianInfo);originalGuardianItem&&setOriginalGuardianItem(originalGuardianItem);var _yield$getUnlockedWal=yield(0,_wallet2.getUnlockedWallet)(),caHash=_yield$getUnlockedWal.caInfo.caHash;var chainId=yield _constants.PortkeyConfig.currChainId();var guardiansInfo=yield _controller.NetworkController.getGuardianInfo('',caHash);var cachedVerifierData=Object.values((_yield$getOrReadCache=(_yield$getOrReadCache2=(yield(0,_handler.getOrReadCachedVerifierData)()).data)==null?void 0:_yield$getOrReadCache2.verifierServers)!=null?_yield$getOrReadCache:{});var parsedGuardians=guardiansInfo==null?void 0:(_guardiansInfo$guardi=guardiansInfo.guardianList)==null?void 0:(_guardiansInfo$guardi2=_guardiansInfo$guardi.guardians)==null?void 0:_guardiansInfo$guardi2.map(function(it){return(0,_global.parseGuardianInfo)(it,chainId,cachedVerifierData,undefined,undefined,_core.AccountOriginalType.Email,_verifier.OperationTypeEnum.editGuardian);});console.log('guardians:',JSON.stringify(parsedGuardians));parsedGuardians&&setUserGuardiansList(parsedGuardians);_Loading.default.hide();}));var onCancelLoginAccount=(0,_react.useCallback)((0,_asyncToGenerator2.default)(function*(){if(!guardian)return;_Loading.default.show();try{var _userGuardiansList$fi;_Loading.default.show();var _yield$getUnlockedWal2=yield(0,_wallet2.getUnlockedWallet)(),managerAddress=_yield$getUnlockedWal2.address,caHash=_yield$getUnlockedWal2.caInfo.caHash;var identifierHash=userGuardiansList==null?void 0:(_userGuardiansList$fi=userGuardiansList.find(function(item){return item.sendVerifyCodeParams.guardianIdentifier===guardian.guardianAccount;}))==null?void 0:_userGuardiansList$fi.identifierHash;if(identifierHash)guardian.identifierHash=identifierHash;console.log('identifierHash',userGuardiansList);var caContract=yield(0,_handler.getContractInstance)();var req=yield(0,_guardian.cancelLoginAccount)(caContract,managerAddress,caHash,guardian);if(req&&!req.error){changeLoginAccountStatus(false);_CommonToast.default.success('Cancel login account successfully');}else{var _req$error;_CommonToast.default.fail((req==null?void 0:(_req$error=req.error)==null?void 0:_req$error.message)||'');}_Loading.default.hide();}catch(error){_CommonToast.default.failError(error);}_Loading.default.hide();}),[changeLoginAccountStatus,guardian,userGuardiansList]);var onSetLoginAccount=(0,_react.useCallback)((0,_asyncToGenerator2.default)(function*(){try{var _userGuardiansList$fi2;if(!guardian)return;_Loading.default.show();var _yield$getUnlockedWal3=yield(0,_wallet2.getUnlockedWallet)(),managerAddress=_yield$getUnlockedWal3.address,caHash=_yield$getUnlockedWal3.caInfo.caHash;var identifierHash=userGuardiansList==null?void 0:(_userGuardiansList$fi2=userGuardiansList.find(function(item){return item.sendVerifyCodeParams.guardianIdentifier===guardian.guardianAccount;}))==null?void 0:_userGuardiansList$fi2.identifierHash;if(identifierHash)guardian.identifierHash=identifierHash;var caContract=yield(0,_handler.getContractInstance)();var req=yield(0,_guardian.setLoginAccount)(caContract,managerAddress,caHash,guardian);if(req&&!req.error){changeLoginAccountStatus(true);_CommonToast.default.success('Set login account successfully');}else{var _req$error2;_CommonToast.default.fail((req==null?void 0:(_req$error2=req.error)==null?void 0:_req$error2.message)||'');}_Loading.default.hide();}catch(error){_CommonToast.default.failError(error);}}),[changeLoginAccountStatus,guardian,userGuardiansList]);var sendLoginAccountVerify=(0,_react.useCallback)((0,_asyncToGenerator2.default)(function*(){if(!guardian)return;try{var _guardian$verifier;var originChainId=yield _constants.PortkeyConfig.currChainId();_Loading.default.show();var needRecaptcha=yield(0,_global.isReacptchaOpen)(_verifier.OperationTypeEnum.setLoginAccount);var token;if(needRecaptcha){token=yield(0,_VerifyHumanMachine.verifyHumanMachine)('en');}var req=yield _controller.NetworkController.sendVerifyCode({type:(0,_global.guardianEnumToTypeStr)(guardian.guardianType),guardianIdentifier:guardian.guardianAccount||'',verifierId:((_guardian$verifier=guardian.verifier)==null?void 0:_guardian$verifier.id)||'',chainId:originChainId,operationType:_verifier.OperationTypeEnum.setLoginAccount},{reCaptchaToken:token});if(req.verifierSessionId){var guardianVerifyResult=yield(0,_hooks2.handlePhoneOrEmailGuardianVerify)({verificationType:_verifier.VerificationType.addGuardian,accountIdentifier:guardian.guardianAccount,accountOriginalType:_core.AccountOriginalType.Email,deliveredGuardianInfo:JSON.stringify(Object.assign({},editGuardian,{alreadySent:true,verifySessionId:req.verifierSessionId})),operationType:_verifier.OperationTypeEnum.setLoginAccount});if(!(guardianVerifyResult!=null&&guardianVerifyResult.verifiedData))throw new Error('verify fail');yield onSetLoginAccount();}else{console.log('send fail');}}catch(error){_CommonToast.default.failError(error);}_Loading.default.hide();}),[editGuardian,guardian,onSetLoginAccount]);var onLoginAccountChange=(0,_react.useCallback)(function(){var _ref6=(0,_asyncToGenerator2.default)(function*(value){var _guardian$verifier3;if(!guardian||!editGuardian||userGuardiansList===undefined)return;if(!value){var isLastLoginAccount=(0,_ModifyGuardian.checkIsTheLastLoginGuardian)(userGuardiansList,editGuardian);if(isLastLoginAccount){_ActionSheet.default.alert({title2:t('This guardian is the only login account and cannot be turned off'),buttons:[{title:t('Close')}]});return;}onCancelLoginAccount();return;}var loginIndex=userGuardiansList.findIndex(function(item){var _guardian$verifier2;return item.isLoginGuardian&&(0,_global.guardianTypeStrToEnum)(item.sendVerifyCodeParams.type)===guardian.guardianType&&item.sendVerifyCodeParams.guardianIdentifier===guardian.guardianAccount&&item.sendVerifyCodeParams.verifierId!==((_guardian$verifier2=guardian.verifier)==null?void 0:_guardian$verifier2.id);});if(loginIndex===-1){_Loading.default.show();try{var _guardiansInfo$guardi3,_guardiansInfo$guardi4;var guardiansInfo=yield _controller.NetworkController.getGuardianInfo(guardian.guardianAccount);console.log('guardiansInfo check:',guardiansInfo);if(guardiansInfo!=null&&(_guardiansInfo$guardi3=guardiansInfo.guardianList)!=null&&(_guardiansInfo$guardi4=_guardiansInfo$guardi3.guardians)!=null&&_guardiansInfo$guardi4.length){throw{code:'20004'};}}catch(error){if(error.code==='20004'){_Loading.default.hide();_ActionSheet.default.alert({title2:t("This account address is already a login account and cannot be used"),buttons:[{title:t('Close')}]});return;}}finally{_Loading.default.hide();}}if([_wallet.LoginType.Apple,_wallet.LoginType.Google].includes(guardian.guardianType)){_Loading.default.show();try{var userInfo=yield(guardian.guardianType===_wallet.LoginType.Apple?appleSign:googleSign)();if(userInfo.user.id!==guardian.guardianAccount)throw new Error('Account does not match your guardian');_CommonToast.default.success('Verified Successfully');yield onSetLoginAccount();}catch(error){_CommonToast.default.failError(error);}_Loading.default.hide();return;}_ActionSheet.default.alert({title2:_react.default.createElement(_reactNative.Text,{__self:_this,__source:{fileName:_jsxFileName,lineNumber:260,columnNumber:11}},_react.default.createElement(_CommonText.TextL,{__self:_this,__source:{fileName:_jsxFileName,lineNumber:261,columnNumber:13}},((_guardian$verifier3=guardian.verifier)==null?void 0:_guardian$verifier3.name)+" will send a verification code to "),_react.default.createElement(_CommonText.TextL,{style:_fonts.default.mediumFont,__self:_this,__source:{fileName:_jsxFileName,lineNumber:262,columnNumber:13}},guardian.guardianAccount),_react.default.createElement(_CommonText.TextL,{__self:_this,__source:{fileName:_jsxFileName,lineNumber:263,columnNumber:13}}," to verify your "+(guardian.guardianType===_wallet.LoginType.Phone?'phone number':'email address')+".")),buttons:[{title:t('Cancel'),type:'outline'},{title:t('Confirm'),onPress:sendLoginAccountVerify}]});});return function(_x){return _ref6.apply(this,arguments);};}(),[appleSign,editGuardian,googleSign,guardian,onCancelLoginAccount,onSetLoginAccount,sendLoginAccountVerify,t,userGuardiansList]);return _react.default.createElement(_PageContainer.default,{safeAreaColor:['blue','gray'],titleDom:t('Guardians'),leftCallback:function leftCallback(){onFinish({status:'cancel'});},containerStyles:_style.pageStyles.pageWrap,scrollViewProps:{disabled:true},__self:this,__source:{fileName:_jsxFileName,lineNumber:294,columnNumber:5}},_react.default.createElement(_reactNative.View,{style:_style.pageStyles.contentWrap,__self:this,__source:{fileName:_jsxFileName,lineNumber:304,columnNumber:7}},_react.default.createElement(_reactNative.View,{style:_style.pageStyles.guardianInfoWrap,__self:this,__source:{fileName:_jsxFileName,lineNumber:305,columnNumber:9}},_react.default.createElement(_GuardianAccountItem.default,{guardian:guardian,__self:this,__source:{fileName:_jsxFileName,lineNumber:306,columnNumber:11}}),_react.default.createElement(_Divider.default,{style:_style.pageStyles.dividerStyle,__self:this,__source:{fileName:_jsxFileName,lineNumber:307,columnNumber:11}}),_react.default.createElement(_reactNative.View,{style:_style.pageStyles.verifierInfoWrap,__self:this,__source:{fileName:_jsxFileName,lineNumber:308,columnNumber:11}},_react.default.createElement(_VerifierImage.VerifierImage,{style:_style.pageStyles.verifierImageStyle,size:(0,_unit.pTd)(28),label:guardian==null?void 0:(_guardian$verifier4=guardian.verifier)==null?void 0:_guardian$verifier4.name,uri:guardian==null?void 0:(_guardian$verifier5=guardian.verifier)==null?void 0:_guardian$verifier5.imageUrl,__self:this,__source:{fileName:_jsxFileName,lineNumber:309,columnNumber:13}}),_react.default.createElement(_CommonText.TextL,{__self:this,__source:{fileName:_jsxFileName,lineNumber:315,columnNumber:13}},(guardian==null?void 0:(_guardian$verifier6=guardian.verifier)==null?void 0:_guardian$verifier6.name)||''))),_react.default.createElement(_reactNative.View,{style:_style.pageStyles.loginSwitchWrap,__self:this,__source:{fileName:_jsxFileName,lineNumber:319,columnNumber:9}},_react.default.createElement(_CommonText.TextM,{__self:this,__source:{fileName:_jsxFileName,lineNumber:320,columnNumber:11}},t('Login account')),_react.default.createElement(_CommonSwitch.default,{value:guardian===undefined?false:guardian.isLoginAccount,onValueChange:onLoginAccountChange,__self:this,__source:{fileName:_jsxFileName,lineNumber:321,columnNumber:11}})),_react.default.createElement(_CommonText.TextM,{style:_style.pageStyles.tips,__self:this,__source:{fileName:_jsxFileName,lineNumber:327,columnNumber:9}},t('The login account will be able to log in and control all your assets'))),userGuardiansList&&userGuardiansList.length>1&&_react.default.createElement(_CommonButton.default,{type:"primary",onPress:function onPress(){navigationTo(_entries.PortkeyEntries.MODIFY_GUARDIAN_ENTRY,{closeCurrentScreen:false,params:{info:JSON.stringify({particularGuardianInfo:editGuardian,originalGuardianItem:guardian})}});},__self:this,__source:{fileName:_jsxFileName,lineNumber:332,columnNumber:9}},t('Edit')));}