var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=QRCode;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _react=_interopRequireWildcard(require("react"));var _reactNative=require("react-native");var _styles=require("../../../assets/theme/styles");var _deviceEvent=_interopRequireDefault(require("../../../utils/deviceEvent"));var _styles2=_interopRequireDefault(require("../styles"));var _Touchable=_interopRequireDefault(require("../../../components/Touchable"));var _GStyles=_interopRequireDefault(require("../../../assets/theme/GStyles"));var _CommonText=require("../../../components/CommonText");var _types=require("../types");var _useIntervalQueryCAInfoByAddress=require("../../../hooks/useIntervalQueryCAInfoByAddress");var _device=require("../../../hooks/device");var _device2=require("../../../packages/constants/constants-ca/device");var _CommonQRCodeStyled=_interopRequireDefault(require("../../../components/CommonQRCodeStyled"));var _expoScreenCapture=require("expo-screen-capture");var _NetworkContext=_interopRequireDefault(require("../context/NetworkContext"));var _UseBaseContainer=_interopRequireDefault(require("../../../model/container/UseBaseContainer"));var _entries=require("../../../config/entries");var _wallet=require("../../../network/dto/wallet");var _device3=require("../../../packages/utils/mobile/device");var _jsxFileName="/Users/fengfeiyang/aelf/portkey-wallet/packages/rn-sdk/android/rn-sdk-finally/src/pages/Login/components/QRCode.tsx";function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap(),t=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r;})(e);}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&Object.prototype.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u];}return n.default=e,t&&t.set(e,n),n;}var DEFAULT_WALLET={chainType:'aelf',type:'login',address:'2Aj8aTMsmgp1YyrVeCvB2dp9DbrLz5zgmAVmKNXsLnxhqzA69L',netWorkType:'TESTNET',extraData:{deviceInfo:{deviceType:2,deviceName:'iOS'},version:'1.0.0'}};function QRCode(_ref){var _networkContext$curre3;var setLoginType=_ref.setLoginType;var _useState=(0,_react.useState)(),_useState2=(0,_slicedToArray2.default)(_useState,2),newWallet=_useState2[0],setNewWallet=_useState2[1];var networkContext=(0,_react.useContext)(_NetworkContext.default);var currentNetwork=(0,_react.useMemo)(function(){var _networkContext$curre,_networkContext$curre2;return(_networkContext$curre=(_networkContext$curre2=networkContext.currentNetwork)==null?void 0:_networkContext$curre2.networkType)!=null?_networkContext$curre:'MAIN';},[(_networkContext$curre3=networkContext.currentNetwork)==null?void 0:_networkContext$curre3.networkType]);var _useBaseContainer=(0,_UseBaseContainer.default)({}),navigateForResult=_useBaseContainer.navigateForResult,onFinish=_useBaseContainer.onFinish;var caWalletInfo=(0,_useIntervalQueryCAInfoByAddress.useIntervalQueryCAInfoByAddress)(currentNetwork,newWallet==null?void 0:newWallet.address);(0,_expoScreenCapture.usePreventScreenCapture)('LoginQRCode');var dealWithSetPin=(0,_react.useCallback)(function(afterVerifiedData){navigateForResult(_entries.PortkeyEntries.SET_PIN,{params:{deliveredSetPinInfo:typeof afterVerifiedData==='string'?afterVerifiedData:JSON.stringify(afterVerifiedData)}},function(res){var data=res.data;if(data&&data.finished){onFinish({status:'success',data:{finished:true}});}});},[navigateForResult,onFinish]);(0,_react.useEffect)(function(){var _ref2=caWalletInfo||{},caInfo=_ref2.caInfo,originChainId=_ref2.originChainId;if(caInfo&&newWallet&&originChainId){var _caInfo$originChainId;var _ref3=caInfo[(_caInfo$originChainId=caInfo.originChainId)!=null?_caInfo$originChainId:'AELF']||{},caAddress=_ref3.caAddress,caHash=_ref3.caHash;if(!caAddress||!caHash){throw new Error('caAddress or caHash is empty');}dealWithSetPin({scanQRCodePathInfo:{caHash:caHash,caAddress:caAddress,walletInfo:newWallet,originalChainId:originChainId}});}},[caWalletInfo,dealWithSetPin,newWallet]);var generateWallet=(0,_react.useCallback)(function(){try{console.log('before createNewWallet');var wallet=_wallet.AElfWeb3SDK.createNewWallet();var privateKey=wallet.privateKey,address=wallet.address;var publicKey=wallet.keyPair.getPublic('hex');setNewWallet({privateKey:privateKey,publicKey:publicKey,address:address});}catch(error){console.error(error);}},[]);var getDeviceInfo=(0,_device.useGetDeviceInfo)();(0,_react.useEffect)(function(){var timer=setTimeout(function(){generateWallet();},10);var timer2;var listener=_deviceEvent.default.clearQRWallet.addListener(function(){timer2=setTimeout(function(){setNewWallet(undefined);timer2&&clearTimeout(timer2);timer2=setTimeout(function(){generateWallet();},200);},500);});return function(){timer&&clearTimeout(timer);timer2&&clearTimeout(timer2);listener.remove();};},[generateWallet,networkContext.currentNetwork]);var qrData=(0,_react.useMemo)(function(){return newWallet?{chainType:'aelf',type:'login',address:newWallet.address,netWorkType:currentNetwork,id:Math.floor(Date.now()/1000),extraData:{deviceInfo:getDeviceInfo(),version:_device2.DEVICE_INFO_VERSION}}:DEFAULT_WALLET;},[getDeviceInfo,newWallet,currentNetwork]);var qrDataStr=(0,_react.useMemo)(function(){return JSON.stringify(qrData);},[qrData]);var phoneImage=(0,_react.useMemo)(function(){if(_device3.isIOS){return{uri:'phone'};}else{return require("../../../assets/image/pngs/phone.png");}},[]);return _react.default.createElement(_reactNative.View,{style:[_styles.BGStyles.bg1,_styles2.default.card,_styles2.default.qrCodeCard],__self:this,__source:{fileName:_jsxFileName,lineNumber:159,columnNumber:5}},_react.default.createElement(_Touchable.default,{style:_styles2.default.iconBox,onPress:function onPress(){return setLoginType(_types.PageLoginType.referral);},__self:this,__source:{fileName:_jsxFileName,lineNumber:160,columnNumber:7}},_react.default.createElement(_reactNative.Image,{source:phoneImage,style:_styles2.default.iconStyle,__self:this,__source:{fileName:_jsxFileName,lineNumber:161,columnNumber:9}})),_react.default.createElement(_reactNative.View,{style:[_GStyles.default.flex1],__self:this,__source:{fileName:_jsxFileName,lineNumber:163,columnNumber:7}},_react.default.createElement(_CommonText.TextXXXL,{style:[_styles2.default.qrCodeTitle,_GStyles.default.textAlignCenter],__self:this,__source:{fileName:_jsxFileName,lineNumber:164,columnNumber:9}},"Scan code to log in"),_react.default.createElement(_CommonText.TextS,{style:[_GStyles.default.textAlignCenter,_styles.FontStyles.font3],__self:this,__source:{fileName:_jsxFileName,lineNumber:165,columnNumber:9}},"Please use the Portkey DApp to scan the QR code"),_react.default.createElement(_reactNative.View,{style:[_GStyles.default.alignCenter,_styles2.default.qrCodeBox,_GStyles.default.flex1],__self:this,__source:{fileName:_jsxFileName,lineNumber:168,columnNumber:9}},_react.default.createElement(_CommonQRCodeStyled.default,{qrData:qrDataStr,hasMask:!newWallet,__self:this,__source:{fileName:_jsxFileName,lineNumber:169,columnNumber:11}}))));}