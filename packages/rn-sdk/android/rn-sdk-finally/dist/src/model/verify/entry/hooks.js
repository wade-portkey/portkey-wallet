var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.navigateToForResult=exports.handlePhoneOrEmailGuardianVerify=exports.handleGuardiansApproval=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _entries=require("../../../config/entries");var _entries2=require("../../../global/init/entries");var _nativeModules=require("../../../service/native-modules");var _socialRecovery=require("../social-recovery");var _controller=require("../../../network/controller");var _global=require("../../global");var _constants=require("../../../global/constants");var _Loading=_interopRequireDefault(require("../../../components/Loading"));var _wallet=require("../../wallet");var _handler=require("../../contract/handler");var navigateToForResult=exports.navigateToForResult=function(){var _ref=(0,_asyncToGenerator2.default)(function*(entryName,props){var from=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'UNKNOWN';return new Promise(function(resolve,_){_nativeModules.PortkeyModulesEntity.RouterModule.navigateToWithOptions(entryName,_entries2.LaunchModeSet.get(entryName)||_entries2.LaunchMode.STANDARD,from,{params:props,closeCurrentScreen:false},function(result){var _result$data;resolve((_result$data=result.data)!=null?_result$data:null);});});});return function navigateToForResult(_x,_x2){return _ref.apply(this,arguments);};}();var returnToParticularBasePage=function(){var _ref2=(0,_asyncToGenerator2.default)(function*(intent){var type=intent.type;switch(type){case _socialRecovery.GuardianVerifyType.CREATE_WALLET:case _socialRecovery.GuardianVerifyType.ADD_GUARDIAN:case _socialRecovery.GuardianVerifyType.MODIFY_GUARDIAN:case _socialRecovery.GuardianVerifyType.REMOVE_GUARDIAN:returnToGuardianHome(intent);break;case _socialRecovery.GuardianVerifyType.EDIT_PAYMENT_SECURITY:returnToPaymentSecurityDetail(intent);break;}});return function returnToParticularBasePage(_x3){return _ref2.apply(this,arguments);};}();var returnToGuardianHome=function(){var _ref3=(0,_asyncToGenerator2.default)(function*(intent){_nativeModules.PortkeyModulesEntity.RouterModule.navigateTo(_entries.PortkeyEntries.GUARDIAN_HOME_ENTRY,_entries2.LaunchMode.SINGLE_TASK,"GuardianVerifyType#"+intent.type,'none',false,intent);});return function returnToGuardianHome(_x4){return _ref3.apply(this,arguments);};}();var returnToPaymentSecurityDetail=function(){var _ref4=(0,_asyncToGenerator2.default)(function*(intent){_nativeModules.PortkeyModulesEntity.RouterModule.navigateBack({status:intent.result,data:intent});});return function returnToPaymentSecurityDetail(_x5){return _ref4.apply(this,arguments);};}();var handlePhoneOrEmailGuardianVerify=exports.handlePhoneOrEmailGuardianVerify=function(){var _ref5=(0,_asyncToGenerator2.default)(function*(config){return navigateToForResult(_entries.PortkeyEntries.VERIFIER_DETAIL_ENTRY,config);});return function handlePhoneOrEmailGuardianVerify(_x6){return _ref5.apply(this,arguments);};}();var handleGuardiansApproval=exports.handleGuardiansApproval=function(){var _ref6=(0,_asyncToGenerator2.default)(function*(config){if(!checkGuardiansApprovalConfig(config)){throw new Error('invalid config, or this guardianVerifyType is not implemented yet.');}_Loading.default.show();var chainId=yield _constants.PortkeyConfig.currChainId();var guardians=config.guardians,particularGuardian=config.particularGuardian,failHandler=config.failHandler,guardianVerifyType=config.guardianVerifyType;try{if(!((guardians==null?void 0:guardians.length)>0)){var _yield$getOrReadCache,_yield$getOrReadCache2,_guardiansInfo$guardi,_guardiansInfo$guardi2;var _yield$getUnlockedWal=yield(0,_wallet.getUnlockedWallet)(),caHash=_yield$getUnlockedWal.caInfo.caHash;var guardiansInfo=yield _controller.NetworkController.getGuardianInfo('',caHash);var cachedVerifierData=Object.values((_yield$getOrReadCache=(_yield$getOrReadCache2=(yield(0,_handler.getOrReadCachedVerifierData)()).data)==null?void 0:_yield$getOrReadCache2.verifierServers)!=null?_yield$getOrReadCache:{});var parsedGuardians=guardiansInfo==null?void 0:(_guardiansInfo$guardi=guardiansInfo.guardianList)==null?void 0:(_guardiansInfo$guardi2=_guardiansInfo$guardi.guardians)==null?void 0:_guardiansInfo$guardi2.map(function(guardian){return(0,_global.parseGuardianInfo)(guardian,chainId,cachedVerifierData);});if((parsedGuardians==null?void 0:parsedGuardians.length)>0)config.guardians=parsedGuardians;}if(guardianVerifyType!==_socialRecovery.GuardianVerifyType.MODIFY_GUARDIAN){var _ref7,_config$guardians;config.guardians=(_ref7=(_config$guardians=config.guardians)!=null?_config$guardians:[])==null?void 0:_ref7.filter(function(it){return!particularGuardian||it.sendVerifyCodeParams.guardianIdentifier!==particularGuardian.sendVerifyCodeParams.guardianIdentifier||it.sendVerifyCodeParams.verifierId!==particularGuardian.sendVerifyCodeParams.verifierId||it.sendVerifyCodeParams.type!==particularGuardian.sendVerifyCodeParams.type;});}}catch(e){console.error(e);}_Loading.default.hide();var option=yield navigateToForResult(_entries.PortkeyEntries.GUARDIAN_APPROVAL_ENTRY,{deliveredGuardianListInfo:JSON.stringify(config)});console.log('handleGuardiansApproval',option);_Loading.default.hide();if(!(option!=null&&option.isVerified)&&failHandler){failHandler();}else{returnToParticularBasePage({type:guardianVerifyType,result:option!=null&&option.isVerified?'success':'fail'});}});return function handleGuardiansApproval(_x7){return _ref6.apply(this,arguments);};}();var checkGuardiansApprovalConfig=function checkGuardiansApprovalConfig(config){var guardianVerifyType=config.guardianVerifyType,particularGuardian=config.particularGuardian,paymentSecurityConfig=config.paymentSecurityConfig;console.log('checkGuardiansApprovalConfig',config);switch(guardianVerifyType){case _socialRecovery.GuardianVerifyType.CREATE_WALLET:{return!particularGuardian;}case _socialRecovery.GuardianVerifyType.ADD_GUARDIAN:case _socialRecovery.GuardianVerifyType.MODIFY_GUARDIAN:case _socialRecovery.GuardianVerifyType.REMOVE_GUARDIAN:{return!!particularGuardian;}case _socialRecovery.GuardianVerifyType.EDIT_PAYMENT_SECURITY:{return!!paymentSecurityConfig;}default:return true;}};