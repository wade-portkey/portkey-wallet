var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _react=require("@testing-library/react");var _graphql=require("./graphql");var _chainList=_interopRequireWildcard(require("./chainList"));var chainListHooks=_chainList;var _=require("./..");var graphqlQuery=_interopRequireWildcard(require("../../graphql"));var _chainInfo=require("test/data/chainInfo");var _wallet=require("./wallet");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap(),t=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r;})(e);}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&Object.prototype.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u];}return n.default=e,t&&t.set(e,n),n;}jest.mock("./chainList");jest.mock("../index");jest.mock("./wallet");jest.mock('packages/types/store-ca/wallet/actions',function(){return{getChainListAsync:jest.fn(function(){return[];})};});jest.mocked(_.useAppCommonDispatch).mockReturnValue(function(){var _ref=(0,_asyncToGenerator2.default)(function*(call){return call;});return function(_x){return _ref.apply(this,arguments);};}());var NETWORK='TESTNET';var ADDRESS='2ZpT...3Udb';var CHAIN_INFO={caContractAddress:'2w13...w4ZF',chainId:'AELF',chainName:'AELF',endPoint:'https://localhost',explorerUrl:'https://localhost',id:'AELF',lastModifyTime:'2023-02-25T07:15:23.6079047Z',defaultToken:{address:'2ZpT...3Udb',decimals:'8',imageUrl:'https://localhost',name:'AELF',symbol:'ELF'}};var CA_HOLDER_MANAGER_INFO=[{__typename:'CAHolderManagerDto',caAddress:'string',caHash:'string',loginGuardianInfo:[{__typename:'LoginGuardianDto',caAddress:'',caHash:'',chainId:'AELF',id:'',loginGuardian:{__typename:'GuardianDto',identifierHash:'',isLoginGuardian:true,salt:'',type:0,verifierId:''},manager:''}],chainId:'AELF'}];describe('useIntervalQueryCAInfoByAddress',function(){beforeEach(function(){jest.restoreAllMocks();jest.clearAllMocks();});test('no address, and return undefined',function(){jest.mocked(_chainList.useCurrentChain).mockReturnValue(CHAIN_INFO);var _renderHook=(0,_react.renderHook)(function(){return(0,_graphql.useIntervalQueryCAInfoByAddress)(NETWORK,'');}),result=_renderHook.result;expect(result.current).toBeUndefined();});test('no chainInfo, and return undefined',function(){jest.mocked(_chainList.useCurrentChain).mockReturnValue(undefined);jest.spyOn(graphqlQuery.contractQueries,'getCAHolderByManager').mockReturnValue(Promise.resolve({caHolderManagerInfo:[]}));var _renderHook2=(0,_react.renderHook)(function(){return(0,_graphql.useIntervalQueryCAInfoByAddress)(NETWORK,ADDRESS);}),result=_renderHook2.result;expect(result.current).toBeUndefined();});test('caHolderManagerInfo.length = 0, and return undefined',function(){var caHolderManagerInfo=[];jest.mocked(_chainList.useCurrentChain).mockReturnValue(CHAIN_INFO);jest.spyOn(graphqlQuery.contractQueries,'getCAHolderByManager').mockReturnValue(Promise.resolve({caHolderManagerInfo:caHolderManagerInfo}));var _renderHook3=(0,_react.renderHook)(function(){return(0,_graphql.useIntervalQueryCAInfoByAddress)(NETWORK,ADDRESS);}),result=_renderHook3.result;expect(result.current).toBeUndefined();});test('caHolderManagerInfo.length = 0, and return undefined',function(){var caHolderManagerInfo=[Object.assign({},CA_HOLDER_MANAGER_INFO[0],{loginGuardianInfo:[{chainId:'tDVV'}]})];jest.mocked(_chainList.useCurrentChain).mockReturnValue(CHAIN_INFO);jest.spyOn(graphqlQuery.contractQueries,'getCAHolderByManager').mockReturnValue(Promise.resolve({caHolderManagerInfo:caHolderManagerInfo}));var _renderHook4=(0,_react.renderHook)(function(){return(0,_graphql.useIntervalQueryCAInfoByAddress)(NETWORK,ADDRESS);}),result=_renderHook4.result;expect(result.current).toBeUndefined();});test('have address, but caHolderManagerInfo missing information, and return undefined',function(){var caHolderManagerInfo=[{__typename:'CAHolderManagerDto',loginGuardianInfo:[]}];jest.mocked(_chainList.useCurrentChain).mockReturnValue(CHAIN_INFO);jest.spyOn(graphqlQuery.contractQueries,'getCAHolderByManager').mockReturnValue(Promise.resolve({caHolderManagerInfo:caHolderManagerInfo}));var _renderHook5=(0,_react.renderHook)(function(){return(0,_graphql.useIntervalQueryCAInfoByAddress)(NETWORK,ADDRESS);}),result=_renderHook5.result;expect(result.current).toBeUndefined();});test('have total data, and return successfully',(0,_asyncToGenerator2.default)(function*(){jest.mocked(_chainList.useCurrentChain).mockReturnValue(CHAIN_INFO);jest.spyOn(graphqlQuery.contractQueries,'getCAHolderByManager').mockReturnValue(Promise.resolve({caHolderManagerInfo:CA_HOLDER_MANAGER_INFO}));jest.spyOn(chainListHooks,'useGetChainInfo').mockReturnValue(function(){return Promise.resolve(_chainInfo.AELFChainInfo);});var res=yield(0,_react.act)((0,_asyncToGenerator2.default)(function*(){return(0,_react.renderHook)(function(){return(0,_graphql.useIntervalQueryCAInfoByAddress)(NETWORK,ADDRESS);});}));expect(res.result.current).toHaveProperty('caInfo');expect(res.result.current).toHaveProperty('originChainId','AELF');}));test('have no return validateManager, and return undefined',(0,_asyncToGenerator2.default)(function*(){jest.mocked(_chainList.useCurrentChain).mockReturnValue(CHAIN_INFO);jest.spyOn(graphqlQuery.contractQueries,'getCAHolderByManager').mockReturnValue(Promise.resolve({caHolderManagerInfo:CA_HOLDER_MANAGER_INFO}));jest.spyOn(chainListHooks,'useGetChainInfo').mockReturnValue(function(){return Promise.reject({code:500});});var res=yield(0,_react.act)((0,_asyncToGenerator2.default)(function*(){return(0,_react.renderHook)(function(){return(0,_graphql.useIntervalQueryCAInfoByAddress)(NETWORK,ADDRESS,jest.fn());});}));expect(res.result.current).toBeUndefined();}));test('no originChainId, and originChainId = DefaultChainId',(0,_asyncToGenerator2.default)(function*(){jest.mocked(_chainList.useCurrentChain).mockReturnValue(CHAIN_INFO);jest.spyOn(graphqlQuery.contractQueries,'getCAHolderByManager').mockReturnValue(Promise.resolve({caHolderManagerInfo:CA_HOLDER_MANAGER_INFO}));jest.spyOn(chainListHooks,'useGetChainInfo').mockReturnValue(function(){return Promise.resolve(_chainInfo.AELFChainInfo);});var res=yield(0,_react.act)((0,_asyncToGenerator2.default)(function*(){return(0,_react.renderHook)(function(){return(0,_graphql.useIntervalQueryCAInfoByAddress)(NETWORK,ADDRESS);});}));expect(res.result.current).toHaveProperty('caInfo');expect(res.result.current).toHaveProperty('originChainId','AELF');}));test('getCAHolderByManager reject, and throw error',function(){jest.mocked(_chainList.useCurrentChain).mockReturnValue(CHAIN_INFO);jest.spyOn(graphqlQuery.contractQueries,'getCAHolderByManager').mockReturnValue(Promise.reject('error'));var _renderHook6=(0,_react.renderHook)(function(){return(0,_graphql.useIntervalQueryCAInfoByAddress)(NETWORK,ADDRESS);}),result=_renderHook6.result;expect(result.current).toBeUndefined();});});describe('useCheckManager',function(){beforeAll(function(){jest.useFakeTimers();});beforeEach(function(){jest.restoreAllMocks();jest.clearAllMocks();});test('complete data, and return successfully',function(){var CAHolderManagerInfoRes={data:{caHolderManagerInfo:[{__typename:'CAHolderManagerDto',id:'AEL...rETp',chainId:'AELF',caHash:'2ed...4a71',caAddress:'A4p...rETp',managerInfos:[{__typename:'ManagerInfo',address:'s3m...BojY',extraData:'1,1679043726757'},{__typename:'ManagerInfo',address:'2Vv...e2sR',extraData:'1,1679380781160'}],originChainId:'AELF'}]},loading:false,networkStatus:7};jest.mocked(_wallet.useCurrentWallet).mockReturnValue((0,_chainInfo.currentWallet)('TESTNET'));jest.mocked(_wallet.useOriginChainId).mockReturnValue('AELF');jest.spyOn(graphqlQuery.contractQueries,'getCAHolderManagerInfo').mockResolvedValue(CAHolderManagerInfoRes);var mockFun=jest.fn();(0,_react.renderHook)(function(){return(0,_graphql.useCheckManager)(mockFun);});(0,_react.act)(function(){jest.runOnlyPendingTimers();});expect(graphqlQuery.contractQueries.getCAHolderManagerInfo).toHaveBeenCalledTimes(1);});test('caHolderManagerInfo.length is 0, and return successfully',function(){var CAHolderManagerInfoRes={data:{caHolderManagerInfo:[]},loading:false,networkStatus:7};jest.mocked(_wallet.useCurrentWallet).mockReturnValue((0,_chainInfo.currentWallet)('TESTNET'));jest.mocked(_wallet.useOriginChainId).mockReturnValue('AELF');jest.spyOn(graphqlQuery.contractQueries,'getCAHolderManagerInfo').mockResolvedValue(CAHolderManagerInfoRes);var mockFun=jest.fn();(0,_react.renderHook)(function(){return(0,_graphql.useCheckManager)(mockFun);});(0,_react.act)(function(){jest.runOnlyPendingTimers();});expect(graphqlQuery.contractQueries.getCAHolderManagerInfo).toHaveBeenCalledTimes(1);});test('getCAHolderManagerInfo.data is undefined, and return successfully',function(){var CAHolderManagerInfoRes={data:undefined,loading:false,networkStatus:7};jest.mocked(_wallet.useCurrentWallet).mockReturnValue((0,_chainInfo.currentWallet)('TESTNET'));jest.mocked(_wallet.useOriginChainId).mockReturnValue('AELF');jest.spyOn(graphqlQuery.contractQueries,'getCAHolderManagerInfo').mockResolvedValue(CAHolderManagerInfoRes);var mockFun=jest.fn();(0,_react.renderHook)(function(){return(0,_graphql.useCheckManager)(mockFun);});(0,_react.act)(function(){jest.runOnlyPendingTimers();});expect(graphqlQuery.contractQueries.getCAHolderManagerInfo).toHaveBeenCalledTimes(1);expect(mockFun).toHaveBeenCalledTimes(0);});test('getCAHolderManagerInfo reject, and catch error',function(){jest.mocked(_wallet.useCurrentWallet).mockReturnValue((0,_chainInfo.currentWallet)('TESTNET'));jest.mocked(_wallet.useOriginChainId).mockReturnValue('AELF');jest.spyOn(graphqlQuery.contractQueries,'getCAHolderManagerInfo').mockRejectedValue({error:{}});var mockFun=jest.fn();(0,_react.renderHook)(function(){return(0,_graphql.useCheckManager)(mockFun);});(0,_react.act)(function(){jest.runOnlyPendingTimers();});expect(graphqlQuery.contractQueries.getCAHolderManagerInfo).toHaveBeenCalledTimes(1);});test('no caHash, and do not call getCAHolderManagerInfo',function(){jest.mocked(_wallet.useCurrentWallet).mockReturnValue(Object.assign({},(0,_chainInfo.currentWallet)('TESTNET'),{walletInfo:undefined}));jest.mocked(_wallet.useOriginChainId).mockReturnValue('AELF');jest.spyOn(graphqlQuery.contractQueries,'getCAHolderManagerInfo').mockRejectedValue({error:{}});var mockFun=jest.fn();(0,_react.renderHook)(function(){return(0,_graphql.useCheckManager)(mockFun);});(0,_react.act)(function(){jest.runOnlyPendingTimers();});expect(graphqlQuery.contractQueries.getCAHolderManagerInfo).toHaveBeenCalledTimes(0);});});