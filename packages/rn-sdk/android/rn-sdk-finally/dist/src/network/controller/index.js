var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.handleRequestPolling=exports.NetworkControllerEntity=exports.NetworkController=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _constants=require("../../global/constants");var _nativeModules=require("../../service/native-modules");var _path=require("../path");var _guardian=require("../dto/guardian");var _utils=require("../../packages/utils");var _token=require("../token");var _core=require("../../model/verify/core");var _commonUtil=require("../../utils/commonUtil");var DEFAULT_MAX_POLLING_TIMES=50;var CHECK_REGISTER_STATUS=_path.APIPaths.CHECK_REGISTER_STATUS,CHECK_SOCIAL_RECOVERY_STATUS=_path.APIPaths.CHECK_SOCIAL_RECOVERY_STATUS,GET_GUARDIAN_INFO=_path.APIPaths.GET_GUARDIAN_INFO,GET_REGISTER_INFO=_path.APIPaths.GET_REGISTER_INFO,GET_RECOMMEND_GUARDIAN=_path.APIPaths.GET_RECOMMEND_GUARDIAN,REFRESH_NETWORK_TOKEN=_path.APIPaths.REFRESH_NETWORK_TOKEN,GET_SYMBOL_IMAGE=_path.APIPaths.GET_SYMBOL_IMAGE;var NETWORK_TOKEN_BLACKLIST=[CHECK_REGISTER_STATUS,CHECK_SOCIAL_RECOVERY_STATUS,GET_GUARDIAN_INFO,GET_REGISTER_INFO,GET_RECOMMEND_GUARDIAN,REFRESH_NETWORK_TOKEN,GET_SYMBOL_IMAGE];var NetworkControllerEntity=exports.NetworkControllerEntity=(0,_createClass2.default)(function NetworkControllerEntity(){var _this=this;(0,_classCallCheck2.default)(this,NetworkControllerEntity);(0,_defineProperty2.default)(this,"realExecute",function(){var _ref=(0,_asyncToGenerator2.default)(function*(url,method,params,headers,extraOptions){var _headers;if(method==='GET'&&params){url+='?';Object.entries(params).forEach(function(_ref2){var _ref3=(0,_slicedToArray2.default)(_ref2,2),key=_ref3[0],value=_ref3[1];url=url+("&"+key+"="+encodeURIComponent(value!=null?value:'null'));});}headers=Object.assign({},(_headers=headers)!=null?_headers:{},{Version:'v1.4.8'});if((yield(0,_core.isWalletUnlocked)())&&!_this.isUrlInBlackList(url)){var access_token=yield(0,_token.getCachedNetworkToken)();headers=Object.assign({},headers,{Authorization:"Bearer "+access_token});}var result=(0,_nativeModules.nativeFetch)(url,method,params,headers,extraOptions);return result;});return function(_x,_x2,_x3,_x4,_x5){return _ref.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"isUrlInBlackList",function(url){return NETWORK_TOKEN_BLACKLIST.some(function(path){return url.includes(path);});});(0,_defineProperty2.default)(this,"getRegisterResult",function(){var _ref4=(0,_asyncToGenerator2.default)(function*(accountIdentifier){return yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.GET_REGISTER_INFO),'GET',{loginGuardianIdentifier:accountIdentifier});});return function(_x6){return _ref4.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"getSymbolImage",(0,_asyncToGenerator2.default)(function*(){return yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.GET_SYMBOL_IMAGE),'GET',{});}));(0,_defineProperty2.default)(this,"getAccountIdentifierResult",function(){var _ref6=(0,_asyncToGenerator2.default)(function*(chainId,accountIdentifier){var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.GET_GUARDIAN_INFO),'GET',{chainId:chainId,guardianIdentifier:accountIdentifier,loginGuardianIdentifier:accountIdentifier});if(!(res!=null&&res.result))throw new Error('network failure');return res.result;});return function(_x7,_x8){return _ref6.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"isGoogleRecaptchaOpen",function(){var _ref7=(0,_asyncToGenerator2.default)(function*(operationType){var _res$result;var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.CHECK_GOOGLE_RECAPTCHA),'POST',{operationType:operationType});return(_res$result=res==null?void 0:res.result)!=null?_res$result:false;});return function(_x9){return _ref7.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"getRecommendedGuardian",function(){var _ref8=(0,_asyncToGenerator2.default)(function*(chainId){var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.GET_RECOMMEND_GUARDIAN),'POST',{chainId:chainId!=null?chainId:yield _constants.PortkeyConfig.currChainId()});if(!(res!=null&&res.result))throw new Error('network failure');return res.result;});return function(_x10){return _ref8.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"getGuardianInfo",function(){var _ref9=(0,_asyncToGenerator2.default)(function*(loginGuardianIdentifier,caHash,chainId){var cachedChainId=chainId!=null?chainId:yield _constants.PortkeyConfig.currChainId();var params={chainId:cachedChainId};caHash&&(params=Object.assign(params,{caHash:caHash}));loginGuardianIdentifier&&(params=Object.assign(params,{loginGuardianIdentifier:loginGuardianIdentifier,guardianIdentifier:loginGuardianIdentifier}));var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.GET_GUARDIAN_INFO),'GET',params);if(!(res!=null&&res.result))throw new Error('network failure');return res.result;});return function(_x11,_x12,_x13){return _ref9.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"getNetworkInfo",(0,_asyncToGenerator2.default)(function*(){var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.CHECK_CHAIN_STATUS),'GET');if(!(res!=null&&res.result))throw new Error('network failure');return res.result;}));(0,_defineProperty2.default)(this,"checkQrCodeStatus",function(){var _ref11=(0,_asyncToGenerator2.default)(function*(id){var _res$result2;var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.CHECK_QR_CODE_STATUS),'POST',{id:id});return(_res$result2=res==null?void 0:res.result)!=null?_res$result2:false;});return function(_x14){return _ref11.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"sendVerifyCode",function(){var _ref12=(0,_asyncToGenerator2.default)(function*(params,headers){var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.SEND_VERIFICATION_CODE),'POST',Object.assign(params,{platformType:getPlatformType()}),headers,{maxWaitingTime:10000});if(!(res!=null&&res.result))throw new Error('network failure');return res.result;});return function(_x15,_x16){return _ref12.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"checkVerifyCode",function(){var _ref13=(0,_asyncToGenerator2.default)(function*(params){var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.CHECK_VERIFICATION_CODE),'POST',params);if(!res)throw new Error('network failure');var result=res.result,errMessage=res.errMessage;return Object.assign({},result!=null?result:{verificationDoc:'',signature:''},{failedBecauseOfTooManyRequests:errMessage==null?void 0:errMessage.includes('Too Many Retries')});});return function(_x17){return _ref13.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"verifyGoogleGuardianInfo",function(){var _ref14=(0,_asyncToGenerator2.default)(function*(params){var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.VERIFY_GOOGLE_TOKEN),'POST',params);if(!(res!=null&&res.result))throw new Error('network failure');return res.result;});return function(_x18){return _ref14.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"verifyAppleGuardianInfo",function(){var _ref15=(0,_asyncToGenerator2.default)(function*(params){var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.VERIFY_APPLE_TOKEN),'POST',params);if(!(res!=null&&res.result))throw new Error('network failure');return res.result;});return function(_x19){return _ref15.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"requestRegister",function(){var _ref16=(0,_asyncToGenerator2.default)(function*(params){var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.REQUEST_REGISTER),'POST',params);if(!(res!=null&&res.result))throw new Error('network failure');return res.result;});return function(_x20){return _ref16.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"requestSocialRecovery",function(){var _ref17=(0,_asyncToGenerator2.default)(function*(params){var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.REQUEST_RECOVERY),'POST',params);if(!(res!=null&&res.result))throw new Error('network failure');return res.result;});return function(_x21){return _ref17.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"checkRegisterProcess",function(){var _ref18=(0,_asyncToGenerator2.default)(function*(sessionId,options){var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.CHECK_REGISTER_STATUS),'GET',{filter:"_id:"+sessionId},{},options);return res.result;});return function(_x22,_x23){return _ref18.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"checkSocialRecoveryProcess",function(){var _ref19=(0,_asyncToGenerator2.default)(function*(sessionId,options){var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.CHECK_SOCIAL_RECOVERY_STATUS),'GET',{filter:"_id:"+sessionId},{},options);return res.result;});return function(_x24,_x25){return _ref19.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"searchTokenList",function(){var _ref20=(0,_asyncToGenerator2.default)(function*(config){var _ref21=config||{},_ref21$chainIdArray=_ref21.chainIdArray,chainIdArray=_ref21$chainIdArray===void 0?['AELF','tDVV','tDVW']:_ref21$chainIdArray,_ref21$keyword=_ref21.keyword,keyword=_ref21$keyword===void 0?'':_ref21$keyword;var chainIdSearchLanguage=chainIdArray.map(function(chainId){return"token.chainId:"+chainId;}).join(' OR ');var filterKeywords=keyword.length<10?"token.symbol: *"+keyword.toUpperCase().trim()+"*":"token.address:"+keyword;var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.GET_TOKEN_INFO),'GET',{filter:filterKeywords+" AND ("+chainIdSearchLanguage+")",sort:'sortWeight desc,isDisplay  desc,token.symbol  acs,token.chainId acs',skipCount:0,maxResultCount:1000});if(!(res!=null&&res.result))throw new Error('network failure');return res.result;});return function(_x26){return _ref20.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"fetchUserTokenBalance",function(){var _ref22=(0,_asyncToGenerator2.default)(function*(config){var caAddressInfos=config.caAddressInfos,_config$skipCount=config.skipCount,skipCount=_config$skipCount===void 0?0:_config$skipCount,_config$maxResultCoun=config.maxResultCount,maxResultCount=_config$maxResultCoun===void 0?100:_config$maxResultCoun;var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.GET_USER_TOKEN_STATUS),'POST',{caAddresses:caAddressInfos.map(function(_ref23){var caAddress=_ref23.caAddress;return caAddress;}),skipCount:skipCount,maxResultCount:maxResultCount});if(!(res!=null&&res.result))throw new Error('network failure');return res.result;});return function(_x27){return _ref22.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"checkELFTokenPrice",(0,_asyncToGenerator2.default)(function*(){var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.GET_TOKEN_PRICES),'GET',{symbols:['ELF']});return res.result;}));(0,_defineProperty2.default)(this,"refreshNetworkToken",function(){var _ref25=(0,_asyncToGenerator2.default)(function*(params){var endPointUrl=yield _constants.PortkeyConfig.endPointUrl();var getAuthUrl=function getAuthUrl(){var url=(0,_commonUtil.selectCurrentBackendConfig)(endPointUrl).connectUrl;return""+url+_path.APIPaths.REFRESH_NETWORK_TOKEN;};var res=yield _this.realExecute(getAuthUrl(),'POST',Object.assign({},params,{grant_type:'signature',client_id:'CAServer_App',scope:'CAServer'}),{'Content-Type':'application/x-www-form-urlencoded'});if(!(res!=null&&res.result))throw new Error('network failure');return res.result;});return function(_x28){return _ref25.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"getCountryCodeInfo",(0,_asyncToGenerator2.default)(function*(){var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.GET_PHONE_COUNTRY_CODE),'GET');if(!(res!=null&&res.result))throw new Error('network failure');return res.result;}));(0,_defineProperty2.default)(this,"fetchNetCollections",function(){var _ref27=(0,_asyncToGenerator2.default)(function*(config){var caAddressInfos=config.caAddressInfos,_config$skipCount2=config.skipCount,skipCount=_config$skipCount2===void 0?0:_config$skipCount2,_config$maxResultCoun2=config.maxResultCount,maxResultCount=_config$maxResultCoun2===void 0?100:_config$maxResultCoun2;var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.FETCH_NFT_COLLECTIONS),'POST',{caAddressInfos:caAddressInfos,skipCount:skipCount,maxResultCount:maxResultCount,width:16,height:16});if(!(res!=null&&res.result))throw new Error('network failure');return res.result;});return function(_x29){return _ref27.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"fetchParticularNftItemList",function(){var _ref28=(0,_asyncToGenerator2.default)(function*(config){var caAddressInfos=config.caAddressInfos,_config$skipCount3=config.skipCount,skipCount=_config$skipCount3===void 0?0:_config$skipCount3,_config$maxResultCoun3=config.maxResultCount,maxResultCount=_config$maxResultCoun3===void 0?100:_config$maxResultCoun3,symbol=config.symbol;var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.FETCH_NFT_COLLECTIONS_ITEM),'POST',{caAddressInfos:caAddressInfos,skipCount:skipCount,symbol:symbol,maxResultCount:maxResultCount,width:16,height:16});if(!(res!=null&&res.result))throw new Error('network failure');return res.result;});return function(_x30){return _ref28.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"fetchTransferLimitRule",function(){var _ref29=(0,_asyncToGenerator2.default)(function*(config){var caHash=config.caHash,_config$skipCount4=config.skipCount,skipCount=_config$skipCount4===void 0?0:_config$skipCount4,_config$maxResultCoun4=config.maxResultCount,maxResultCount=_config$maxResultCoun4===void 0?100:_config$maxResultCoun4;var res=yield _this.realExecute(yield _this.parseUrl(_path.APIPaths.CHECK_TRANSFER_LIMIT),'GET',{caHash:caHash,skipCount:skipCount,maxResultCount:maxResultCount});if(!(res!=null&&res.result))throw new Error('network failure');return res.result;});return function(_x31){return _ref29.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"parseUrl",function(){var _ref30=(0,_asyncToGenerator2.default)(function*(url){return""+(yield _constants.PortkeyConfig.endPointUrl())+url;});return function(_x32){return _ref30.apply(this,arguments);};}());});var getPlatformType=function getPlatformType(){return _guardian.RecaptchaPlatformType.JS;};var NetworkController=exports.NetworkController=new NetworkControllerEntity();var handleRequestPolling=exports.handleRequestPolling=function(){var _ref31=(0,_asyncToGenerator2.default)(function*(config){var sendRequest=config.sendRequest,_config$maxPollingTim=config.maxPollingTimes,maxPollingTimes=_config$maxPollingTim===void 0?DEFAULT_MAX_POLLING_TIMES:_config$maxPollingTim,_config$timeGap=config.timeGap,timeGap=_config$timeGap===void 0?1000:_config$timeGap,_config$verifyResult=config.verifyResult,verifyResult=_config$verifyResult===void 0?function(){return true;}:_config$verifyResult,_config$declareFatalF=config.declareFatalFail,declareFatalFail=_config$declareFatalF===void 0?function(){return false;}:_config$declareFatalF;var pollingTimes=0;var result=null;while(pollingTimes<maxPollingTimes){try{result=yield sendRequest();}catch(ignored){console.error(ignored);}if(result&&verifyResult(result)){break;}else if(result&&declareFatalFail(result)){throw new Error('fatal error in handleRequestPolling()');}pollingTimes++;yield(0,_utils.sleep)(timeGap);}if(!result)throw new Error('network failure');return result;});return function handleRequestPolling(_x33){return _ref31.apply(this,arguments);};}();