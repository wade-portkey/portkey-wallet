var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _react=_interopRequireWildcard(require("react"));var _reactNative=require("react-native");var _deviceEvent=_interopRequireDefault(require("../../utils/deviceEvent"));var _device=require("../../packages/utils/mobile/device");var _jsxFileName="/Users/fengfeiyang/aelf/portkey-wallet/packages/rn-sdk/android/rn-sdk-finally/src/components/TransformView/index.tsx";function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap(),t=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r;})(e);}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&Object.prototype.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u];}return n.default=e,t&&t.set(e,n),n;}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=(0,_getPrototypeOf2.default)(Derived),result;if(hasNativeReflectConstruct){var NewTarget=(0,_getPrototypeOf2.default)(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return(0,_possibleConstructorReturn2.default)(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}var TransformView=exports.default=function(_Component){(0,_inherits2.default)(TransformView,_Component);var _super=_createSuper(TransformView);function TransformView(props){var _this;(0,_classCallCheck2.default)(this,TransformView);_this=_super.call(this,props);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"viewLayout",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"prevTouches",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"initContentLayout",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"longPressTimer",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"panResponder",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"touchMoved",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"lockDirection",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"dxSum",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"dySum",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"speedX",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"speedY",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"touchTime",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"panResponderStatus",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"nestScrollViewLayout",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"listenerList",[]);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"onPanResponderGrant",function(e){_this.setupLongPressTimer(e);_this.touchMoved=false;_this.lockDirection='none';_this.dxSum=0;_this.dySum=0;_this.speedX=0;_this.speedY=0;_this.touchTime=new Date();_this.prevTouches=e.nativeEvent.touches;var onWillTransform=_this.props.onWillTransform;var _this$state=_this.state,translateX=_this$state.translateX,translateY=_this$state.translateY,scale=_this$state.scale;onWillTransform==null?void 0:onWillTransform(translateX._value,translateY._value,scale._value);});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"getDisableScrollMap",function(){var _this$props$disableSc;var disableMap=((_this$props$disableSc=_this.props.disableScroll)==null?void 0:_this$props$disableSc.reduce(function(acc,cur){acc[cur]=true;return acc;},{}))||{};var up=disableMap.up||disableMap.vertical;var down=disableMap.down||disableMap.vertical;var left=disableMap.left||disableMap.horizontal;var right=disableMap.right||disableMap.horizontal;return{up:up,down:down,left:left,right:right};});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"handleNewX",function(newX){var _this$getDisableScrol=_this.getDisableScrollMap(),left=_this$getDisableScrol.left,right=_this$getDisableScrol.right;if(left&&newX<0||right&&newX>0)newX=0;return newX;});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"handleNewY",function(newY){var _this$getDisableScrol2=_this.getDisableScrollMap(),up=_this$getDisableScrol2.up,down=_this$getDisableScrol2.down;if(up&&newY<0||down&&newY>0)newY=0;return newY;});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"handleScale",function(newScale){var _this$props=_this.props,minScale=_this$props.minScale,maxScale=_this$props.maxScale;if(!newScale){newScale=minScale;}else if(newScale<minScale){newScale=minScale;}else if(newScale>maxScale){newScale=maxScale;}return newScale;});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"setTranslateY",function(newY){_this.state.translateY.setValue(_this.handleNewY(newY));});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"setTranslateX",function(newX){_this.state.translateX.setValue(_this.handleNewX(newX));});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"setScale",function(newScale){_this.state.scale.setValue(_this.handleScale(newScale));});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"getTranslateXAnimated",function(newX){var duration=arguments.length>1&&arguments[1]!==undefined?arguments[1]:100;return _reactNative.Animated.timing(_this.state.translateX,{toValue:_this.handleNewX(newX),easing:_reactNative.Easing.elastic(0),duration:duration,useNativeDriver:false});});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"getTranslateYAnimated",function(newY){var duration=arguments.length>1&&arguments[1]!==undefined?arguments[1]:100;return _reactNative.Animated.timing(_this.state.translateY,{toValue:_this.handleNewY(newY),easing:_reactNative.Easing.elastic(0),duration:duration,useNativeDriver:false});});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"getScaleAnimated",function(newScale){var duration=arguments.length>1&&arguments[1]!==undefined?arguments[1]:100;return _reactNative.Animated.timing(_this.state.scale,{toValue:newScale,easing:_reactNative.Easing.elastic(0),duration:duration,useNativeDriver:false});});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"onPanResponderMove",function(e){_this.handleTouches(e.nativeEvent.touches,function(dx,dy,speedX,speedY,scaleRate){var _this$props2=_this.props,tension=_this$props2.tension,onTransforming=_this$props2.onTransforming,_this$props2$tensionF=_this$props2.tensionFactor,tensionFactor=_this$props2$tensionF===void 0?3:_this$props2$tensionF;var _this$state2=_this.state,translateX=_this$state2.translateX,translateY=_this$state2.translateY,scale=_this$state2.scale;var _this$contentLayout=_this.contentLayout,x=_this$contentLayout.x,y=_this$contentLayout.y,width=_this$contentLayout.width,height=_this$contentLayout.height;if(tension){if(x>_this.initContentLayout.x)dx/=tensionFactor;else if(x+width<_this.initContentLayout.x+_this.initContentLayout.width)dx/=tensionFactor;if(y>_this.initContentLayout.y)dy/=tensionFactor;else if(y+height<_this.initContentLayout.y+_this.initContentLayout.height)dy/=tensionFactor;}_this.dxSum+=dx;_this.dySum+=dy;_this.speedX=speedX;_this.speedY=speedY;var adx=Math.abs(_this.dxSum),ady=Math.abs(_this.dySum),asr=Math.abs(scaleRate-1);if(!_this.touchMoved&&adx<6&&ady<6&&asr<0.01){return;}if(e.nativeEvent.touches.length===1&&_this.lockDirection==='none'){if(adx>ady&&height<=_this.viewLayout.height){_this.lockDirection='y';}else if(adx<ady&&width<=_this.viewLayout.width){_this.lockDirection='x';}}var newY,newX;switch(_this.lockDirection){case'x':newX=0;newY=translateY._value+dy;break;case'y':newX=translateX._value+dx;newY=0;break;default:newX=translateX._value+dx;newY=translateY._value+dy;_this.setScale(scale._value*scaleRate);}_this.setTranslateX(newX);_this.setTranslateY(newY);_this.removeLongPressTimer();_this.touchMoved=true;onTransforming==null?void 0:onTransforming(translateX._value,translateY._value,scale._value);});});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"onPanResponderRelease",function(e){_this.initResponderStatus();_this.removeLongPressTimer();_this.prevTouches=[];_this.handleRelease();var _this$props3=_this.props,onDidTransform=_this$props3.onDidTransform,onPress=_this$props3.onPress;var _this$state3=_this.state,translateX=_this$state3.translateX,translateY=_this$state3.translateY,scale=_this$state3.scale;onDidTransform==null?void 0:onDidTransform(translateX._value,translateY._value,scale._value);var now=new Date();if(!_this.touchTime)_this.touchTime=now;if(!_this.touchMoved){var duration=now.getTime()-_this.touchTime.getTime();if(duration<500)onPress==null?void 0:onPress(e);}});_this.createPanResponder();_this.prevTouches=[];_this.viewLayout={x:0,y:0,width:0,height:0};_this.initContentLayout={x:0,y:0,width:0,height:0};_this.nestScrollViewLayout={x:0,y:0,width:0,height:0};_this.state={translateX:new _reactNative.Animated.Value(0),translateY:new _reactNative.Animated.Value(0),scale:new _reactNative.Animated.Value(1)};_this.initResponderStatus();_this.initListeners();return _this;}(0,_createClass2.default)(TransformView,[{key:"componentWillUnmount",value:function componentWillUnmount(){this.listenerList.forEach(function(listener){listener.remove();});}},{key:"contentLayout",get:function get(){var _this$state4=this.state,translateX=_this$state4.translateX,translateY=_this$state4.translateY,scale=_this$state4.scale;var originX=this.initContentLayout.x+this.initContentLayout.width/2;var originY=this.initContentLayout.y+this.initContentLayout.height/2;var scaleOriginX=originX+translateX._value;var scaleOriginY=originY+translateY._value;var scaleWidth=this.initContentLayout.width*scale._value;var scaleHeight=this.initContentLayout.height*scale._value;var scaleX=scaleOriginX-scaleWidth/2;var scaleY=scaleOriginY-scaleHeight/2;var contentLayout={x:scaleX,y:scaleY,width:scaleWidth,height:scaleHeight};return contentLayout;}},{key:"initResponderStatus",value:function initResponderStatus(){this.panResponderStatus=_device.isIOS?!this.props.enabledNestScrollView:true;}},{key:"initListeners",value:function initListeners(){var _this2=this;var listener1=_deviceEvent.default.nestScrollViewScrolledTop.addListener(function(){_this2.panResponderStatus=true;});var listener2=_deviceEvent.default.nestScrollViewLayout.addListener(function(layout){_this2.nestScrollViewLayout=layout;});this.listenerList=[listener1,listener2];}},{key:"setupLongPressTimer",value:function setupLongPressTimer(e){var _this3=this;var onLongPress=this.props.onLongPress;if(!onLongPress)return;this.removeLongPressTimer();this.longPressTimer=setTimeout(function(){_this3.longPressTimer=undefined;onLongPress==null?void 0:onLongPress(e);},500);}},{key:"removeLongPressTimer",value:function removeLongPressTimer(){if(this.longPressTimer){clearTimeout(this.longPressTimer);this.longPressTimer=undefined;}}},{key:"createPanResponder",value:function createPanResponder(){var _this4=this;this.panResponder=_reactNative.PanResponder.create({onStartShouldSetPanResponder:function onStartShouldSetPanResponder(){return false;},onStartShouldSetPanResponderCapture:function onStartShouldSetPanResponderCapture(){return false;},onMoveShouldSetPanResponder:function onMoveShouldSetPanResponder(evt,gestureState){var pageY=evt.nativeEvent.pageY;var dx=gestureState.dx,dy=gestureState.dy;if(_device.isIOS){var isNotNestScrollViewArea=pageY<_this4.viewLayout.y+_this4.nestScrollViewLayout.y;return isNotNestScrollViewArea||!!_this4.panResponderStatus&&dx!==0&&dy>5;}return!!_this4.panResponderStatus&&dx!==0&&dy!==0&&(Math.abs(dx)>5||Math.abs(dy)>5);},onMoveShouldSetPanResponderCapture:function onMoveShouldSetPanResponderCapture(){return false;},onPanResponderGrant:function onPanResponderGrant(e,gestureState){return _this4.onPanResponderGrant(e,gestureState);},onPanResponderMove:function onPanResponderMove(e,gestureState){return _this4.onPanResponderMove(e,gestureState);},onPanResponderTerminationRequest:function onPanResponderTerminationRequest(){return true;},onPanResponderRelease:function onPanResponderRelease(e,gestureState){return _this4.onPanResponderRelease(e,gestureState);},onPanResponderTerminate:function onPanResponderTerminate(){return true;},onShouldBlockNativeResponder:function onShouldBlockNativeResponder(){return true;}});}},{key:"handleTouches",value:function handleTouches(touches,onHandleCompleted){var prevTouches=this.prevTouches;this.prevTouches=touches;if(touches.length===0||touches.length!==prevTouches.length){return;}for(var i=0;i<touches.length;++i){if(touches[i].identifier!==prevTouches[i].identifier){return;}}var t0,t1;if(touches.length===1){t0={x:prevTouches[0].pageX,y:prevTouches[0].pageY};t1={x:touches[0].pageX,y:touches[0].pageY};}else{t0={x:(prevTouches[0].pageX+prevTouches[1].pageX)/2,y:(prevTouches[0].pageY+prevTouches[1].pageY)/2};t1={x:(touches[0].pageX+touches[1].pageX)/2,y:(touches[0].pageY+touches[1].pageY)/2};}var dx=t1.x-t0.x;var dy=t1.y-t0.y;var t=touches[0].timestamp-prevTouches[0].timestamp;var speedX=t?dx/t:0;var speedY=t?dy/t:0;var distance0=0,distance1=0;if(touches.length>=2){var dx0=prevTouches[1].pageX-prevTouches[0].pageX;var dy0=prevTouches[1].pageY-prevTouches[0].pageY;var dx1=touches[1].pageX-touches[0].pageX;var dy1=touches[1].pageY-touches[0].pageY;distance0=Math.sqrt(dx0*dx0+dy0*dy0);distance1=Math.sqrt(dx1*dx1+dy1*dy1);}if(distance0&&distance1){var _scaleRate=distance1/distance0;var maxScale=this.props.maxScale;var _scale=this.state.scale;if(_scale._value*_scaleRate>maxScale){_scaleRate=maxScale/_scale._value;}onHandleCompleted(dx,dy,speedX,speedY,_scaleRate);}else{onHandleCompleted(dx,dy,speedX,speedY,1);}}},{key:"handleRelease",value:function handleRelease(){var _this5=this;var _this$props4=this.props,inertial=_this$props4.inertial,onWillInertialMove=_this$props4.onWillInertialMove,onDidInertialMove=_this$props4.onDidInertialMove;var _this$state5=this.state,translateX=_this$state5.translateX,translateY=_this$state5.translateY;var inertiaX=this.speedX*60;var inertiaY=this.speedY*60;if(this.lockDirection==='x'||Math.abs(inertiaX)<10)inertiaX=0;if(this.lockDirection==='y'||Math.abs(inertiaY)<10)inertiaY=0;if(inertial&&inertiaX||inertiaY){var _newX=translateX._value+inertiaX;var _newY=translateY._value+inertiaY;var animates=[];inertiaX&&animates.push(this.getTranslateXAnimated(_newX));inertiaY&&animates.push(this.getTranslateYAnimated(_newY));var canInertialMove=!onWillInertialMove||onWillInertialMove(translateX._value,translateY._value,_newX,_newY);canInertialMove&&_reactNative.Animated.parallel(animates).start(function(){_this5.setTranslateX(_newX);_this5.setTranslateY(_newY);onDidInertialMove==null?void 0:onDidInertialMove(translateX._value,translateY._value,_newX,_newY);_this5.handleMagnetic();});}else{this.handleMagnetic();}}},{key:"handleMagnetic",value:function handleMagnetic(){var _this6=this;var _this$props5=this.props,magnetic=_this$props5.magnetic,maxScale=_this$props5.maxScale,minScale=_this$props5.minScale,onDidTransform=_this$props5.onDidTransform,onWillMagnetic=_this$props5.onWillMagnetic,onDidMagnetic=_this$props5.onDidMagnetic;var _this$state6=this.state,translateX=_this$state6.translateX,translateY=_this$state6.translateY,scale=_this$state6.scale;var newX=null,newY=null,newScale=null;if(magnetic){var _this$contentLayout2=this.contentLayout,x=_this$contentLayout2.x,y=_this$contentLayout2.y,width=_this$contentLayout2.width,height=_this$contentLayout2.height;if(width<this.initContentLayout.width||height<this.initContentLayout.height){newX=0;newY=0;newScale=1;}else{if(width<this.viewLayout.width){newX=0;}else if(x>0){newX=translateX._value-x;}else if(x+width<this.viewLayout.width){newX=translateX._value+(this.viewLayout.width-(x+width));}if(height<this.viewLayout.height){newY=0;}else if(y>0){newY=translateY._value-y;}else if(y+height<this.viewLayout.height){newY=translateY._value+(this.viewLayout.height-(y+height));}}}if(newScale===null){if(scale._value>maxScale)newScale=maxScale;else if(scale._value<minScale)newScale=minScale;}var animates=[];newX!==null&&animates.push(this.getTranslateXAnimated(newX,200));newY!==null&&animates.push(this.getTranslateYAnimated(newY,200));newScale!==null&&animates.push(this.getScaleAnimated(newScale));if(animates.length>0){if(newX===null)newX=translateX._value;if(newY===null)newY=translateY._value;if(newScale===null)newScale=scale._value;var canDoMagnetic=!onWillMagnetic||onWillMagnetic(translateX._value,translateY._value,scale._value,newX,newY,newScale);canDoMagnetic&&_reactNative.Animated.parallel(animates).start(function(){_this6.setTranslateX(newX);_this6.setTranslateY(newY);_this6.setScale(newScale);onDidTransform==null?void 0:onDidTransform(newX,newY,newScale);onDidMagnetic==null?void 0:onDidMagnetic(newX,newY,newScale);});}}},{key:"onLayout",value:function onLayout(e){var _this$props$onLayout,_this$props6;this.viewLayout=e.nativeEvent.layout;(_this$props$onLayout=(_this$props6=this.props).onLayout)==null?void 0:_this$props$onLayout.call(_this$props6,e);}},{key:"render",value:function render(){var _this7=this;var _this$props7=this.props,style=_this$props7.style,children=_this$props7.children,containerStyle=_this$props7.containerStyle;var _this$state7=this.state,translateX=_this$state7.translateX,translateY=_this$state7.translateY,scale=_this$state7.scale;return _react.default.createElement(_reactNative.View,(0,_extends2.default)({style:[styles.box,style],onLayout:function onLayout(e){return _this7.onLayout(e);}},this.panResponder.panHandlers,{__self:this,__source:{fileName:_jsxFileName,lineNumber:481,columnNumber:7}}),_react.default.createElement(_reactNative.Animated.View,{style:[{transform:[{translateX:translateX},{translateY:translateY},{scale:scale}]},containerStyle],onLayout:function onLayout(e){_this7.initContentLayout=e.nativeEvent.layout;},__self:this,__source:{fileName:_jsxFileName,lineNumber:482,columnNumber:9}},children));}}]);return TransformView;}(_react.Component);(0,_defineProperty2.default)(TransformView,"defaultProps",{inertial:true,magnetic:true,tension:true,tensionFactor:3,enabledNestScrollView:false});var styles=_reactNative.StyleSheet.create({box:{flex:1,alignItems:'center',justifyContent:'center',overflow:'hidden'}});