var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.verification=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _apiDid=require("../packages/api/api-did");var _utils=require("../packages/api/api-did/verification/utils");var _verifier=require("../packages/types/verifier");var _storage=require("../packages/utils/mobile/storage");var _VerifyHumanMachine=require("../components/VerifyHumanMachine");function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=(0,_getPrototypeOf2.default)(Derived),result;if(hasNativeReflectConstruct){var NewTarget=(0,_getPrototypeOf2.default)(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return(0,_possibleConstructorReturn2.default)(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}var MobileVerification=function(_Verification){(0,_inherits2.default)(MobileVerification,_Verification);var _super=_createSuper(MobileVerification);function MobileVerification(store){(0,_classCallCheck2.default)(this,MobileVerification);return _super.call(this,store);}(0,_createClass2.default)(MobileVerification,[{key:"sendVerificationCode",value:function(){var _sendVerificationCode=(0,_asyncToGenerator2.default)(function*(config){var _config$params=config.params,guardianIdentifier=_config$params.guardianIdentifier,verifierId=_config$params.verifierId,operationType=_config$params.operationType;var key=(guardianIdentifier||'')+(verifierId||'');try{var item=this.get(key);if(item){return item;}else{var isNeedRecaptcha=operationType===_verifier.OperationTypeEnum.register;if(!isNeedRecaptcha){var result=yield _apiDid.request.verify.checkGoogleRecaptcha({params:{operationType:operationType}});isNeedRecaptcha=!!result;}if(isNeedRecaptcha){var reCaptchaToken=yield(0,_VerifyHumanMachine.verifyHumanMachine)('en');config.headers={reCaptchaToken:reCaptchaToken};}var req=yield _apiDid.request.verify.sendVerificationRequest(config);yield this.set(key,Object.assign({},req,{time:Date.now()}));return req;}}catch(error){var _ref=(error==null?void 0:error.error)||error||{},message=_ref.message;var _item=this.get(key);if(message===_utils.IntervalErrorMessage&&_item)return _item;throw error;}});function sendVerificationCode(_x){return _sendVerificationCode.apply(this,arguments);}return sendVerificationCode;}()}]);return MobileVerification;}(_utils.Verification);var verification=exports.verification=new MobileVerification(_storage.baseStore);