var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=exports.DidService=void 0;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _config=require("../server/config");var _fetch=require("../../utils/fetch");var _ExceptionManager=require("../../utils/ExceptionManager");var _utils=require("../utils");var _utils2=require("./utils");var _utils3=require("../../utils");var _im=_interopRequireDefault(require("../../im"));var _constant=require("../../im/constant");var _excluded=["method","url","baseURL"];function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=(0,_getPrototypeOf2.default)(Derived),result;if(hasNativeReflectConstruct){var NewTarget=(0,_getPrototypeOf2.default)(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return(0,_possibleConstructorReturn2.default)(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}var DidService=exports.DidService=function(_ServiceInit){(0,_inherits2.default)(DidService,_ServiceInit);var _super=_createSuper(DidService);function DidService(){var _this;(0,_classCallCheck2.default)(this,DidService);_this=_super.call(this);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"refreshTokenConfig",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"onLockApp",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"locked",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"exceptionManager",void 0);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"getConnectToken",(0,_asyncToGenerator2.default)(function*(){if(_this.locked){yield(0,_utils3.sleep)(1000);return'locked';}_this.locked=true;try{var _im$config$requestCon;if(!_this.refreshTokenConfig||!(0,_utils2.isValidRefreshTokenConfig)(_this.refreshTokenConfig))return;var authorization=yield(0,_utils2.queryAuthorization)(_this.refreshTokenConfig);_this.defaultConfig.headers=Object.assign({},_this.defaultConfig.headers,{Authorization:authorization});_im.default.config.setConfig({requestDefaults:{headers:Object.assign({},(_im$config$requestCon=_im.default.config.requestConfig)==null?void 0:_im$config$requestCon.headers,{Authorization:authorization})}});_this.locked=false;return authorization;}catch(error){_this.locked=false;console.log(error,'====error-getConnectToken');return;}}));(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"initService",function(){_this.refreshTokenConfig=undefined;_this.defaultConfig.headers=Object.assign({},_this.defaultConfig.headers,{Authorization:''});});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"setRefreshTokenConfig",function(config){var _this$refreshTokenCon;if(((_this$refreshTokenCon=_this.refreshTokenConfig)==null?void 0:_this$refreshTokenCon.ca_hash)!==config.ca_hash){_this.defaultConfig.headers=Object.assign({},_this.defaultConfig.headers,{Authorization:''});}_this.refreshTokenConfig=config;try{_this.getConnectToken();}catch(error){console.log(error);}});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"send",function(){var _ref2=(0,_asyncToGenerator2.default)(function*(base,config){var reCount=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;try{return yield _this.sendOrigin(base,config,reCount);}catch(errResult){var _this$getConfig=_this.getConfig(base,config),_URL=_this$getConfig.URL,fetchConfig=_this$getConfig.fetchConfig;_this.errorReport(_URL,fetchConfig,errResult);throw errResult;}});return function(_x,_x2){return _ref2.apply(this,arguments);};}());(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"getConfig",function(base,config){var _ref3=(0,_utils.getRequestConfig)(base,config,_this.defaultConfig)||{},_ref3$method=_ref3.method,method=_ref3$method===void 0?'POST':_ref3$method,url=_ref3.url,baseURL=_ref3.baseURL,fetchConfig=(0,_objectWithoutProperties2.default)(_ref3,_excluded);var _url=url||(typeof base==='string'?base:base.target);var URL=(0,_utils.spliceUrl)(baseURL||'',_url);return{URL:URL,method:method,fetchConfig:fetchConfig};});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"sendOrigin",function(){var _ref4=(0,_asyncToGenerator2.default)(function*(base,config){var reCount=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var _this$getConfig2=_this.getConfig(base,config),URL=_this$getConfig2.URL,fetchConfig=_this$getConfig2.fetchConfig,method=_this$getConfig2.method;var fetchResult=yield(0,_fetch.customFetch)(URL,Object.assign({},fetchConfig,{method:method}));if(fetchResult&&fetchResult.status===401&&fetchResult.message==='unauthorized'){if(!_this.refreshTokenConfig)throw fetchResult;if(reCount>5)throw fetchResult;var token=yield _this.getConnectToken();if(!token){if(_this.refreshTokenConfig&&!(0,_utils2.isValidRefreshTokenConfig)(_this.refreshTokenConfig)){_this.onLockApp==null?void 0:_this.onLockApp(true);throw Object.assign({},fetchResult,{code:402,message:'token expires'});}throw fetchResult;}return _this.send(base,config,++reCount);}else if(fetchResult&&_constant.IM_TOKEN_ERROR_ARRAY.includes(fetchResult.code)){yield _im.default.refreshToken();return _this.send(base,config,++reCount);}return fetchResult;});return function(_x3,_x4){return _ref4.apply(this,arguments);};}());(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"setLockCallBack",function(callBack){_this.onLockApp=callBack;});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"setExceptionManager",function(exceptionManager){_this.exceptionManager=exceptionManager;});(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"errorReport",function(url,fetchConfig,fetchResult){var _this$exceptionManage;(_this$exceptionManage=_this.exceptionManager)==null?void 0:_this$exceptionManage.reportErrorMessage==null?void 0:_this$exceptionManage.reportErrorMessage(URL+" request error",_ExceptionManager.Severity.Fatal,{req:{url:url,config:fetchConfig},rep:fetchResult});});return _this;}return(0,_createClass2.default)(DidService);}(_config.ServiceInit);var _default=exports.default=new DidService();