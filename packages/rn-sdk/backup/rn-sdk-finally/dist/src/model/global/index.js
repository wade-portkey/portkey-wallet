var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.requestSocialRecoveryOrRegister=exports.parseGuardianInfo=exports.isReacptchaOpen=exports.guardianTypeStrToEnum=exports.guardianEnumToTypeStr=exports.getSocialRecoveryPageData=exports.getRegisterPageData=exports.getCachedCountryCodeData=exports.getCaInfoByAccountIdentifierOrSessionId=exports.checkForCountryCodeCached=exports.attemptAccountCheck=exports.CURRENT_USING_COUNTRY_CODE=exports.COUNTRY_CODE_DATA_KEY=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _verifier=require("../../packages/types/verifier");var _constants=require("../../global/constants");var _core=require("../verify/core");var _socialRecovery=require("../verify/social-recovery");var _controller=require("../../network/controller");var _wallet=require("../../network/dto/wallet");var _utils=require("../../packages/utils");var _storage=require("../../service/storage");var _handler=require("../contract/handler");var COUNTRY_CODE_DATA_KEY=exports.COUNTRY_CODE_DATA_KEY='countryCodeData';var CURRENT_USING_COUNTRY_CODE=exports.CURRENT_USING_COUNTRY_CODE='currentUsingCountryCode';var attemptAccountCheck=exports.attemptAccountCheck=function(){var _ref=(0,_asyncToGenerator2.default)(function*(accountIdentifier){var registerResultDTO=yield _controller.NetworkController.getRegisterResult(accountIdentifier);if(registerResultDTO!=null&&registerResultDTO.result){var _guardianResultDTO$gu,_guardianResultDTO$gu2;var originChainId=registerResultDTO.result.originChainId;originChainId&&(0,_constants.setCurrChainId)(originChainId);var guardianResultDTO=yield _controller.NetworkController.getAccountIdentifierResult(originChainId!=null?originChainId:yield _constants.PortkeyConfig.currChainId(),accountIdentifier);return{hasRegistered:(guardianResultDTO==null?void 0:(_guardianResultDTO$gu=guardianResultDTO.guardianList)==null?void 0:(_guardianResultDTO$gu2=_guardianResultDTO$gu.guardians)==null?void 0:_guardianResultDTO$gu2.length)>0};}else if((registerResultDTO==null?void 0:registerResultDTO.errCode)==='3002'){return{hasRegistered:false};}else{throw new Error('network failure');}});return function attemptAccountCheck(_x){return _ref.apply(this,arguments);};}();var checkForCountryCodeCached=exports.checkForCountryCodeCached=function(){var _ref2=(0,_asyncToGenerator2.default)(function*(){var countryCodeDataDTO=yield _controller.NetworkController.getCountryCodeInfo();if(countryCodeDataDTO){_storage.GlobalStorage.set(COUNTRY_CODE_DATA_KEY,JSON.stringify(countryCodeDataDTO));_storage.GlobalStorage.set(CURRENT_USING_COUNTRY_CODE,JSON.stringify(countryCodeDataDTO.locateData));return true;}else{return false;}});return function checkForCountryCodeCached(){return _ref2.apply(this,arguments);};}();var getCachedCountryCodeData=exports.getCachedCountryCodeData=function(){var _ref3=(0,_asyncToGenerator2.default)(function*(){var countryCodeDataDTO=yield _storage.GlobalStorage.getString(COUNTRY_CODE_DATA_KEY);if(countryCodeDataDTO){var result=JSON.parse(countryCodeDataDTO);return result;}else{return yield _controller.NetworkController.getCountryCodeInfo();}});return function getCachedCountryCodeData(){return _ref3.apply(this,arguments);};}();var isReacptchaOpen=exports.isReacptchaOpen=function(){var _ref4=(0,_asyncToGenerator2.default)(function*(scene){var result=yield _controller.NetworkController.isGoogleRecaptchaOpen(scene);return result!=null?result:false;});return function isReacptchaOpen(_x2){return _ref4.apply(this,arguments);};}();var getRegisterPageData=exports.getRegisterPageData=function(){var _ref5=(0,_asyncToGenerator2.default)(function*(accountIdentifier,accountOriginalType,navigateToGuardianPage){var _recommendedGuardian$,_recommendedGuardian$2;var recommendedGuardian=yield _controller.NetworkController.getRecommendedGuardian();var chainId=yield _constants.PortkeyConfig.currChainId();return{accountIdentifier:accountIdentifier,accountOriginalType:accountOriginalType,navigateToGuardianPage:navigateToGuardianPage,guardianConfig:{accountIdentifier:accountIdentifier,accountOriginalType:accountOriginalType,isLoginGuardian:true,name:(_recommendedGuardian$=recommendedGuardian.name)!=null?_recommendedGuardian$:'Portkey',imageUrl:(_recommendedGuardian$2=recommendedGuardian.imageUrl)!=null?_recommendedGuardian$2:null,sendVerifyCodeParams:{type:_core.AccountOriginalType[accountOriginalType],guardianIdentifier:accountIdentifier,verifierId:recommendedGuardian.id,chainId:chainId,operationType:_verifier.OperationTypeEnum.register}}};});return function getRegisterPageData(_x3,_x4,_x5){return _ref5.apply(this,arguments);};}();var getSocialRecoveryPageData=exports.getSocialRecoveryPageData=function(){var _ref6=(0,_asyncToGenerator2.default)(function*(accountIdentifier,accountOriginalType,thirdPartyAccountInfo){var _yield$getOrReadCache,_yield$getOrReadCache2,_guardians$guardianLi,_guardians$guardianLi2;var guardians=yield _controller.NetworkController.getGuardianInfo(accountIdentifier);var chainId=yield _constants.PortkeyConfig.currChainId();var cachedVerifierData=Object.values((_yield$getOrReadCache=(_yield$getOrReadCache2=(yield(0,_handler.getOrReadCachedVerifierData)()).data)==null?void 0:_yield$getOrReadCache2.verifierServers)!=null?_yield$getOrReadCache:{});return{accountIdentifier:accountIdentifier,accountOriginalType:accountOriginalType,guardianVerifyType:_socialRecovery.GuardianVerifyType.CREATE_WALLET,guardians:((_guardians$guardianLi=guardians==null?void 0:(_guardians$guardianLi2=guardians.guardianList)==null?void 0:_guardians$guardianLi2.guardians)!=null?_guardians$guardianLi:[]).map(function(guardian){return parseGuardianInfo(guardian,chainId,cachedVerifierData);}),thirdPartyAccountInfo:thirdPartyAccountInfo};});return function getSocialRecoveryPageData(_x6,_x7,_x8){return _ref6.apply(this,arguments);};}();var parseGuardianInfo=exports.parseGuardianInfo=function parseGuardianInfo(guardianOriginalInfo,chainId,cachedVerifierData,verifiedData){var _guardianOriginalInfo;var accountIdentifier=arguments.length>4&&arguments[4]!==undefined?arguments[4]:'';var accountOriginalType=arguments.length>5&&arguments[5]!==undefined?arguments[5]:_core.AccountOriginalType.Email;var operationType=arguments.length>6&&arguments[6]!==undefined?arguments[6]:_verifier.OperationTypeEnum.communityRecovery;var verifierData=cachedVerifierData.find(function(it){return it.id===guardianOriginalInfo.verifierId;});var _ref7=verifierData||{},_ref7$name=_ref7.name,name=_ref7$name===void 0?'Portkey':_ref7$name,_ref7$imageUrl=_ref7.imageUrl,imageUrl=_ref7$imageUrl===void 0?'':_ref7$imageUrl;return Object.assign({},guardianOriginalInfo,{accountIdentifier:accountIdentifier,accountOriginalType:accountOriginalType,name:name,imageUrl:imageUrl,thirdPartyEmail:(_guardianOriginalInfo=guardianOriginalInfo.thirdPartyEmail)!=null?_guardianOriginalInfo:'',sendVerifyCodeParams:{type:guardianOriginalInfo.type,guardianIdentifier:guardianOriginalInfo.guardianIdentifier,verifierId:guardianOriginalInfo.verifierId,chainId:chainId,operationType:operationType},identifierHash:guardianOriginalInfo.identifierHash,verifiedDoc:verifiedData});};var requestSocialRecoveryOrRegister=exports.requestSocialRecoveryOrRegister=function(){var _ref8=(0,_asyncToGenerator2.default)(function*(params){yield(0,_utils.sleep)(500);var _AElfWeb3SDK$createNe=_wallet.AElfWeb3SDK.createNewWallet(),address=_AElfWeb3SDK$createNe.address,privateKey=_AElfWeb3SDK$createNe.privateKey,keyPair=_AElfWeb3SDK$createNe.keyPair;var publicKey=keyPair.getPublic('hex');var fromRecovery=params.fromRecovery,accountIdentifier=params.accountIdentifier,verifiedGuardians=params.verifiedGuardians,chainId=params.chainId,extraData=params.extraData;var sessionId='';if(fromRecovery){var _yield$NetworkControl,_yield$NetworkControl2;var socialRecoveryParams={loginGuardianIdentifier:accountIdentifier,manager:address,chainId:chainId,context:{clientId:address,requestId:(0,_utils.randomId)()},extraData:(0,_core.wrapExtraData)(extraData),guardiansApproved:verifiedGuardians.map(function(guardian){return{type:guardian.type,identifier:guardian.identifier,verifierId:guardian.verifierId,verificationDoc:guardian.verificationDoc,signature:guardian.signature};})};sessionId=(_yield$NetworkControl=(_yield$NetworkControl2=yield _controller.NetworkController.requestSocialRecovery(socialRecoveryParams))==null?void 0:_yield$NetworkControl2.sessionId)!=null?_yield$NetworkControl:'';}else{var _yield$NetworkControl3,_yield$NetworkControl4;var registerParams={chainId:chainId,loginGuardianIdentifier:accountIdentifier,verifierId:verifiedGuardians[0].verifierId,verificationDoc:verifiedGuardians[0].verificationDoc,signature:verifiedGuardians[0].signature,context:{clientId:address,requestId:(0,_utils.randomId)()},type:verifiedGuardians[0].type,manager:address,extraData:(0,_core.wrapExtraData)(extraData)};sessionId=(_yield$NetworkControl3=(_yield$NetworkControl4=yield _controller.NetworkController.requestRegister(registerParams))==null?void 0:_yield$NetworkControl4.sessionId)!=null?_yield$NetworkControl3:'';}if(!sessionId)throw new Error('network failure');return{sessionId:sessionId,privateKey:privateKey,publicKey:publicKey,address:address};});return function requestSocialRecoveryOrRegister(_x9){return _ref8.apply(this,arguments);};}();var getCaInfoByAccountIdentifierOrSessionId=exports.getCaInfoByAccountIdentifierOrSessionId=function(){var _ref9=(0,_asyncToGenerator2.default)(function*(originalChainId,accountIdentifier){var fromRecovery=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var sessionId=arguments.length>3?arguments[3]:undefined;if(accountIdentifier){var result=yield _controller.NetworkController.getGuardianInfo(accountIdentifier);return result;}else if(sessionId){var _result$items;var _result=fromRecovery?yield _controller.NetworkController.checkRegisterProcess(sessionId):yield _controller.NetworkController.checkSocialRecoveryProcess(sessionId);var item=_result==null?void 0:(_result$items=_result.items)==null?void 0:_result$items.find(function(it){return it.chainId===originalChainId;});if(!item)throw new Error('network failure');return item;}else{throw new Error('params error');}});return function getCaInfoByAccountIdentifierOrSessionId(_x10,_x11){return _ref9.apply(this,arguments);};}();var GuardianType=function(GuardianType){GuardianType[GuardianType["Email"]=0]="Email";GuardianType[GuardianType["Phone"]=1]="Phone";GuardianType[GuardianType["Google"]=2]="Google";GuardianType[GuardianType["Apple"]=3]="Apple";return GuardianType;}(GuardianType||{});var guardianTypeStrToEnum=exports.guardianTypeStrToEnum=function guardianTypeStrToEnum(guardianType){switch(guardianType){case'Email':return GuardianType.Email;case'Phone':return GuardianType.Phone;case'Google':return GuardianType.Google;case'Apple':return GuardianType.Apple;default:throw new Error('invalid guardian type');}};var guardianEnumToTypeStr=exports.guardianEnumToTypeStr=function guardianEnumToTypeStr(guardianType){switch(guardianType){case GuardianType.Email:return'Email';case GuardianType.Phone:return'Phone';case GuardianType.Google:return'Google';case GuardianType.Apple:return'Apple';default:throw new Error('invalid guardian type');}};