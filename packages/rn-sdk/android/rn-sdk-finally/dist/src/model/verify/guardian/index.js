var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=exports.INIT_TIME_OUT=exports.GuardianStatus=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _controller=require("../../../network/controller");var _react=require("react");var INIT_TIME_OUT=exports.INIT_TIME_OUT=60;var usePhoneOrEmailGuardian=function usePhoneOrEmailGuardian(config){var _config$verifySession;var _useState=(0,_react.useState)(config.alreadySent?GuardianStatus.SENT:GuardianStatus.INIT),_useState2=(0,_slicedToArray2.default)(_useState,2),status=_useState2[0],setStatus=_useState2[1];var _useState3=(0,_react.useState)(0),_useState4=(0,_slicedToArray2.default)(_useState3,2),countDown=_useState4[0],setCountDown=_useState4[1];var _useState5=(0,_react.useState)((_config$verifySession=config.verifySessionId)!=null?_config$verifySession:''),_useState6=(0,_slicedToArray2.default)(_useState5,2),verifierSessionId=_useState6[0],setVerifierSessionId=_useState6[1];var _useState7=(0,_react.useState)(null),_useState8=(0,_slicedToArray2.default)(_useState7,2),verifiedDoc=_useState8[0],setVerifiedDoc=_useState8[1];var sendVerifyCode=(0,_react.useCallback)(function(){var _ref=(0,_asyncToGenerator2.default)(function*(googleRecaptchaToken){if(status===GuardianStatus.VERIFIED){console.warn('Guardian already verified.');return false;}else if(countDown>0){console.warn('Please wait for the countdown to finish.');return false;}var needGoogleRecaptcha=yield _controller.NetworkController.isGoogleRecaptchaOpen(config.sendVerifyCodeParams.operationType);if(needGoogleRecaptcha&&!googleRecaptchaToken){console.warn('Need google recaptcha! Better check it before calling this function.');return false;}var result=yield _controller.NetworkController.sendVerifyCode(config.sendVerifyCodeParams,googleRecaptchaToken?{reCaptchaToken:googleRecaptchaToken}:{});if(result.verifierSessionId){setStatus(GuardianStatus.SENT);setVerifierSessionId(result.verifierSessionId);return true;}else{return false;}});return function(_x){return _ref.apply(this,arguments);};}(),[status,countDown,config.sendVerifyCodeParams]);var timer=(0,_react.useRef)(null);(0,_react.useEffect)(function(){startToCountDown();return function(){timer.current&&clearInterval(timer.current);};},[]);var startToCountDown=function startToCountDown(){var seconds=arguments.length>0&&arguments[0]!==undefined?arguments[0]:INIT_TIME_OUT;setCountDown(seconds);timer.current=setInterval(function(){setCountDown(function(prev){if(prev===0){timer.current&&clearInterval(timer.current);return 0;}else{return prev-1;}});},1000);};var checkVerifyCode=(0,_react.useCallback)(function(){var _ref2=(0,_asyncToGenerator2.default)(function*(verificationCode){if(status!==GuardianStatus.SENT){console.warn('You can not check verify code at this stage.');return null;}try{var result=yield _controller.NetworkController.checkVerifyCode(Object.assign({},config.sendVerifyCodeParams,{verificationCode:verificationCode,verifierSessionId:verifierSessionId}));if(result.verificationDoc&&result.signature){setStatus(GuardianStatus.VERIFIED);setVerifiedDoc(result);return result;}else{return result;}}catch(e){console.warn(e);return null;}});return function(_x2){return _ref2.apply(this,arguments);};}(),[status,config,verifierSessionId]);var getVerifiedGuardianDoc=(0,_react.useCallback)(function(){var _verifiedDoc$verifica,_verifiedDoc$signatur;return{type:config.accountOriginalType,identifier:config.sendVerifyCodeParams.guardianIdentifier,verifierId:config.sendVerifyCodeParams.verifierId,verificationDoc:(_verifiedDoc$verifica=verifiedDoc==null?void 0:verifiedDoc.verificationDoc)!=null?_verifiedDoc$verifica:'',signature:(_verifiedDoc$signatur=verifiedDoc==null?void 0:verifiedDoc.signature)!=null?_verifiedDoc$signatur:''};},[verifiedDoc,config]);return{status:status,countDown:countDown,sendVerifyCode:sendVerifyCode,checkVerifyCode:checkVerifyCode,getVerifiedGuardianDoc:getVerifiedGuardianDoc};};var GuardianStatus=exports.GuardianStatus=function(GuardianStatus){GuardianStatus[GuardianStatus["INIT"]=0]="INIT";GuardianStatus[GuardianStatus["SENT"]=1]="SENT";GuardianStatus[GuardianStatus["VERIFIED"]=2]="VERIFIED";return GuardianStatus;}({});var _default=exports.default=usePhoneOrEmailGuardian;