var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _react=_interopRequireWildcard(require("react"));var _reactNative=require("react-native");var _propTypes=_interopRequireDefault(require("prop-types"));var _xmldom=_interopRequireDefault(require("xmldom"));var _resolveAssetSource=_interopRequireDefault(require("react-native/Libraries/Image/resolveAssetSource"));var _reactNativeSvg=_interopRequireWildcard(require("react-native-svg"));var utils=_interopRequireWildcard(require("../../utils/svgUriUtils"));var _jsxFileName="/Users/fengfeiyang/aelf/portkey-wallet/packages/rn-sdk/android/rn-sdk-finally/src/components/Svg/SvgUri.js";function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap(),t=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r;})(e);}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&Object.prototype.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u];}return n.default=e,t&&t.set(e,n),n;}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=(0,_getPrototypeOf2.default)(Derived),result;if(hasNativeReflectConstruct){var NewTarget=(0,_getPrototypeOf2.default)(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return(0,_possibleConstructorReturn2.default)(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}var ACCEPTED_SVG_ELEMENTS=['svg','g','circle','path','rect','defs','line','linearGradient','radialGradient','stop','ellipse','polygon','polyline','text','tspan'];var SVG_ATTS=['viewBox','width','height'];var G_ATTS=['id'];var CIRCLE_ATTS=['cx','cy','r'];var PATH_ATTS=['d'];var RECT_ATTS=['width','height'];var LINE_ATTS=['x1','y1','x2','y2'];var LINEARG_ATTS=LINE_ATTS.concat(['id','gradientUnits']);var RADIALG_ATTS=CIRCLE_ATTS.concat(['id','gradientUnits']);var STOP_ATTS=['offset'];var ELLIPSE_ATTS=['cx','cy','rx','ry'];var TEXT_ATTS=['fontFamily','fontSize','fontWeight','textAnchor'];var POLYGON_ATTS=['points'];var POLYLINE_ATTS=['points'];var COMMON_ATTS=['fill','fillOpacity','stroke','strokeWidth','strokeOpacity','opacity','strokeLinecap','strokeLinejoin','strokeDasharray','strokeDashoffset','x','y','rotate','scale','origin','originX','originY','transform','clipPath'];var ind=0;function fixYPosition(y,node){if(node.attributes){var fontSizeAttr=Object.keys(node.attributes).find(function(a){return node.attributes[a].name==='font-size';});if(fontSizeAttr){return''+(parseFloat(y)-parseFloat(node.attributes[fontSizeAttr].value));}}if(!node.parentNode){return y;}return fixYPosition(y,node.parentNode);}var SvgUri=function(_Component){(0,_inherits2.default)(SvgUri,_Component);var _super=_createSuper(SvgUri);function SvgUri(){var _this;(0,_classCallCheck2.default)(this,SvgUri);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"state",{fill:_this.props.fill,svgXmlData:_this.props.svgXmlData,createSVGElement:_this.createSVGElement.bind((0,_assertThisInitialized2.default)(_this)),obtainComponentAtts:_this.obtainComponentAtts.bind((0,_assertThisInitialized2.default)(_this)),inspectNode:_this.inspectNode.bind((0,_assertThisInitialized2.default)(_this)),fetchSVGData:_this.fetchSVGData.bind((0,_assertThisInitialized2.default)(_this)),isComponentMounted:false});return _this;}(0,_createClass2.default)(SvgUri,[{key:"componentDidMount",value:function componentDidMount(){if(this.props.source){console.log(this.props);var source=(0,_resolveAssetSource.default)(this.props.source)||{};this.fetchSVGData(source.uri);}this.setState({isComponentMounted:true});this.isComponentMounted=true;}},{key:"UNSAFE_componentWillReceiveProps",value:function UNSAFE_componentWillReceiveProps(nextProps){if(nextProps.source){var source=(0,_resolveAssetSource.default)(nextProps.source)||{};var oldSource=(0,_resolveAssetSource.default)(this.props.source)||{};if(source.uri!==oldSource.uri){this.fetchSVGData(source.uri);}}if(nextProps.svgXmlData!==this.props.svgXmlData){this.setState({svgXmlData:nextProps.svgXmlData});}if(nextProps.fill!==this.props.fill){this.setState({fill:nextProps.fill});}}},{key:"componentWillUnmount",value:function componentWillUnmount(){this.isComponentMounted=false;}},{key:"fetchSVGData",value:function(){var _fetchSVGData=(0,_asyncToGenerator2.default)(function*(uri){var _this2=this;var responseXML=null,error=null;try{var response=yield fetch(uri);responseXML=yield response.text();}catch(e){error=e;console.error('ERROR SVG',e);}finally{if(this.isComponentMounted){this.setState({svgXmlData:responseXML},function(){var onLoad=_this2.props.onLoad;if(onLoad&&!error){onLoad();}});}}return responseXML;});function fetchSVGData(_x){return _fetchSVGData.apply(this,arguments);}return fetchSVGData;}()},{key:"trimElementChildren",value:function trimElementChildren(children){for(var child of children){if(typeof child==='string'){if(child.trim().length===0)children.splice(children.indexOf(child),1);}}}},{key:"createSVGElement",value:function createSVGElement(node,child){this.trimElementChildren(child);var componentAtts={};var i=ind++;switch(node.nodeName){case'svg':componentAtts=this.obtainComponentAtts(node,SVG_ATTS);if(this.props.width){componentAtts.width=this.props.width;}if(this.props.height){componentAtts.height=this.props.height;}return _react.default.createElement(_reactNativeSvg.default,(0,_extends2.default)({key:i},componentAtts,{__self:this,__source:{fileName:_jsxFileName,lineNumber:191,columnNumber:11}}),child);case'g':componentAtts=this.obtainComponentAtts(node,G_ATTS);return _react.default.createElement(_reactNativeSvg.G,(0,_extends2.default)({key:i},componentAtts,{__self:this,__source:{fileName:_jsxFileName,lineNumber:198,columnNumber:11}}),child);case'path':componentAtts=this.obtainComponentAtts(node,PATH_ATTS);return _react.default.createElement(_reactNativeSvg.Path,(0,_extends2.default)({key:i},componentAtts,{__self:this,__source:{fileName:_jsxFileName,lineNumber:205,columnNumber:11}}),child);case'circle':componentAtts=this.obtainComponentAtts(node,CIRCLE_ATTS);return _react.default.createElement(_reactNativeSvg.Circle,(0,_extends2.default)({key:i},componentAtts,{__self:this,__source:{fileName:_jsxFileName,lineNumber:212,columnNumber:11}}),child);case'rect':componentAtts=this.obtainComponentAtts(node,RECT_ATTS);return _react.default.createElement(_reactNativeSvg.Rect,(0,_extends2.default)({key:i},componentAtts,{__self:this,__source:{fileName:_jsxFileName,lineNumber:219,columnNumber:11}}),child);case'line':componentAtts=this.obtainComponentAtts(node,LINE_ATTS);return _react.default.createElement(_reactNativeSvg.Line,(0,_extends2.default)({key:i},componentAtts,{__self:this,__source:{fileName:_jsxFileName,lineNumber:226,columnNumber:11}}),child);case'defs':return _react.default.createElement(_reactNativeSvg.Defs,{key:i,__self:this,__source:{fileName:_jsxFileName,lineNumber:231,columnNumber:16}},child);case'linearGradient':componentAtts=this.obtainComponentAtts(node,LINEARG_ATTS);return _react.default.createElement(_reactNativeSvg.LinearGradient,(0,_extends2.default)({key:i},componentAtts,{__self:this,__source:{fileName:_jsxFileName,lineNumber:235,columnNumber:11}}),child);case'radialGradient':componentAtts=this.obtainComponentAtts(node,RADIALG_ATTS);return _react.default.createElement(_reactNativeSvg.RadialGradient,(0,_extends2.default)({key:i},componentAtts,{__self:this,__source:{fileName:_jsxFileName,lineNumber:242,columnNumber:11}}),child);case'stop':componentAtts=this.obtainComponentAtts(node,STOP_ATTS);return _react.default.createElement(_reactNativeSvg.Stop,(0,_extends2.default)({key:i},componentAtts,{__self:this,__source:{fileName:_jsxFileName,lineNumber:249,columnNumber:11}}),child);case'ellipse':componentAtts=this.obtainComponentAtts(node,ELLIPSE_ATTS);return _react.default.createElement(_reactNativeSvg.Ellipse,(0,_extends2.default)({key:i},componentAtts,{__self:this,__source:{fileName:_jsxFileName,lineNumber:256,columnNumber:11}}),child);case'polygon':componentAtts=this.obtainComponentAtts(node,POLYGON_ATTS);return _react.default.createElement(_reactNativeSvg.Polygon,(0,_extends2.default)({key:i},componentAtts,{__self:this,__source:{fileName:_jsxFileName,lineNumber:263,columnNumber:11}}),child);case'polyline':componentAtts=this.obtainComponentAtts(node,POLYLINE_ATTS);return _react.default.createElement(_reactNativeSvg.Polyline,(0,_extends2.default)({key:i},componentAtts,{__self:this,__source:{fileName:_jsxFileName,lineNumber:270,columnNumber:11}}),child);case'text':componentAtts=this.obtainComponentAtts(node,TEXT_ATTS);return _react.default.createElement(_reactNativeSvg.Text,(0,_extends2.default)({key:i},componentAtts,{__self:this,__source:{fileName:_jsxFileName,lineNumber:277,columnNumber:11}}),child);case'tspan':componentAtts=this.obtainComponentAtts(node,TEXT_ATTS);if(componentAtts.y){componentAtts.y=fixYPosition(componentAtts.y,node);}return _react.default.createElement(_reactNativeSvg.TSpan,(0,_extends2.default)({key:i},componentAtts,{__self:this,__source:{fileName:_jsxFileName,lineNumber:287,columnNumber:11}}),child);default:return null;}}},{key:"obtainComponentAtts",value:function obtainComponentAtts(_ref,enabledAttributes){var _this3=this;var attributes=_ref.attributes;var styleAtts={};if(this.state.fill&&this.props.fillAll){styleAtts.fill=this.state.fill;}Array.from(attributes).forEach(function(_ref2){var nodeName=_ref2.nodeName,nodeValue=_ref2.nodeValue;Object.assign(styleAtts,utils.transformStyle({nodeName:nodeName,nodeValue:nodeValue,fillProp:_this3.state.fill}));});var componentAtts=Array.from(attributes).map(utils.camelCaseNodeName).map(utils.removePixelsFromNodeValue).filter(utils.getEnabledAttributes(enabledAttributes.concat(COMMON_ATTS))).reduce(function(acc,_ref3){var nodeName=_ref3.nodeName,nodeValue=_ref3.nodeValue;acc[nodeName]=_this3.state.fill&&nodeName==='fill'&&nodeValue!=='none'?_this3.state.fill:nodeValue;return acc;},{});Object.assign(componentAtts,styleAtts);return componentAtts;}},{key:"inspectNode",value:function inspectNode(node){if(!ACCEPTED_SVG_ELEMENTS.includes(node.nodeName)){return _react.default.createElement(_reactNative.View,{key:Math.random(),__self:this,__source:{fileName:_jsxFileName,lineNumber:330,columnNumber:14}});}var arrayElements=[];if(node.childNodes&&node.childNodes.length>0){for(var i=0;i<node.childNodes.length;i++){var isTextValue=node.childNodes[i].nodeValue;if(isTextValue){arrayElements.push(node.childNodes[i].nodeValue);}else{var node1=this.inspectNode(node.childNodes[i]);if(node1!=null){arrayElements.push(node1);}}}}return this.createSVGElement(node,arrayElements);}},{key:"render",value:function render(){try{if(this.state.svgXmlData==null){return null;}var inputSVG=this.state.svgXmlData.substring(this.state.svgXmlData.indexOf('<svg '),this.state.svgXmlData.indexOf('</svg>')+6).replace(/<!-(.*?)->/g,'');var doc=new _xmldom.default.DOMParser().parseFromString(inputSVG);var rootSVG=this.inspectNode(doc.childNodes[0]);return _react.default.createElement(_reactNative.View,{style:this.props.style,__self:this,__source:{fileName:_jsxFileName,lineNumber:369,columnNumber:14}},rootSVG);}catch(e){console.error('ERROR SVG',e);return null;}}}]);return SvgUri;}(_react.Component);SvgUri.propTypes={style:_propTypes.default.oneOfType([_propTypes.default.object,_propTypes.default.array]),width:_propTypes.default.oneOfType([_propTypes.default.string,_propTypes.default.number]),height:_propTypes.default.oneOfType([_propTypes.default.string,_propTypes.default.number]),svgXmlData:_propTypes.default.string,source:_propTypes.default.any,fill:_propTypes.default.string,onLoad:_propTypes.default.func,fillAll:_propTypes.default.bool};var _default=exports.default=SvgUri;