var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.useVerifyEntry=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _utils=require("../../../packages/utils");var _ActionSheet=_interopRequireDefault(require("../../../components/ActionSheet"));var _Loading=_interopRequireDefault(require("../../../components/Loading"));var _VerifyHumanMachine=require("../../../components/VerifyHumanMachine");var _entries=require("../../../config/entries");var _global=require("../../global");var _core=require("../core");var _UseBaseContainer=_interopRequireDefault(require("../../container/UseBaseContainer"));var _verifier=require("../../../packages/types/verifier");var _controller=require("../../../network/controller");var _constants=require("../../../global/constants");var _react=require("react");var _types=require("../../../pages/Login/types");var _thirdPartyAccount=require("../third-party-account");var _atomic=require("./atomic");var _wallet=require("../../wallet");var useVerifyEntry=exports.useVerifyEntry=function useVerifyEntry(verifyConfig){var type=verifyConfig.type,entryName=verifyConfig.entryName,accountOriginalType=verifyConfig.accountOriginalType,setErrorMessage=verifyConfig.setErrorMessage,verifyAccountIdentifier=verifyConfig.verifyAccountIdentifier;var _useThirdPartyVerifyA=(0,_atomic.useThirdPartyVerifyAtomic)(),googleLoginAdapter=_useThirdPartyVerifyA.googleLoginAdapter,appleLoginAdapter=_useThirdPartyVerifyA.appleLoginAdapter;var _useBaseContainer=(0,_UseBaseContainer.default)({entryName:entryName}),navigateForResult=_useBaseContainer.navigateForResult,onFinish=_useBaseContainer.onFinish;var isGoogleRecaptchaOpen=function(){var _ref=(0,_asyncToGenerator2.default)(function*(){return yield _controller.NetworkController.isGoogleRecaptchaOpen(_verifier.OperationTypeEnum.register);});return function isGoogleRecaptchaOpen(){return _ref.apply(this,arguments);};}();var verifyEntry=function verifyEntry(accountIdentifier,thirdPartyAccountInfo){if(type===_types.PageType.login){onPageLogin(accountIdentifier,thirdPartyAccountInfo);}else if(type===_types.PageType.signup){onPageSignUp(accountIdentifier,thirdPartyAccountInfo);}};var sendVerifyCode=function(){var _ref2=(0,_asyncToGenerator2.default)(function*(guardianConfig,reCaptchaToken){if(!guardianConfig)throw new Error('guardianConfig is not defined');var needGoogleRecaptcha=yield _controller.NetworkController.isGoogleRecaptchaOpen(guardianConfig.sendVerifyCodeParams.operationType);if(needGoogleRecaptcha&&!reCaptchaToken){console.warn('Need google recaptcha! Better check it before calling this function.');return null;}var result=yield _controller.NetworkController.sendVerifyCode(guardianConfig.sendVerifyCodeParams,reCaptchaToken?{reCaptchaToken:reCaptchaToken}:{});if(result!=null&&result.verifierSessionId){return result;}else{return null;}});return function sendVerifyCode(_x,_x2){return _ref2.apply(this,arguments);};}();var navigateToGuardianPage=(0,_react.useCallback)(function(config,callback){navigateForResult(_entries.PortkeyEntries.VERIFIER_DETAIL_ENTRY,{params:{deliveredGuardianInfo:JSON.stringify(config),operationType:type===_types.PageType.login?_verifier.OperationTypeEnum.communityRecovery:_verifier.OperationTypeEnum.register}},function(res){_Loading.default.hide();var data=res.data;callback(data!=null&&data.verifiedData?JSON.parse(data.verifiedData):null);});},[navigateForResult]);var thirdPartyLogin=function(){var _ref3=(0,_asyncToGenerator2.default)(function*(thirdPartyLoginType){try{_Loading.default.show();var _thirdPartyAccountInfo=thirdPartyLoginType==='google'?yield googleLoginAdapter():yield appleLoginAdapter();if(!(_thirdPartyAccountInfo!=null&&_thirdPartyAccountInfo.accountIdentifier)){throw new Error('login failed.');}var _accountIdentifier=_thirdPartyAccountInfo.accountIdentifier;var accountCheckResult=yield(0,_global.attemptAccountCheck)(_accountIdentifier);var thirdPartyInfo=(0,_thirdPartyAccount.isAppleLogin)(_thirdPartyAccountInfo)?{apple:_thirdPartyAccountInfo}:{google:_thirdPartyAccountInfo};if(accountCheckResult.hasRegistered){if(type===_types.PageType.signup){_ActionSheet.default.alert({title:'Continue with this account?',message:"This account already exists. Click \"Confirm\" to log in.",buttons:[{title:'Cancel',type:'outline'},{title:'Confirm',onPress:function onPress(){dealWithSignIn(_accountIdentifier,thirdPartyInfo);}}]});}else{dealWithSignIn(_accountIdentifier,thirdPartyInfo);}}else{if(type===_types.PageType.login){_ActionSheet.default.alert({title:'Continue with this account?',message:"This account has not been registered yet. Click \"Confirm\" to complete the registration.",buttons:[{title:'Cancel',type:'outline'},{title:'Confirm',onPress:function onPress(){dealWithSignUp(_accountIdentifier,thirdPartyInfo);}}]});}else{dealWithSignUp(_accountIdentifier,thirdPartyInfo);}}}catch(e){console.error(e);setErrorMessage('login failed.');}finally{_Loading.default.hide();}});return function thirdPartyLogin(_x3){return _ref3.apply(this,arguments);};}();var handleGuardianVerifyPage=function(){var _ref4=(0,_asyncToGenerator2.default)(function*(guardianConfig,alreadySent){if(!guardianConfig){console.error('guardianConfig is not defined.');return null;}return new Promise(function(resolve){navigateToGuardianPage(Object.assign({},guardianConfig,{alreadySent:alreadySent!=null?alreadySent:false}),function(result){if(result){resolve(result);}else{resolve(null);}});});});return function handleGuardianVerifyPage(_x4,_x5){return _ref4.apply(this,arguments);};}();var onPageLogin=function(){var _ref5=(0,_asyncToGenerator2.default)(function*(accountIdentifier,thirdPartyAccountInfo){if(verifyAccountIdentifier){var message=verifyAccountIdentifier(accountIdentifier)||undefined;setErrorMessage(message);if(message)return;}var loadingKey=_Loading.default.show();try{var accountCheckResult=yield(0,_global.attemptAccountCheck)(accountIdentifier);if(accountCheckResult.hasRegistered){dealWithSignIn(accountIdentifier,thirdPartyAccountInfo);}else{_ActionSheet.default.alert({title:'Continue with this account?',message:"This account has not been registered yet. Click \"Confirm\" to complete the registration.",buttons:[{title:'Cancel',type:'outline'},{title:'Confirm',onPress:function onPress(){dealWithSignUp(accountIdentifier,thirdPartyAccountInfo);}}]});}}catch(error){setErrorMessage((0,_utils.handleErrorMessage)(error));_Loading.default.hide(loadingKey);}_Loading.default.hide(loadingKey);});return function onPageLogin(_x6,_x7){return _ref5.apply(this,arguments);};}();var onPageSignUp=function(){var _ref6=(0,_asyncToGenerator2.default)(function*(accountIdentifier,thirdPartyAccountInfo){if(verifyAccountIdentifier){var message=verifyAccountIdentifier(accountIdentifier)||undefined;setErrorMessage(message);if(message)return;}var loadingKey=_Loading.default.show();try{var accountCheckResult=yield(0,_global.attemptAccountCheck)(accountIdentifier);if(accountCheckResult.hasRegistered){_ActionSheet.default.alert({title:'Continue with this account?',message:"This account already exists. Click \"Confirm\" to log in.",buttons:[{title:'Cancel',type:'outline'},{title:'Confirm',onPress:function onPress(){dealWithSignIn(accountIdentifier);}}]});}else{dealWithSignUp(accountIdentifier,thirdPartyAccountInfo);}}catch(error){setErrorMessage((0,_utils.handleErrorMessage)(error));_Loading.default.hide(loadingKey);}_Loading.default.hide(loadingKey);});return function onPageSignUp(_x8,_x9){return _ref6.apply(this,arguments);};}();var dealWithSignIn=function(){var _ref7=(0,_asyncToGenerator2.default)(function*(accountIdentifier,thirdPartyAccountInfo){_Loading.default.show();try{var _signInPageData$guard;var signInPageData=yield(0,_global.getSocialRecoveryPageData)(accountIdentifier!=null?accountIdentifier:'',accountOriginalType,thirdPartyAccountInfo);_Loading.default.hide();if((signInPageData==null?void 0:(_signInPageData$guard=signInPageData.guardians)==null?void 0:_signInPageData$guard.length)>0){navigateForResult(_entries.PortkeyEntries.GUARDIAN_APPROVAL_ENTRY,{params:{deliveredGuardianListInfo:JSON.stringify(signInPageData)}},function(){var _ref8=(0,_asyncToGenerator2.default)(function*(res){var _ref9=res||{},data=_ref9.data;var _ref10=data||{},isVerified=_ref10.isVerified;if(!isVerified){setErrorMessage('verification failed, please try again.');return;}else{var walletInfo=yield(0,_wallet.getUnlockedWallet)();onFinish({status:'success',data:{finished:true,walletInfo:walletInfo}});}});return function(_x12){return _ref8.apply(this,arguments);};}());}else{setErrorMessage('network fail.');_Loading.default.hide();}}catch(e){setErrorMessage((0,_utils.handleErrorMessage)(e));_Loading.default.hide();}});return function dealWithSignIn(_x10,_x11){return _ref7.apply(this,arguments);};}();var dealWithSetPin=function dealWithSetPin(afterVerifiedData){navigateForResult(_entries.PortkeyEntries.SET_PIN,{params:{deliveredSetPinInfo:typeof afterVerifiedData==='string'?afterVerifiedData:JSON.stringify(afterVerifiedData)}},function(){var _ref11=(0,_asyncToGenerator2.default)(function*(res){var data=res.data;if(data!=null&&data.finished){var walletInfo=yield(0,_wallet.getUnlockedWallet)();onFinish({status:'success',data:{finished:true,walletInfo:walletInfo}});}});return function(_x13){return _ref11.apply(this,arguments);};}());};var getSignUpVerifiedData=function(){var _ref12=(0,_asyncToGenerator2.default)(function*(accountIdentifier,config,verifiedData){return{normalVerifyPathInfo:{fromRecovery:false,accountIdentifier:accountIdentifier,chainId:yield _constants.PortkeyConfig.currChainId(),verifiedGuardians:[{type:(0,_global.guardianTypeStrToEnum)(config.sendVerifyCodeParams.type),identifier:accountIdentifier,verifierId:config.sendVerifyCodeParams.verifierId,verificationDoc:verifiedData.verificationDoc,signature:verifiedData.signature}]}};});return function getSignUpVerifiedData(_x14,_x15,_x16){return _ref12.apply(this,arguments);};}();var dealWithSignUp=function(){var _ref13=(0,_asyncToGenerator2.default)(function*(accountIdentifier,thirdPartyAccountInfo){if(!accountIdentifier)throw new Error('accountIdentifier is empty');_Loading.default.show({text:'Assigning a verifier on-chain...'});var _ref14=thirdPartyAccountInfo||{},google=_ref14.google,apple=_ref14.apple;var useThirdPartyFunction=google||apple;try{if(useThirdPartyFunction){var _apple$identityToken;var recommendedGuardian=yield _controller.NetworkController.getRecommendedGuardian();_Loading.default.hide();var _ref15=recommendedGuardian||{},id=_ref15.id;if(!id){throw new Error('network failure');}var guardianResult=google?yield _controller.NetworkController.verifyGoogleGuardianInfo({verifierId:id,accessToken:google.accessToken,operationType:_verifier.OperationTypeEnum.register,chainId:yield _constants.PortkeyConfig.currChainId()}):yield _controller.NetworkController.verifyAppleGuardianInfo({id:accountIdentifier,verifierId:id,accessToken:(_apple$identityToken=apple==null?void 0:apple.identityToken)!=null?_apple$identityToken:'',operationType:_verifier.OperationTypeEnum.register,chainId:yield _constants.PortkeyConfig.currChainId()});if(!guardianResult){throw new Error('network failure');}_Loading.default.hide();dealWithSetPin({normalVerifyPathInfo:{fromRecovery:false,accountIdentifier:accountIdentifier,chainId:yield _constants.PortkeyConfig.currChainId(),verifiedGuardians:[{type:(0,_global.guardianTypeStrToEnum)(google?'Google':'Apple'),identifier:accountIdentifier,verifierId:id,verificationDoc:guardianResult.verificationDoc,signature:guardianResult.signature}]}});}else{var _pageData$guardianCon,_pageData$guardianCon2;var pageData=yield(0,_global.getRegisterPageData)(accountIdentifier,accountOriginalType,navigateToGuardianPage);if(!pageData.guardianConfig){throw new Error('network failure');}_Loading.default.hide();_ActionSheet.default.alert({title:'',message:((_pageData$guardianCon=(_pageData$guardianCon2=pageData.guardianConfig)==null?void 0:_pageData$guardianCon2.name)!=null?_pageData$guardianCon:'Portkey')+" will send a verification code to "+accountIdentifier+" to verify your "+(accountOriginalType===_core.AccountOriginalType.Email?'email':'phone number')+".",buttons:[{title:'Cancel',type:'outline'},{title:'Confirm',onPress:function(){var _onPress=(0,_asyncToGenerator2.default)(function*(){try{_Loading.default.show();if(!pageData.guardianConfig)throw new Error('network failure');var needRecaptcha=yield isGoogleRecaptchaOpen();var token;if(needRecaptcha){token=yield(0,_VerifyHumanMachine.verifyHumanMachine)('en');}var sendResult=yield sendVerifyCode(pageData.guardianConfig,token);_Loading.default.hide();if(sendResult){var _guardianResult=yield handleGuardianVerifyPage(Object.assign({},pageData.guardianConfig,{verifySessionId:sendResult.verifierSessionId}),true);if(!_guardianResult){setErrorMessage('guardian verify failed, please try again.');return;}else{dealWithSetPin(yield getSignUpVerifiedData(accountIdentifier,pageData.guardianConfig,_guardianResult));}}else{setErrorMessage('network fail.');_Loading.default.hide();}}catch(e){setErrorMessage((0,_utils.handleErrorMessage)(e));_Loading.default.hide();}});function onPress(){return _onPress.apply(this,arguments);}return onPress;}()}]});}}catch(e){setErrorMessage((0,_utils.handleErrorMessage)(e));_Loading.default.hide();}});return function dealWithSignUp(_x17,_x18){return _ref13.apply(this,arguments);};}();return{verifyEntry:verifyEntry,thirdPartyLogin:thirdPartyLogin};};