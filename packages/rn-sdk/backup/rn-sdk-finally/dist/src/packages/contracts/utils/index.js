var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.encodedParams=void 0;exports.getContractBasic=getContractBasic;exports.getContractMethods=getContractMethods;exports.getServicesFromFileDescriptors=exports.getFileDescriptorsSet=void 0;exports.getTxResult=getTxResult;exports.handleContractError=handleContractError;exports.handleContractParams=void 0;exports.handleFunctionName=handleFunctionName;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _ContractBasic=require("./ContractBasic");var _aelfSdk=_interopRequireDefault(require("aelf-sdk"));var _aelf=require("../../utils/aelf");var _utils=require("../../utils");var methodsMap={};var contractMap={};function getContractBasic(_x){return _getContractBasic.apply(this,arguments);}function _getContractBasic(){_getContractBasic=(0,_asyncToGenerator2.default)(function*(_ref){var contractAddress=_ref.contractAddress,aelfInstance=_ref.aelfInstance,account=_ref.account,rpcUrl=_ref.rpcUrl;var instance=aelfInstance;if(rpcUrl)instance=(0,_aelf.getAelfInstance)(rpcUrl);if(!instance)throw new Error('Get instance error');var key=contractAddress+account.address+instance.currentProvider.host;if(!contractMap[key]){var aelfContract=yield instance.chain.contractAt(contractAddress,account);contractMap[key]=new _ContractBasic.ContractBasic({aelfContract:aelfContract,contractAddress:contractAddress,aelfInstance:instance,rpcUrl:instance.currentProvider.host});}return contractMap[key];});return _getContractBasic.apply(this,arguments);}function getTxResult(_x2,_x3){return _getTxResult.apply(this,arguments);}function _getTxResult(){_getTxResult=(0,_asyncToGenerator2.default)(function*(instance,TransactionId){var reGetCount=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var notExistedReGetCount=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var txFun=instance.chain.getTxResult;var txResult=yield txFun(TransactionId);console.log(txResult,reGetCount,'====txResult');if(txResult.error&&txResult.errorMessage){throw Error(txResult.errorMessage.message||txResult.errorMessage.Message);}var result=(txResult==null?void 0:txResult.result)||txResult;if(!result){throw Error('Can not get transaction result.');}var lowerCaseStatus=result.Status.toLowerCase();if(lowerCaseStatus==='notexisted'){if(notExistedReGetCount>5)return result;yield(0,_utils.sleep)(1000);notExistedReGetCount++;reGetCount++;return getTxResult(instance,TransactionId,reGetCount,notExistedReGetCount);}if(lowerCaseStatus==='pending'||lowerCaseStatus==='pending_validation'){if(reGetCount>20)return result;yield(0,_utils.sleep)(1000);reGetCount++;return getTxResult(instance,TransactionId,reGetCount,notExistedReGetCount);}if(lowerCaseStatus==='mined'){return result;}throw Error(result.Error||"Transaction: "+result.Status);});return _getTxResult.apply(this,arguments);}function handleContractError(error,req){var _req$error,_req$error$message,_req$errorMessage,_req$error2,_req$error2$message;if(typeof error==='string')return{message:error};if(error!=null&&error.message)return error;if(error.Error){return{message:error.Error.Details||error.Error.Message||error.Error||error.Status,code:error.Error.Code};}return{code:(req==null?void 0:(_req$error=req.error)==null?void 0:(_req$error$message=_req$error.message)==null?void 0:_req$error$message.Code)||(req==null?void 0:req.error),message:(req==null?void 0:(_req$errorMessage=req.errorMessage)==null?void 0:_req$errorMessage.message)||(req==null?void 0:(_req$error2=req.error)==null?void 0:(_req$error2$message=_req$error2.message)==null?void 0:_req$error2$message.Message)};}function handleFunctionName(functionName){return functionName.replace(functionName[0],functionName[0].toLocaleUpperCase());}var getServicesFromFileDescriptors=exports.getServicesFromFileDescriptors=function getServicesFromFileDescriptors(descriptors){var root=_aelfSdk.default.pbjs.Root.fromDescriptor(descriptors,'proto3').resolveAll();return descriptors.file.filter(function(f){return f.service.length>0;}).map(function(f){var sn=f.service[0].name;var fullName=f.package?f.package+"."+sn:sn;return root.lookupService(fullName);});};var getFileDescriptorsSet=exports.getFileDescriptorsSet=function(){var _ref2=(0,_asyncToGenerator2.default)(function*(instance,contractAddress){var fds=yield instance.chain.getContractFileDescriptorSet(contractAddress);return getServicesFromFileDescriptors(fds);});return function getFileDescriptorsSet(_x4,_x5){return _ref2.apply(this,arguments);};}();function getContractMethods(_x6,_x7){return _getContractMethods.apply(this,arguments);}function _getContractMethods(){_getContractMethods=(0,_asyncToGenerator2.default)(function*(instance,address){var key=instance.currentProvider.host+address;if(!methodsMap[key]){var methods=yield getFileDescriptorsSet(instance,address);var _obj={};Object.keys(methods).forEach(function(key){var service=methods[key];Object.keys(service.methods).forEach(function(key){var method=service.methods[key].resolve();_obj[method.name]=method.resolvedRequestType;});});methodsMap[key]=_obj;}return methodsMap[key];});return _getContractMethods.apply(this,arguments);}var encodedParams=exports.encodedParams=function(){var _ref3=(0,_asyncToGenerator2.default)(function*(inputType,params){var input=_aelfSdk.default.utils.transform.transformMapToArray(inputType,params);input=_aelfSdk.default.utils.transform.transform(inputType,input,_aelfSdk.default.utils.transform.INPUT_TRANSFORMERS);var message=inputType.fromObject(input);return inputType.encode(message).finish();});return function encodedParams(_x8,_x9){return _ref3.apply(this,arguments);};}();var handleContractParams=exports.handleContractParams=function(){var _ref5=(0,_asyncToGenerator2.default)(function*(_ref4){var paramsOption=_ref4.paramsOption,functionName=_ref4.functionName,instance=_ref4.instance;if(functionName==='ManagerForwardCall'){var _ref6=paramsOption||{},contractAddress=_ref6.contractAddress,methodName=_ref6.methodName,args=_ref6.args,caHash=_ref6.caHash;if(!(contractAddress&&methodName&&args&&caHash)){throw new Error('ManagerForwardCall parameter is missing');}var methods=yield getContractMethods(instance,paramsOption.contractAddress);var inputType=methods[paramsOption.methodName];if(!inputType)throw new Error("Contract "+contractAddress+" does not exist "+methodName);var _args=yield encodedParams(inputType,args);return{caHash:caHash,contractAddress:contractAddress,methodName:methodName,args:_args};}return paramsOption;});return function handleContractParams(_x10){return _ref5.apply(this,arguments);};}();