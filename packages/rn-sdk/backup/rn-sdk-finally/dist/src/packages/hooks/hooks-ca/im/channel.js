var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.useSendChannelMessage=exports.useSearchChannel=exports.usePinChannel=exports.useMuteChannel=exports.useIsStranger=exports.useHideChannel=exports.useDeleteMessage=exports.useCurrentChannelMessageListNetMap=exports.useCurrentChannelMessageList=exports.useCheckIsStranger=exports.useChannel=exports.useAddStranger=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _im=_interopRequireWildcard(require("../../../im"));var _react=require("react");var _utils=require("../../../utils");var _im2=require("../../../constants/constants-ca/im");var _network=require("../network");var _=require("../..");var _actions=require("packages/types/store-ca/im/actions");var _index=require("./index");var _s=_interopRequireWildcard(require("../../../utils/s3"));var _utils2=require("../../../im/utils");var _contact=require("../contact");var _apiDid=require("../../../api/api-did");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap(),t=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r;})(e);}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&Object.prototype.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u];}return n.default=e,t&&t.set(e,n),n;}var useCurrentChannelMessageListNetMap=exports.useCurrentChannelMessageListNetMap=function useCurrentChannelMessageListNetMap(){var _useCurrentNetworkInf=(0,_network.useCurrentNetworkInfo)(),networkType=_useCurrentNetworkInf.networkType;var channelMessageListNetMap=(0,_index.useIMChannelMessageListNetMapState)();return(0,_react.useMemo)(function(){return channelMessageListNetMap==null?void 0:channelMessageListNetMap[networkType];},[channelMessageListNetMap,networkType]);};var useCurrentChannelMessageList=exports.useCurrentChannelMessageList=function useCurrentChannelMessageList(channelId){var channelMessageListNetMap=useCurrentChannelMessageListNetMap();return(0,_react.useMemo)(function(){return(channelMessageListNetMap==null?void 0:channelMessageListNetMap[channelId])||[];},[channelId,channelMessageListNetMap]);};var useIsStranger=exports.useIsStranger=function useIsStranger(relationId){var contactRelationIdMap=(0,_contact.useContactRelationIdMap)();return(0,_react.useMemo)(function(){return!(contactRelationIdMap!=null&&contactRelationIdMap[relationId]);},[contactRelationIdMap,relationId]);};var useSendChannelMessage=exports.useSendChannelMessage=function useSendChannelMessage(){var dispatch=(0,_.useAppCommonDispatch)();var _useCurrentNetworkInf2=(0,_network.useCurrentNetworkInfo)(),networkType=_useCurrentNetworkInf2.networkType;var relationId=(0,_index.useRelationId)();var sendChannelMessage=(0,_react.useCallback)(function(){var _ref=(0,_asyncToGenerator2.default)(function*(channelId,content){var type=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'TEXT';if(!relationId){throw new Error('No user info');}var uuid=(0,_utils.randomId)();var msgParams={channelUuid:channelId,type:type,content:content,sendUuid:relationId+"-"+channelId+"-"+Date.now()+"-"+uuid};var msgObj=(0,_utils2.messageParser)(Object.assign({},msgParams,{from:relationId,fromAvatar:'',fromName:'',createAt:""+Date.now()}));dispatch((0,_actions.addChannelMessage)({network:networkType,channelId:channelId,message:msgObj}));try{var result=yield _im.default.service.sendMessage(msgParams);dispatch((0,_actions.updateChannelAttribute)({network:networkType,channelId:channelId,value:{lastMessageType:msgObj.type,lastMessageContent:msgObj.content,lastPostAt:msgObj.createAt}}));dispatch((0,_actions.updateChannelMessageAttribute)({network:networkType,channelId:channelId,sendUuid:msgObj.sendUuid,value:{id:result.data.id}}));}catch(error){console.log('error',error);throw error;}});return function(_x,_x2){return _ref.apply(this,arguments);};}(),[dispatch,networkType,relationId]);var sendChannelImageByS3Result=(0,_react.useCallback)(function(){var _ref2=(0,_asyncToGenerator2.default)(function*(channelId,s3Result){try{var _getThumbSize=(0,_s.getThumbSize)(s3Result.width,s3Result.height),thumbWidth=_getThumbSize.thumbWidth,thumbHeight=_getThumbSize.thumbHeight;var p1Url=encodeURIComponent(s3Result.url);var p1Key=s3Result.key;var p2Url=p1Url;var p2Key=p1Key;try{var thumbResult=yield _apiDid.request.im.getImageThumb({params:{imageUrl:s3Result.url,width:thumbWidth,height:thumbHeight}});if(thumbResult!=null&&thumbResult.thumbnailUrl){p2Url=encodeURIComponent(thumbResult.thumbnailUrl);p2Key='';}}catch(error){console.log('sendChannelImage: error',error);}var content="type:image;action:localImage;p1(Text):"+p1Url+",p2(Text):"+p1Key+",p3(Text):"+p2Url+",p4(Text):"+p2Key+",p5(Text):"+s3Result.width+",p6(Text):"+s3Result.height;return sendChannelMessage(channelId,content,'IMAGE');}catch(error){console.log('sendChannelImage: error',error);throw error;}});return function(_x3,_x4){return _ref2.apply(this,arguments);};}(),[sendChannelMessage]);var sendChannelImage=(0,_react.useCallback)(function(){var _ref3=(0,_asyncToGenerator2.default)(function*(channelId,file){try{var s3Result=yield _s.default.uploadFile({body:file.body,suffix:file.suffix});yield sendChannelImageByS3Result(channelId,Object.assign({},s3Result,file));return s3Result;}catch(error){console.log('sendChannelImage: error',error);throw error;}});return function(_x5,_x6){return _ref3.apply(this,arguments);};}(),[sendChannelImageByS3Result]);return{sendChannelMessage:sendChannelMessage,sendChannelImage:sendChannelImage,sendChannelImageByS3Result:sendChannelImageByS3Result};};var useDeleteMessage=exports.useDeleteMessage=function useDeleteMessage(channelId){var _useCurrentNetworkInf3=(0,_network.useCurrentNetworkInfo)(),networkType=_useCurrentNetworkInf3.networkType;var dispatch=(0,_.useAppCommonDispatch)();var list=useCurrentChannelMessageList(channelId);var listRef=(0,_.useLatestRef)(list);return(0,_react.useCallback)(function(){var _ref4=(0,_asyncToGenerator2.default)(function*(id){if(!id){throw new Error('no message id');}try{yield _im.default.service.deleteMessage({id:id});var _list=listRef.current||[];if(_list.length<=0)return;var latestMsg=_list[_list.length-1];if(latestMsg.id===id){if(_list.length<=1){dispatch((0,_actions.updateChannelAttribute)({network:networkType,channelId:channelId,value:{lastMessageType:null,lastMessageContent:null,lastPostAt:null}}));}else{var nextMsg=_list[_list.length-2];dispatch((0,_actions.updateChannelAttribute)({network:networkType,channelId:channelId,value:{lastMessageType:nextMsg.type,lastMessageContent:nextMsg.content}}));}}dispatch((0,_actions.deleteChannelMessage)({network:networkType,channelId:channelId,id:id}));}catch(error){console.log('deleteMessage: error',error);throw error;}});return function(_x7){return _ref4.apply(this,arguments);};}(),[channelId,dispatch,listRef,networkType]);};var useChannel=exports.useChannel=function useChannel(channelId){var _useCurrentNetworkInf4=(0,_network.useCurrentNetworkInfo)(),networkType=_useCurrentNetworkInf4.networkType;var dispatch=(0,_.useAppCommonDispatch)();var relationId=(0,_index.useRelationId)();var list=useCurrentChannelMessageList(channelId);var listRef=(0,_.useLatestRef)(list);var muteChannel=useMuteChannel();var pinChannel=usePinChannel();var hideChannel=useHideChannel();var _useSendChannelMessag=useSendChannelMessage(),sendChannelMessage=_useSendChannelMessag.sendChannelMessage,sendChannelImage=_useSendChannelMessag.sendChannelImage;var deleteMessage=useDeleteMessage(channelId);var info=(0,_index.useChannelItemInfo)(channelId);var isStranger=useIsStranger((info==null?void 0:info.toRelationId)||'');var _useState=(0,_react.useState)(false),_useState2=(0,_slicedToArray2.default)(_useState,2),hasNext=_useState2[0],setHasNext=_useState2[1];var _useState3=(0,_react.useState)(false),_useState4=(0,_slicedToArray2.default)(_useState3,2),loading=_useState4[0],setLoading=_useState4[1];var isNextLoading=(0,_react.useRef)(false);var next=(0,_react.useCallback)((0,_asyncToGenerator2.default)(function*(){var isInit=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(isNextLoading.current)return;isNextLoading.current=true;var maxCreateAt=Date.now();if(!isInit){var _list2=listRef.current;var lastMsg=_list2[0];maxCreateAt=lastMsg!=null&&lastMsg.createAt?Number(lastMsg==null?void 0:lastMsg.createAt):Date.now();}setLoading(true);try{var _result$data;var result=yield _im.default.service.getMessageList({channelUuid:channelId,maxCreateAt:maxCreateAt,limit:_im2.MESSAGE_LIST_LIMIT});var length=((_result$data=result.data)==null?void 0:_result$data.length)||0;var hasNextValue=length>=_im2.MESSAGE_LIST_LIMIT;setHasNext(hasNextValue);var _list3=result.data.map(function(item){return _im.utils.messageParser(item);});if(isInit){dispatch((0,_actions.setChannelMessageList)({network:networkType,channelId:channelId,list:_list3}));_im.default.service.readMessage({channelUuid:channelId,total:9999}).then(function(){_im.default.refreshMessageCount();dispatch((0,_actions.updateChannelAttribute)({network:networkType,channelId:channelId,value:{unreadMessageCount:0}}));});}else{dispatch((0,_actions.nextChannelMessageList)({network:networkType,channelId:channelId,list:_list3}));}}catch(error){console.log('next: error',error);throw error;}finally{setLoading(false);isNextLoading.current=false;}}),[channelId,dispatch,listRef,networkType]);var init=(0,_react.useCallback)(function(){return next(true);},[next]);var connectHandler=(0,_react.useCallback)(function(){var _ref6=(0,_asyncToGenerator2.default)(function*(e){console.log('connectHandler',e);try{yield init();}catch(error){console.log('connectHandler:init error',error);}});return function(_x8){return _ref6.apply(this,arguments);};}(),[init]);var connectHandlerRef=(0,_react.useRef)(connectHandler);connectHandlerRef.current=connectHandler;var read=(0,_react.useCallback)(function(){_im.default.service.readMessage({channelUuid:channelId,total:9999});},[channelId]);var updateList=(0,_react.useCallback)(function(e){var rawMsg=e['im-message'];if(rawMsg.channelUuid!==channelId)return;var parsedMsg=_im.utils.messageParser(rawMsg);dispatch((0,_actions.addChannelMessage)({network:networkType,channelId:channelId,message:parsedMsg}));read();dispatch((0,_actions.updateChannelAttribute)({network:networkType,channelId:channelId,value:{lastMessageType:parsedMsg.type,lastMessageContent:parsedMsg.content,lastPostAt:parsedMsg.createAt}}));console.log('result',parsedMsg);},[channelId,dispatch,networkType,read]);var updateListRef=(0,_react.useRef)(updateList);updateListRef.current=updateList;(0,_react.useEffect)(function(){var _im$registerChannelMs=_im.default.registerChannelMsgObserver(channelId,function(e){updateListRef.current(e);}),removeMsgObserver=_im$registerChannelMs.remove;var _im$registerConnectOb=_im.default.registerConnectObserver(function(e){connectHandlerRef.current(e);}),removeConnectObserver=_im$registerConnectOb.remove;if(relationId){_im.default.service.triggerMessageEvent({channelUuid:channelId,fromRelationId:relationId,action:_im.TriggerMessageEventActionEnum.ENTER_CHANNEL});}return function(){removeMsgObserver();removeConnectObserver();if(relationId){_im.default.service.triggerMessageEvent({channelUuid:channelId,fromRelationId:relationId,action:_im.TriggerMessageEventActionEnum.EXIT_CHANNEL});}};},[]);var mute=(0,_react.useCallback)(function(){var _ref7=(0,_asyncToGenerator2.default)(function*(value){return muteChannel(channelId,value,false);});return function(_x9){return _ref7.apply(this,arguments);};}(),[channelId,muteChannel]);var pin=(0,_react.useCallback)(function(){var _ref8=(0,_asyncToGenerator2.default)(function*(value){return pinChannel(channelId,value);});return function(_x10){return _ref8.apply(this,arguments);};}(),[channelId,pinChannel]);var exit=(0,_react.useCallback)((0,_asyncToGenerator2.default)(function*(){return hideChannel(channelId);}),[channelId,hideChannel]);var sendMessage=(0,_react.useCallback)(function(content,type){return sendChannelMessage(channelId,content,type);},[channelId,sendChannelMessage]);var sendImage=(0,_react.useCallback)(function(file){return sendChannelImage(channelId,file);},[channelId,sendChannelImage]);return{info:info,list:list,next:next,hasNext:hasNext,sendMessage:sendMessage,init:init,loading:loading,mute:mute,pin:pin,exit:exit,deleteMessage:deleteMessage,sendImage:sendImage,isStranger:isStranger};};var useMuteChannel=exports.useMuteChannel=function useMuteChannel(){var _useCurrentNetworkInf5=(0,_network.useCurrentNetworkInfo)(),networkType=_useCurrentNetworkInf5.networkType;var dispatch=(0,_.useAppCommonDispatch)();var mute=(0,_react.useCallback)(function(){var _ref10=(0,_asyncToGenerator2.default)(function*(channelId,value){var isRefreshTotal=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;yield _im.default.service.updateChannelMute({channelUuid:channelId,mute:value});if(isRefreshTotal){yield _im.default.service.readMessage({channelUuid:channelId,total:9999});}dispatch((0,_actions.updateChannelAttribute)({network:networkType,channelId:channelId,value:{mute:value,unreadMessageCount:0}}));if(isRefreshTotal){_im.default.refreshMessageCount();}});return function(_x11,_x12){return _ref10.apply(this,arguments);};}(),[dispatch,networkType]);return mute;};var usePinChannel=exports.usePinChannel=function usePinChannel(){var _useCurrentNetworkInf6=(0,_network.useCurrentNetworkInfo)(),networkType=_useCurrentNetworkInf6.networkType;var dispatch=(0,_.useAppCommonDispatch)();var pin=(0,_react.useCallback)(function(){var _ref11=(0,_asyncToGenerator2.default)(function*(channelId,value){yield _im.default.service.updateChannelPin({channelUuid:channelId,pin:value});dispatch((0,_actions.updateChannelAttribute)({network:networkType,channelId:channelId,value:{pin:value}}));});return function(_x13,_x14){return _ref11.apply(this,arguments);};}(),[dispatch,networkType]);return pin;};var useHideChannel=exports.useHideChannel=function useHideChannel(){var _useCurrentNetworkInf7=(0,_network.useCurrentNetworkInfo)(),networkType=_useCurrentNetworkInf7.networkType;var dispatch=(0,_.useAppCommonDispatch)();var hide=(0,_react.useCallback)(function(){var _ref12=(0,_asyncToGenerator2.default)(function*(channelId){yield _im.default.service.hideChannel({channelUuid:channelId});_im.default.service.readMessage({channelUuid:channelId,total:9999}).then(function(){_im.default.refreshMessageCount();});dispatch((0,_actions.removeChannel)({network:networkType,channelId:channelId}));});return function(_x15){return _ref12.apply(this,arguments);};}(),[dispatch,networkType]);return hide;};var useSearchChannel=exports.useSearchChannel=function useSearchChannel(){return(0,_react.useCallback)(function(){var _ref13=(0,_asyncToGenerator2.default)(function*(keyword){var _data$list;var _yield$im$service$get=yield _im.default.service.getChannelList({keyword:keyword,cursor:'',maxResultCount:_im2.SEARCH_CHANNEL_LIMIT}),data=_yield$im$service$get.data;return(data==null?void 0:(_data$list=data.list)==null?void 0:_data$list.filter(function(ele){return!!(ele!=null&&ele.lastPostAt);}))||[];});return function(_x16){return _ref13.apply(this,arguments);};}(),[]);};var useAddStranger=exports.useAddStranger=function useAddStranger(){return(0,_react.useCallback)(function(relationId){return _im.default.service.addStranger({relationId:relationId});},[]);};var useCheckIsStranger=exports.useCheckIsStranger=function useCheckIsStranger(){var contactRelationIdMap=(0,_contact.useContactRelationIdMap)();return(0,_react.useCallback)(function(relationId){return!(contactRelationIdMap!=null&&contactRelationIdMap[relationId]);},[contactRelationIdMap]);};