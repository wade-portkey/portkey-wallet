var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.queryAuthorization=exports.isValidRefreshTokenConfig=void 0;exports.setRefreshTokenConfig=setRefreshTokenConfig;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _fetch=require("../../../utils/fetch");var _queryString=require("query-string");var _aelfSdk=_interopRequireDefault(require("aelf-sdk"));var _=require("./..");var _excluded=["connectUrl"];var queryAuthorization=exports.queryAuthorization=function(){var _ref=(0,_asyncToGenerator2.default)(function*(config){var connectUrl=config.connectUrl,_config=(0,_objectWithoutProperties2.default)(config,_excluded);var _yield$customFetch=yield(0,_fetch.customFetch)(config.connectUrl+'/connect/token',{headers:{'Content-Type':'application/x-www-form-urlencoded'},method:'POST',body:(0,_queryString.stringify)(Object.assign({},_config,{chain_id:config.chainId}))}),access_token=_yield$customFetch.access_token;return"Bearer "+access_token;});return function queryAuthorization(_x){return _ref.apply(this,arguments);};}();var DAY=24*60*60*1000;var isValidRefreshTokenConfig=exports.isValidRefreshTokenConfig=function isValidRefreshTokenConfig(config){var expireTime=config.timestamp+1*DAY;return expireTime>=Date.now();};function setRefreshTokenConfig(_ref2){var account=_ref2.account,caHash=_ref2.caHash,connectUrl=_ref2.connectUrl,chainId=_ref2.chainId;var timestamp=Date.now();var message=Buffer.from(account.address+"-"+timestamp).toString('hex');var signature=_aelfSdk.default.wallet.sign(message,account.keyPair).toString('hex');var pubkey=account.keyPair.getPublic('hex');var ca_hash=caHash;_.request.setRefreshTokenConfig({grant_type:'signature',client_id:'CAServer_App',scope:'CAServer',signature:signature,pubkey:pubkey,timestamp:timestamp,ca_hash:ca_hash,connectUrl:connectUrl,chainId:chainId});}