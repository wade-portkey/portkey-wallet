var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.WB3ContractBasic=exports.ContractBasic=exports.AElfContractBasic=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _utils=require("../../utils");var _index=require("./index");var _aelf=require("../../utils/aelf");var ContractBasic=exports.ContractBasic=(0,_createClass2.default)(function ContractBasic(options){var _this=this;(0,_classCallCheck2.default)(this,ContractBasic);(0,_defineProperty2.default)(this,"address",void 0);(0,_defineProperty2.default)(this,"callContract",void 0);(0,_defineProperty2.default)(this,"chainType",void 0);(0,_defineProperty2.default)(this,"rpcUrl",void 0);(0,_defineProperty2.default)(this,"callViewMethod",function(){var _ref=(0,_asyncToGenerator2.default)(function*(functionName,paramsOption){var _callOptions=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{defaultBlock:'latest'};console.log('callViewMethod',functionName,JSON.stringify(paramsOption),_callOptions);if(_this.callContract instanceof AElfContractBasic)return _this.callContract.callViewMethod(functionName,paramsOption);return{data:''};});return function(_x,_x2){return _ref.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"callSendMethod",function(){var _ref2=(0,_asyncToGenerator2.default)(function*(functionName,_account,paramsOption,sendOptions){console.log('callSendMethod',functionName,JSON.stringify(paramsOption),sendOptions);if(_this.callContract instanceof AElfContractBasic)return _this.callContract.callSendMethod(functionName,paramsOption,sendOptions);return{data:''};});return function(_x3,_x4,_x5,_x6){return _ref2.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"encodedTx",function(){var _ref3=(0,_asyncToGenerator2.default)(function*(functionName,paramsOption){if(_this.callContract instanceof AElfContractBasic)return _this.callContract.encodedTx(functionName,paramsOption);return{data:''};});return function(_x7,_x8){return _ref3.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"calculateTransactionFee",function(){var _ref4=(0,_asyncToGenerator2.default)(function*(functionName,paramsOption){if(_this.callContract instanceof AElfContractBasic)return _this.callContract.calculateTransactionFee(functionName,paramsOption);return{data:''};});return function(_x9,_x10){return _ref4.apply(this,arguments);};}());this.address=options.contractAddress;this.rpcUrl=options.rpcUrl;var isELF=true;this.callContract=isELF?new AElfContractBasic(options):new WB3ContractBasic();this.chainType=isELF?'aelf':'ethereum';});var WB3ContractBasic=exports.WB3ContractBasic=(0,_createClass2.default)(function WB3ContractBasic(){(0,_classCallCheck2.default)(this,WB3ContractBasic);});var AElfContractBasic=exports.AElfContractBasic=(0,_createClass2.default)(function AElfContractBasic(options){var _this2=this;(0,_classCallCheck2.default)(this,AElfContractBasic);(0,_defineProperty2.default)(this,"aelfContract",void 0);(0,_defineProperty2.default)(this,"address",void 0);(0,_defineProperty2.default)(this,"aelfInstance",void 0);(0,_defineProperty2.default)(this,"callViewMethod",function(){var _ref5=(0,_asyncToGenerator2.default)(function*(functionName,paramsOption){var contract=_this2.aelfContract;if(!contract)return{error:{code:401,message:'Contract init error1'}};try{var req=yield contract[(0,_index.handleFunctionName)(functionName)].call(paramsOption);if(!(req!=null&&req.error)&&(req!=null&&req.result||(req==null?void 0:req.result)===null))return{data:req.result};return{data:req};}catch(error){return{error:(0,_index.handleContractError)(error)};}});return function(_x11,_x12){return _ref5.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"callSendMethod",function(){var _ref6=(0,_asyncToGenerator2.default)(function*(functionName,paramsOption,sendOptions){if(!_this2.aelfContract)return{error:{code:401,message:'Contract init error'}};console.log('paramsOption',paramsOption);try{var _ref7=sendOptions||{},_ref7$onMethod=_ref7.onMethod,onMethod=_ref7$onMethod===void 0?'receipt':_ref7$onMethod;var _functionName=(0,_index.handleFunctionName)(functionName);var _params=yield(0,_index.handleContractParams)({instance:_this2.aelfInstance,paramsOption:paramsOption,functionName:_functionName});var req=yield _this2.aelfContract[_functionName](_params);var _ref8=(req==null?void 0:req.result)||req,TransactionId=_ref8.TransactionId;if(req!=null&&req.error)return{error:(0,_index.handleContractError)(undefined,req),transactionId:TransactionId};if(onMethod==='receipt'){yield(0,_utils.sleep)(1000);try{var txResult=yield(0,_index.getTxResult)(_this2.aelfInstance,TransactionId);console.log('txResult',txResult);return{data:txResult,transactionId:TransactionId};}catch(error){return{error:(0,_index.handleContractError)(error,req),transactionId:TransactionId};}}return{transactionId:TransactionId};}catch(error){return{error:(0,_index.handleContractError)(error)};}});return function(_x13,_x14,_x15){return _ref6.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"encodedTx",function(){var _ref9=(0,_asyncToGenerator2.default)(function*(functionName,paramsOption){if(!_this2.aelfContract)return{error:{code:401,message:'Contract init error'}};if(!_this2.aelfInstance)return{error:{code:401,message:'instance init error'}};try{var _functionName=(0,_index.handleFunctionName)(functionName);var _params=yield(0,_index.handleContractParams)({instance:_this2.aelfInstance,paramsOption:paramsOption,functionName:_functionName});var data=yield(0,_aelf.encodedTx)({instance:_this2.aelfInstance,contract:_this2.aelfContract,paramsOption:_params,functionName:_functionName});return{data:data};}catch(error){return{error:(0,_index.handleContractError)(error)};}});return function(_x16,_x17){return _ref9.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"calculateTransactionFee",function(){var _ref10=(0,_asyncToGenerator2.default)(function*(functionName,paramsOption){try{var _this2$aelfInstance;var _yield$_this2$encoded=yield _this2.encodedTx(functionName,paramsOption),data=_yield$_this2$encoded.data;var req=yield(_this2$aelfInstance=_this2.aelfInstance)==null?void 0:_this2$aelfInstance.chain.calculateTransactionFee(data);return{data:req};}catch(error){return{error:(0,_index.handleContractError)(error)};}});return function(_x18,_x19){return _ref10.apply(this,arguments);};}());var aelfContract=options.aelfContract,contractAddress=options.contractAddress,aelfInstance=options.aelfInstance;this.address=contractAddress;this.aelfContract=aelfContract;this.aelfInstance=aelfInstance;});