var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.resetAssets=exports.fetchTokensPriceAsync=exports.fetchTokenListAsync=exports.fetchNFTCollectionsAsync=exports.fetchNFTAsync=exports.fetchAssetAsync=exports.default=exports.clearNftItem=exports.clearNftCollection=exports.assetsSlice=void 0;var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _toolkit=require("@reduxjs/toolkit");var _api=require("./api");var _assets=require("../../../constants/constants-ca/assets");var _misc=require("../../../constants/misc");var _converter=require("../../../utils/converter");var initialState={accountToken:{isFetching:false,skipCount:0,maxResultCount:10,accountTokenList:_assets.NEW_CLIENT_MOCK_ELF_LIST,totalRecordCount:0},accountNFT:{isFetching:false,skipCount:0,maxResultCount:10,accountNFTList:[],totalRecordCount:0},accountAssets:{isFetching:false,skipCount:0,maxResultCount:1000,accountAssetsList:[],totalRecordCount:0},tokenPrices:{isFetching:false,tokenPriceObject:{}},accountBalance:0};var fetchTokenListAsync=exports.fetchTokenListAsync=(0,_toolkit.createAsyncThunk)('fetchTokenListAsync',function(){var _ref2=(0,_asyncToGenerator2.default)(function*(_ref){var caAddresses=_ref.caAddresses,caAddressInfos=_ref.caAddressInfos,_ref$skipCount=_ref.skipCount,skipCount=_ref$skipCount===void 0?0:_ref$skipCount,_ref$maxResultCount=_ref.maxResultCount,maxResultCount=_ref$maxResultCount===void 0?1000:_ref$maxResultCount;var response=yield(0,_api.fetchTokenList)({caAddresses:caAddresses,caAddressInfos:caAddressInfos,skipCount:skipCount,maxResultCount:maxResultCount});if(response.data.length===0){return{list:_assets.NEW_CLIENT_MOCK_ELF_LIST,totalRecordCount:_assets.NEW_CLIENT_MOCK_ELF_LIST.length};}return{list:response.data,totalRecordCount:response.totalRecordCount};});return function(_x){return _ref2.apply(this,arguments);};}());var fetchNFTCollectionsAsync=exports.fetchNFTCollectionsAsync=(0,_toolkit.createAsyncThunk)('fetchNFTCollectionsAsync',function(){var _ref4=(0,_asyncToGenerator2.default)(function*(_ref3){var caAddresses=_ref3.caAddresses,caAddressInfos=_ref3.caAddressInfos,_ref3$maxNFTCount=_ref3.maxNFTCount,maxNFTCount=_ref3$maxNFTCount===void 0?_assets.PAGE_SIZE_IN_NFT_ITEM:_ref3$maxNFTCount;var response=yield(0,_api.fetchNFTSeriesList)({caAddresses:caAddresses,caAddressInfos:caAddressInfos,skipCount:0});return{list:response.data,totalRecordCount:response.totalRecordCount,maxNFTCount:maxNFTCount};});return function(_x2){return _ref4.apply(this,arguments);};}());var fetchNFTAsync=exports.fetchNFTAsync=(0,_toolkit.createAsyncThunk)('fetchNFTAsync',function(){var _ref7=(0,_asyncToGenerator2.default)(function*(_ref5,_ref6){var symbol=_ref5.symbol,caAddresses=_ref5.caAddresses,caAddressInfos=_ref5.caAddressInfos,chainId=_ref5.chainId,_ref5$pageNum=_ref5.pageNum,pageNum=_ref5$pageNum===void 0?0:_ref5$pageNum;var getState=_ref6.getState;var _ref8=getState(),assets=_ref8.assets;var accountNFTList=assets.accountNFT.accountNFTList;var targetNFTCollection=accountNFTList.find(function(item){return item.symbol===symbol&&item.chainId===chainId;});if(!targetNFTCollection)return;var skipCount=targetNFTCollection.skipCount,maxResultCount=targetNFTCollection.maxResultCount,totalRecordCount=targetNFTCollection.totalRecordCount,children=targetNFTCollection.children;if((pageNum+1)*maxResultCount<=children.length)return;if(totalRecordCount===0||Number(totalRecordCount)>children.length){var response=yield(0,_api.fetchNFTList)({symbol:symbol,caAddresses:caAddresses,caAddressInfos:caAddressInfos,skipCount:skipCount,maxResultCount:maxResultCount});return{symbol:symbol,chainId:chainId,list:response.data,totalRecordCount:response.totalRecordCount,skipCount:skipCount};}return{symbol:symbol,chainId:chainId,list:[],totalRecordCount:totalRecordCount,skipCount:skipCount};});return function(_x3,_x4){return _ref7.apply(this,arguments);};}());var fetchAssetAsync=exports.fetchAssetAsync=(0,_toolkit.createAsyncThunk)('fetchAssetsAsync',function(){var _ref10=(0,_asyncToGenerator2.default)(function*(_ref9){var caAddresses=_ref9.caAddresses,keyword=_ref9.keyword,caAddressInfos=_ref9.caAddressInfos;var response=yield(0,_api.fetchAssetList)({caAddresses:caAddresses,caAddressInfos:caAddressInfos,keyword:keyword,skipCount:0,maxResultCount:1000});return{list:response.data,totalRecordCount:response.totalRecordCount};});return function(_x5){return _ref10.apply(this,arguments);};}());var fetchTokensPriceAsync=exports.fetchTokensPriceAsync=(0,_toolkit.createAsyncThunk)('fetchTokensPriceAsync',function(){var _ref13=(0,_asyncToGenerator2.default)(function*(_ref11,_ref12){var symbols=_ref11.symbols;var getState=_ref12.getState;var _ref14=getState(),accountTokenList=_ref14.assets.accountToken.accountTokenList;var response=yield(0,_api.fetchTokenPrices)({symbols:symbols||accountTokenList.map(function(ele){return ele.symbol;})});return{list:response.items};});return function(_x6,_x7){return _ref13.apply(this,arguments);};}());var assetsSlice=exports.assetsSlice=(0,_toolkit.createSlice)({name:'assets',initialState:initialState,reducers:{resetAssets:function resetAssets(){return initialState;},clearNftItem:function clearNftItem(state,action){var _action$payload=action.payload,symbol=_action$payload.symbol,chainId=_action$payload.chainId;if(symbol&&chainId){var newAccountNFTList=state.accountNFT.accountNFTList.map(function(item){return item.symbol===symbol&&item.chainId===chainId?Object.assign({},item,{skipCount:0,maxResultCount:9,totalRecordCount:0,children:[]}):item;});state.accountNFT.accountNFTList=newAccountNFTList;}},clearNftCollection:function clearNftCollection(state){state.accountNFT=initialState.accountNFT;}},extraReducers:function extraReducers(builder){builder.addCase(fetchTokenListAsync.pending,function(state){state.accountToken.isFetching=true;}).addCase(fetchTokenListAsync.fulfilled,function(state,action){var _action$payload2=action.payload,list=_action$payload2.list,totalRecordCount=_action$payload2.totalRecordCount;var priceObj={};var totalBalanceInUsd=list.reduce(function(acc,ele){var _ele$price,_ele$balanceInUsd;if(ele.symbol)priceObj[ele.symbol]=(_ele$price=ele.price)!=null?_ele$price:0;return acc.plus((_ele$balanceInUsd=ele==null?void 0:ele.balanceInUsd)!=null?_ele$balanceInUsd:_misc.ZERO);},_misc.ZERO);state.accountBalance=(0,_converter.formatAmountShow)(totalBalanceInUsd,2);state.tokenPrices.tokenPriceObject=Object.assign({},state.tokenPrices.tokenPriceObject,priceObj);state.accountToken.accountTokenList=list;state.accountToken.skipCount=state.accountToken.accountTokenList.length;state.accountToken.totalRecordCount=totalRecordCount;state.accountToken.isFetching=false;}).addCase(fetchTokenListAsync.rejected,function(state){state.accountToken.isFetching=false;}).addCase(fetchNFTCollectionsAsync.pending,function(state){state.accountToken.isFetching=true;}).addCase(fetchNFTCollectionsAsync.fulfilled,function(state,action){var _action$payload3=action.payload,list=_action$payload3.list,totalRecordCount=_action$payload3.totalRecordCount,maxNFTCount=_action$payload3.maxNFTCount;var newAccountList=list.map(function(item){return Object.assign({isFetching:false,skipCount:0,maxResultCount:maxNFTCount,totalRecordCount:0,children:[]},item);});state.accountNFT.accountNFTList=newAccountList;state.accountNFT.totalRecordCount=totalRecordCount;state.accountNFT.isFetching=false;}).addCase(fetchNFTAsync.pending,function(state){state.accountToken.isFetching=true;}).addCase(fetchNFTAsync.fulfilled,function(state,action){if(!action.payload)return;var _action$payload4=action.payload,list=_action$payload4.list,totalRecordCount=_action$payload4.totalRecordCount,symbol=_action$payload4.symbol,chainId=_action$payload4.chainId,skipCount=_action$payload4.skipCount;var currentNFTSeriesItem=state.accountNFT.accountNFTList.find(function(ele){return ele.symbol===symbol&&ele.chainId===chainId;});if(currentNFTSeriesItem){var _currentNFTSeriesItem;if((currentNFTSeriesItem==null?void 0:(_currentNFTSeriesItem=currentNFTSeriesItem.children)==null?void 0:_currentNFTSeriesItem.length)>skipCount)return;currentNFTSeriesItem.children=[].concat((0,_toConsumableArray2.default)(currentNFTSeriesItem.children),(0,_toConsumableArray2.default)(list));currentNFTSeriesItem.skipCount=currentNFTSeriesItem.children.length;currentNFTSeriesItem.totalRecordCount=totalRecordCount;currentNFTSeriesItem.isFetching=false;}}).addCase(fetchNFTAsync.rejected,function(state){state.accountToken.isFetching=false;}).addCase(fetchAssetAsync.pending,function(state){state.accountToken.isFetching=true;}).addCase(fetchAssetAsync.fulfilled,function(state,action){var _action$payload5=action.payload,list=_action$payload5.list,totalRecordCount=_action$payload5.totalRecordCount;state.accountAssets.accountAssetsList=list;state.accountAssets.skipCount=state.accountAssets.accountAssetsList.length;state.accountAssets.totalRecordCount=totalRecordCount;state.accountAssets.isFetching=false;}).addCase(fetchAssetAsync.rejected,function(state){state.accountToken.isFetching=false;}).addCase(fetchTokensPriceAsync.pending,function(state){state.accountToken.isFetching=true;}).addCase(fetchTokensPriceAsync.fulfilled,function(state,action){var list=action.payload.list;list.map(function(ele){state.tokenPrices.tokenPriceObject[ele==null?void 0:ele.symbol]=ele==null?void 0:ele.priceInUsd;});state.accountAssets.skipCount=state.accountAssets.accountAssetsList.length;state.accountAssets.isFetching=false;}).addCase(fetchTokensPriceAsync.rejected,function(state){state.accountToken.isFetching=false;});}});var _assetsSlice$actions=assetsSlice.actions,clearNftItem=exports.clearNftItem=_assetsSlice$actions.clearNftItem,resetAssets=exports.resetAssets=_assetsSlice$actions.resetAssets,clearNftCollection=exports.clearNftCollection=_assetsSlice$actions.clearNftCollection;var _default=exports.default=assetsSlice;