var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.getOrReadCachedVerifierData=exports.getContractInstance=exports.callRemoveManagerMethod=exports.callRemoveGuardianMethod=exports.callGetTransferLimitMethod=exports.callGetHolderInfoMethod=exports.callFaucetMethod=exports.callEditPaymentSecurityMethod=exports.callEditGuardianMethod=exports.callCancelLoginGuardianMethod=exports.callAddManagerMethod=exports.callAddGuardianMethod=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _utils=require("../../packages/contracts/utils");var _converter=require("../../packages/utils/converter");var _guardian=require("../../packages/utils/guardian");var _constants=require("../../global/constants");var _chain=require("../chain");var _global=require("../global");var _network=require("../hooks/network");var _core=require("../verify/core");var _wallet=require("../wallet");var _controller=require("../../network/controller");var _wallet2=require("../../network/dto/wallet");var _cache=require("../../service/storage/cache");var _commonUtil=require("../../utils/commonUtil");var _wallet3=require("../../utils/wallet");var getContractInstance=exports.getContractInstance=function(){var _ref=(0,_asyncToGenerator2.default)(function*(){var allowTemplateWallet=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var privateKey='';if(allowTemplateWallet&&!(yield(0,_core.isWalletUnlocked)())){privateKey='6167c717e781099c8ee77cbf0c3f6e7c8315fc581eb7daa891c872c026359c84';}else{var _ref2=(yield(0,_wallet.getUnlockedWallet)())||{},pk=_ref2.privateKey;privateKey=pk;}var _ref3=(yield(0,_chain.getCachedNetworkConfig)())||{},caContractAddress=_ref3.caContractAddress,peerUrl=_ref3.peerUrl;return yield(0,_utils.getContractBasic)({contractAddress:caContractAddress,rpcUrl:peerUrl,account:_wallet2.AElfWeb3SDK.getWalletByPrivateKey(privateKey)});});return function getContractInstance(){return _ref.apply(this,arguments);};}();var callAddManagerMethod=exports.callAddManagerMethod=function(){var _ref4=(0,_asyncToGenerator2.default)(function*(extraData,managerAddress){if(!(yield(0,_core.isWalletUnlocked)()))throw new Error('wallet is not unlocked');var contractInstance=yield getContractInstance();var _ref5=(yield(0,_wallet.getUnlockedWallet)())||{},address=_ref5.address;var _ref6=(yield(0,_wallet.getUnlockedWallet)())||{},caHash=_ref6.caInfo.caHash;return yield(0,_wallet3.addManager)({contract:contractInstance,address:address,caHash:caHash,managerAddress:managerAddress,extraData:extraData});});return function callAddManagerMethod(_x,_x2){return _ref4.apply(this,arguments);};}();var getOrReadCachedVerifierData=exports.getOrReadCachedVerifierData=function(){var _ref7=(0,_asyncToGenerator2.default)(function*(){return(0,_cache.handleCachedValue)({target:'TEMP',getIdentifier:function(){var _getIdentifier=(0,_asyncToGenerator2.default)(function*(){var chainId=yield _constants.PortkeyConfig.currChainId();var endPoint=yield _constants.PortkeyConfig.endPointUrl();return"GetVerifierServers_"+chainId+"_"+endPoint;});function getIdentifier(){return _getIdentifier.apply(this,arguments);}return getIdentifier;}(),getValueIfNonExist:function(){var _getValueIfNonExist=(0,_asyncToGenerator2.default)(function*(){var contractInstance=yield getContractInstance(true);var result=yield contractInstance.callViewMethod('GetVerifierServers');return result;});function getValueIfNonExist(){return _getValueIfNonExist.apply(this,arguments);}return getValueIfNonExist;}()});});return function getOrReadCachedVerifierData(){return _ref7.apply(this,arguments);};}();var callAddGuardianMethod=exports.callAddGuardianMethod=function(){var _ref8=(0,_asyncToGenerator2.default)(function*(particularGuardian,guardianList){var contractInstance=yield getContractInstance();var _ref9=(yield(0,_wallet.getUnlockedWallet)())||{},address=_ref9.address,caHash=_ref9.caInfo.caHash;return yield contractInstance.callSendMethod('AddGuardian',address,{caHash:caHash,guardianToAdd:parseGuardianConfigInfoToCaType(particularGuardian),guardiansApproved:guardianList.map(function(item){return parseVerifiedGuardianInfoToCaType(item);})});});return function callAddGuardianMethod(_x3,_x4){return _ref8.apply(this,arguments);};}();var callGetHolderInfoMethod=exports.callGetHolderInfoMethod=function(){var _ref10=(0,_asyncToGenerator2.default)(function*(caHash,caContractAddress,peerUrl){var _ref11=(yield(0,_wallet.getUnlockedWallet)())||{},privateKey=_ref11.privateKey;var contractInstance=yield(0,_utils.getContractBasic)({contractAddress:caContractAddress,rpcUrl:peerUrl,account:_wallet2.AElfWeb3SDK.getWalletByPrivateKey(privateKey)});return yield contractInstance.callViewMethod('GetHolderInfo',{caHash:caHash});});return function callGetHolderInfoMethod(_x5,_x6,_x7){return _ref10.apply(this,arguments);};}();var callRemoveGuardianMethod=exports.callRemoveGuardianMethod=function(){var _ref12=(0,_asyncToGenerator2.default)(function*(particularGuardian,guardianList){var contractInstance=yield getContractInstance();var _ref13=(yield(0,_wallet.getUnlockedWallet)())||{},address=_ref13.address,caHash=_ref13.caInfo.caHash;return yield contractInstance.callSendMethod('RemoveGuardian',address,{caHash:caHash,guardianToRemove:parseGuardianConfigInfoToCaType(particularGuardian,true),guardiansApproved:guardianList.map(function(item){return parseVerifiedGuardianInfoToCaType(item);})});});return function callRemoveGuardianMethod(_x8,_x9){return _ref12.apply(this,arguments);};}();var callEditGuardianMethod=exports.callEditGuardianMethod=function(){var _ref14=(0,_asyncToGenerator2.default)(function*(thisGuardian,pastGuardian,guardianList){var contractInstance=yield getContractInstance();var _ref15=(yield(0,_wallet.getUnlockedWallet)())||{},address=_ref15.address,caHash=_ref15.caInfo.caHash;return yield contractInstance.callSendMethod('UpdateGuardian',address,{caHash:caHash,guardianToUpdatePre:parseGuardianConfigInfoToCaType(pastGuardian,true),guardianToUpdateNew:parseGuardianConfigInfoToCaType(thisGuardian,true),guardiansApproved:guardianList.map(function(item){return parseVerifiedGuardianInfoToCaType(item);})});});return function callEditGuardianMethod(_x10,_x11,_x12){return _ref14.apply(this,arguments);};}();var callCancelLoginGuardianMethod=exports.callCancelLoginGuardianMethod=function(){var _ref16=(0,_asyncToGenerator2.default)(function*(particularGuardian){var _particularGuardian$v,_particularGuardian$v2;var contractInstance=yield getContractInstance();var _handleVerificationDo=(0,_guardian.handleVerificationDoc)((_particularGuardian$v=(_particularGuardian$v2=particularGuardian.verifiedDoc)==null?void 0:_particularGuardian$v2.verificationDoc)!=null?_particularGuardian$v:''),guardianIdentifier=_handleVerificationDo.guardianIdentifier;var _ref17=(yield(0,_wallet.getUnlockedWallet)())||{},address=_ref17.address,caHash=_ref17.caInfo.caHash;return contractInstance.callSendMethod('UnsetGuardianForLogin',address,{caHash:caHash,guardian:{type:(0,_global.guardianTypeStrToEnum)(particularGuardian.sendVerifyCodeParams.type),verifierId:particularGuardian.sendVerifyCodeParams.verifierId,identifierHash:guardianIdentifier}});});return function callCancelLoginGuardianMethod(_x13){return _ref16.apply(this,arguments);};}();var callGetTransferLimitMethod=exports.callGetTransferLimitMethod=function(){var _ref18=(0,_asyncToGenerator2.default)(function*(chainId,symbol){var contractInstance=yield getContractInstanceOnParticularChain(chainId);var _ref19=(yield(0,_wallet.getUnlockedWallet)())||{},caHash=_ref19.caInfo.caHash;return yield contractInstance.callViewMethod('GetTransferLimit',{caHash:caHash,symbol:symbol});});return function callGetTransferLimitMethod(_x14,_x15){return _ref18.apply(this,arguments);};}();var callEditPaymentSecurityMethod=exports.callEditPaymentSecurityMethod=function(){var _ref20=(0,_asyncToGenerator2.default)(function*(guardianList,transferLimitDetail){var chainId=transferLimitDetail.chainId;var contractInstance=yield getContractInstanceOnParticularChain(chainId);var _ref21=(yield(0,_wallet.getUnlockedWallet)())||{},address=_ref21.address,caHash=_ref21.caInfo.caHash;return yield contractInstance.callSendMethod('SetTransferLimit',address,{caHash:caHash,symbol:transferLimitDetail.symbol,singleLimit:transferLimitDetail.singleLimit,dailyLimit:transferLimitDetail.dailyLimit,guardiansApproved:guardianList.map(function(item){return parseVerifiedGuardianInfoToCaType(item);})});});return function callEditPaymentSecurityMethod(_x16,_x17){return _ref20.apply(this,arguments);};}();var getContractInstanceOnParticularChain=function(){var _ref22=(0,_asyncToGenerator2.default)(function*(chainId){var _ref23=(yield(0,_wallet.getUnlockedWallet)())||{},privateKey=_ref23.privateKey;var _yield$findParticular=yield findParticularNetworkByChainId(chainId),caContractAddress=_yield$findParticular.caContractAddress,endPoint=_yield$findParticular.endPoint;if(!caContractAddress||!endPoint)throw new Error('callGetTransferLimitMethod: caContractAddress or endPoint is invalid');return yield(0,_utils.getContractBasic)({contractAddress:caContractAddress,rpcUrl:endPoint,account:_wallet2.AElfWeb3SDK.getWalletByPrivateKey(privateKey)});});return function getContractInstanceOnParticularChain(_x18){return _ref22.apply(this,arguments);};}();var findParticularNetworkByChainId=function(){var _ref24=(0,_asyncToGenerator2.default)(function*(chainId){var _yield$NetworkControl=yield _controller.NetworkController.getNetworkInfo(),items=_yield$NetworkControl.items;var item=items.find(function(it){return it.chainId===chainId;});if(!item)throw new Error('chainId is invalid');return item;});return function findParticularNetworkByChainId(_x19){return _ref24.apply(this,arguments);};}();var callFaucetMethod=exports.callFaucetMethod=function(){var _ref25=(0,_asyncToGenerator2.default)(function*(){var amount=arguments.length>0&&arguments[0]!==undefined?arguments[0]:100;var contractInstance=yield getContractInstance();if((yield(0,_network.getCurrentNetworkType)())==='MAIN'){throw new Error('faucet is not supported on mainnet');}var _ref26=(yield(0,_wallet.getUnlockedWallet)())||{},address=_ref26.address,caHash=_ref26.caInfo.caHash;var endPointUrl=yield _constants.PortkeyConfig.endPointUrl();return yield contractInstance.callSendMethod('ManagerForwardCall',address,{caHash:caHash,contractAddress:(0,_commonUtil.selectCurrentBackendConfig)(endPointUrl).tokenClaimContractAddress,methodName:'ClaimToken',args:{symbol:'ELF',amount:(0,_converter.timesDecimals)(amount,8).toString()}});});return function callFaucetMethod(){return _ref25.apply(this,arguments);};}();var callRemoveManagerMethod=exports.callRemoveManagerMethod=function(){var _ref27=(0,_asyncToGenerator2.default)(function*(){var contractInstance=yield getContractInstance();var _ref28=(yield(0,_wallet.getUnlockedWallet)())||{},address=_ref28.address,caHash=_ref28.caInfo.caHash;return yield contractInstance.callSendMethod('RemoveManagerInfo',address,{caHash:caHash});});return function callRemoveManagerMethod(){return _ref27.apply(this,arguments);};}();var parseGuardianConfigInfoToCaType=function parseGuardianConfigInfoToCaType(guardianConfig){var _handleVerificationDo2,_guardianConfig$verif,_guardianConfig$verif2,_guardianConfig$sendV;var withoutVerifyData=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var _ref29=guardianConfig.verifiedDoc||{},signature=_ref29.signature,verificationDoc=_ref29.verificationDoc;if(!withoutVerifyData&&(!signature||!verificationDoc))throw new Error('parseGuardianConfigInfoToCaType:verify data is invalid! '+JSON.stringify(guardianConfig));var identifierHash=withoutVerifyData?guardianConfig.identifierHash:(_handleVerificationDo2=(0,_guardian.handleVerificationDoc)((_guardianConfig$verif=(_guardianConfig$verif2=guardianConfig.verifiedDoc)==null?void 0:_guardianConfig$verif2.verificationDoc)!=null?_guardianConfig$verif:''))==null?void 0:_handleVerificationDo2.guardianIdentifier;return{identifierHash:identifierHash,type:(0,_global.guardianTypeStrToEnum)(guardianConfig.sendVerifyCodeParams.type),verificationInfo:withoutVerifyData?{id:(_guardianConfig$sendV=guardianConfig.sendVerifyCodeParams)==null?void 0:_guardianConfig$sendV.verifierId}:{id:guardianConfig.sendVerifyCodeParams.verifierId,signature:Object.values(Buffer.from(signature,'hex')),verificationDoc:verificationDoc}};};var parseVerifiedGuardianInfoToCaType=function parseVerifiedGuardianInfoToCaType(guardianConfig){var _guardianConfig$verif3;var _handleVerificationDo3=(0,_guardian.handleVerificationDoc)((_guardianConfig$verif3=guardianConfig==null?void 0:guardianConfig.verificationDoc)!=null?_guardianConfig$verif3:''),guardianIdentifier=_handleVerificationDo3.guardianIdentifier;var _ref30=guardianConfig||{},signature=_ref30.signature,verificationDoc=_ref30.verificationDoc;if(!signature||!verificationDoc)throw new Error('parseVerifiedGuardianInfoToCaType:verify data is invalid! '+JSON.stringify(guardianConfig));return{identifierHash:guardianIdentifier,type:guardianConfig.type,verificationInfo:{id:guardianConfig.verifierId,signature:Object.values(Buffer.from(signature,'hex')),verificationDoc:verificationDoc}};};