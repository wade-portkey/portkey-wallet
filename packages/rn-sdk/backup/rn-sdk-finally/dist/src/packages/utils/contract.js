var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.WB3ContractBasic=exports.ContractBasic=exports.AElfContractBasic=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _index=require("./index");var _aelfUtils=require("./aelfUtils");var _aelf=require("./aelf");var ContractBasic=exports.ContractBasic=(0,_createClass2.default)(function ContractBasic(options){var _this=this;(0,_classCallCheck2.default)(this,ContractBasic);(0,_defineProperty2.default)(this,"address",void 0);(0,_defineProperty2.default)(this,"callContract",void 0);(0,_defineProperty2.default)(this,"contractType",void 0);(0,_defineProperty2.default)(this,"rpcUrl",void 0);(0,_defineProperty2.default)(this,"callViewMethod",function(){var _ref=(0,_asyncToGenerator2.default)(function*(functionName,paramsOption){var callOptions=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{defaultBlock:'latest'};if(_this.callContract instanceof AElfContractBasic)return _this.callContract.callViewMethod(functionName,paramsOption);});return function(_x,_x2){return _ref.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"callSendMethod",function(){var _ref2=(0,_asyncToGenerator2.default)(function*(functionName,account,paramsOption,sendOptions){if(_this.callContract instanceof AElfContractBasic)return _this.callContract.callSendMethod(functionName,paramsOption,sendOptions);});return function(_x3,_x4,_x5,_x6){return _ref2.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"encodedTx",function(){var _ref3=(0,_asyncToGenerator2.default)(function*(functionName,paramsOption){if(_this.callContract instanceof AElfContractBasic)return _this.callContract.encodedTx(functionName,paramsOption);});return function(_x7,_x8){return _ref3.apply(this,arguments);};}());this.address=options.contractAddress;this.rpcUrl=options.rpcUrl;var isELF=true;this.callContract=isELF?new AElfContractBasic(options):new WB3ContractBasic();this.contractType=isELF?'aelf':'ethereum';});var WB3ContractBasic=exports.WB3ContractBasic=(0,_createClass2.default)(function WB3ContractBasic(){(0,_classCallCheck2.default)(this,WB3ContractBasic);});var AElfContractBasic=exports.AElfContractBasic=(0,_createClass2.default)(function AElfContractBasic(options){var _this2=this;(0,_classCallCheck2.default)(this,AElfContractBasic);(0,_defineProperty2.default)(this,"aelfContract",void 0);(0,_defineProperty2.default)(this,"address",void 0);(0,_defineProperty2.default)(this,"aelfInstance",void 0);(0,_defineProperty2.default)(this,"callViewMethod",function(){var _ref4=(0,_asyncToGenerator2.default)(function*(functionName,paramsOption){var contract=_this2.aelfContract;if(!contract)return{error:{code:401,message:'Contract init error1'}};try{var functionNameUpper=functionName.replace(functionName[0],functionName[0].toLocaleUpperCase());var req=yield contract[functionNameUpper].call(paramsOption);if(!(req!=null&&req.error)&&(req!=null&&req.result||(req==null?void 0:req.result)===null))return req.result;return req;}catch(e){if(e!=null&&e.Error){return{error:{message:e.Error.Details||e.Error.Message,code:e.Error.Code}};}return{error:e};}});return function(_x9,_x10){return _ref4.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"callSendMethod",function(){var _ref5=(0,_asyncToGenerator2.default)(function*(functionName,paramsOption,sendOptions){if(!_this2.aelfContract)return{error:{code:401,message:'Contract init error'}};try{var _ref6=sendOptions||{},_ref6$onMethod=_ref6.onMethod,onMethod=_ref6$onMethod===void 0?'receipt':_ref6$onMethod;var functionNameUpper=functionName.replace(functionName[0],functionName[0].toLocaleUpperCase());var req=yield _this2.aelfContract[functionNameUpper](paramsOption);if(req.error){var _req$error$message,_req$errorMessage,_req$error$message2;return{error:{code:((_req$error$message=req.error.message)==null?void 0:_req$error$message.Code)||req.error,message:((_req$errorMessage=req.errorMessage)==null?void 0:_req$errorMessage.message)||((_req$error$message2=req.error.message)==null?void 0:_req$error$message2.Message)}};}var _ref7=req.result||req,TransactionId=_ref7.TransactionId;if(onMethod==='receipt'){yield(0,_index.sleep)(1000);try{return yield(0,_aelfUtils.getTxResult)(_this2.aelfInstance,TransactionId);}catch(error){var _req$error,_req$error$message3,_req$errorMessage2,_req$error2,_req$error2$message;if(error.message)return{error:error};return Object.assign({},error,{error:{code:(req==null?void 0:(_req$error=req.error)==null?void 0:(_req$error$message3=_req$error.message)==null?void 0:_req$error$message3.Code)||(req==null?void 0:req.error),message:error.Error||(req==null?void 0:(_req$errorMessage2=req.errorMessage)==null?void 0:_req$errorMessage2.message)||(req==null?void 0:(_req$error2=req.error)==null?void 0:(_req$error2$message=_req$error2.message)==null?void 0:_req$error2$message.Message)}});}}return{TransactionId:TransactionId};}catch(error){if(error.message)return{error:error};return{error:{message:error.Error||error.Status}};}});return function(_x11,_x12,_x13){return _ref5.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"encodedTx",function(){var _ref8=(0,_asyncToGenerator2.default)(function*(functionName,paramsOption){if(!_this2.aelfContract)return{error:{code:401,message:'Contract init error'}};if(!_this2.aelfInstance)return{error:{code:401,message:'instance init error'}};try{var raw=yield(0,_aelf.encodedTx)({instance:_this2.aelfInstance,contract:_this2.aelfContract,functionName:functionName,paramsOption:paramsOption});return raw;}catch(e){return{error:e};}});return function(_x14,_x15){return _ref8.apply(this,arguments);};}());var aelfContract=options.aelfContract,contractAddress=options.contractAddress,aelfInstance=options.aelfInstance;this.address=contractAddress;this.aelfContract=aelfContract;this.aelfInstance=aelfInstance;});