var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.Verification=exports.IntervalErrorMessage=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _assertThisInitialized2=_interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _storage=require("../../../types/storage");var _=require("./..");function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=(0,_getPrototypeOf2.default)(Derived),result;if(hasNativeReflectConstruct){var NewTarget=(0,_getPrototypeOf2.default)(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return(0,_possibleConstructorReturn2.default)(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}var IntervalErrorMessage=exports.IntervalErrorMessage='The interval between sending two verification codes is less than 60s';var Verification=exports.Verification=function(_StorageBaseLoader){(0,_inherits2.default)(Verification,_StorageBaseLoader);var _super=_createSuper(Verification);function Verification(store){var _this;(0,_classCallCheck2.default)(this,Verification);_this=_super.call(this,store);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"_defaultKeyName",'portkey_did_wallet');(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"_expirationTime",58*1000);(0,_defineProperty2.default)((0,_assertThisInitialized2.default)(_this),"verifierMap",void 0);_this.verifierMap={};_this.load();return _this;}(0,_createClass2.default)(Verification,[{key:"load",value:function(){var _load=(0,_asyncToGenerator2.default)(function*(){try{var storageVerifierMap=yield this._store.getItem(this._defaultKeyName);if(storageVerifierMap)this.verifierMap=JSON.parse(storageVerifierMap);if(typeof this.verifierMap!=='object')this.verifierMap={};}catch(error){console.log(error,'====load-verification');}});function load(){return _load.apply(this,arguments);}return load;}()},{key:"save",value:function(){var _save=(0,_asyncToGenerator2.default)(function*(){this._store.setItem(this._defaultKeyName,JSON.stringify(this.verifierMap));});function save(){return _save.apply(this,arguments);}return save;}()},{key:"get",value:function get(key){var info=this.verifierMap[key];if(!info)return;var endTime=info.time+this._expirationTime;if(endTime>Date.now()){return info;}else{this.delete(key);}}},{key:"delete",value:function _delete(key){delete this.verifierMap[key];this.save();}},{key:"set",value:function(){var _set=(0,_asyncToGenerator2.default)(function*(key,value){this.verifierMap[key]=value;yield this.save();});function set(_x,_x2){return _set.apply(this,arguments);}return set;}()},{key:"sendVerificationCode",value:function(){var _sendVerificationCode=(0,_asyncToGenerator2.default)(function*(config){var _config$params=config.params,guardianIdentifier=_config$params.guardianIdentifier,verifierId=_config$params.verifierId;var key=(guardianIdentifier||'')+(verifierId||'');try{var req=yield _.request.verify.sendVerificationRequest(config);yield this.set(key,Object.assign({},req,{time:Date.now()}));return req;}catch(error){var _ref=(error==null?void 0:error.error)||error||{},message=_ref.message;var item=this.get(key);if(message===IntervalErrorMessage&&item)return item;throw error;}});function sendVerificationCode(_x3){return _sendVerificationCode.apply(this,arguments);}return sendVerificationCode;}()},{key:"checkVerificationCode",value:function(){var _checkVerificationCode=(0,_asyncToGenerator2.default)(function*(config){var _ref2=config.params||{},guardianIdentifier=_ref2.guardianIdentifier,verifierId=_ref2.verifierId;var key=(guardianIdentifier||'')+(verifierId||'');var req=yield _.request.verify.checkVerificationCode(config);this.delete(key);return req;});function checkVerificationCode(_x4){return _checkVerificationCode.apply(this,arguments);}return checkVerificationCode;}()}]);return Verification;}(_storage.StorageBaseLoader);