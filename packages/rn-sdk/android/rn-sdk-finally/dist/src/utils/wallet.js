var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.addManager=addManager;exports.intervalGetResult=intervalGetResult;exports.wrapAddress=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _verifier=require("../packages/types/verifier");var _interval=require("../packages/utils/interval");var _apiDid=require("../packages/api/api-did");var _socketDid=_interopRequireDefault(require("../packages/socket/socket-did"));var wrapAddress=exports.wrapAddress=function wrapAddress(address){var chainId=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'AELF';var tokenSymbol=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'ELF';return tokenSymbol+"_"+address+"_"+chainId;};function intervalGetResult(_ref){var managerInfo=_ref.managerInfo,onPass=_ref.onPass,onFail=_ref.onFail;var timer='',mark=false;var listenerList=[];var remove=function remove(){try{timer&&(0,_interval.clearTimeoutInterval)(timer);listenerList.forEach(function(listen){return listen.remove();});_socketDid.default.stop();}catch(error){console.debug(error);}};var sendResult=function sendResult(result){if(mark)return;switch(result.recoveryStatus||result.registerStatus){case'pass':{if(result.caAddress&&result.caHash){onPass==null?void 0:onPass(result);remove();mark=true;}break;}case'fail':{onFail==null?void 0:onFail(result.recoveryMessage||result.registerMessage);remove();mark=true;break;}default:break;}};var clientId=managerInfo.requestId||'';var requestId=managerInfo.requestId||'';_socketDid.default.doOpen({url:_apiDid.request.defaultConfig.baseURL+"/ca",clientId:clientId});var fetch;if(managerInfo.verificationType!==_verifier.VerificationType.register){fetch=_apiDid.request.es.getRecoverResult;listenerList.push(_socketDid.default.onCaAccountRecover({clientId:clientId,requestId:requestId},function(data){sendResult(data.body);}));}else{fetch=_apiDid.request.es.getRegisterResult;listenerList.push(_socketDid.default.onCaAccountRegister({clientId:clientId,requestId:requestId},function(data){sendResult(data.body);}));}timer=(0,_interval.setTimeoutInterval)((0,_asyncToGenerator2.default)(function*(){try{var req=yield fetch({params:{filter:"_id:"+managerInfo.managerUniqueId}});sendResult(req.items[0]);}catch(error){console.debug(error,'=====error');}}),3000);return{remove:remove};}function addManager(_x){return _addManager.apply(this,arguments);}function _addManager(){_addManager=(0,_asyncToGenerator2.default)(function*(_ref3){var contract=_ref3.contract,address=_ref3.address,caHash=_ref3.caHash,managerAddress=_ref3.managerAddress,extraData=_ref3.extraData;return contract.callSendMethod('AddManagerInfo',address,{caHash:caHash,managerInfo:{address:managerAddress,extraData:extraData||''}});});return _addManager.apply(this,arguments);}