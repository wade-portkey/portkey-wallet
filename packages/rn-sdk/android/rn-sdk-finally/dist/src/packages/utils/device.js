var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.compareVersions=compareVersions;exports.getDeviceInfoFromQR=exports.extraDataListDecode=exports.extraDataEncode=exports.extraDataDecode=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _apiDid=require("../api/api-did");var _device=require("../constants/constants-ca/device");var _device2=require("../types/types-ca/device");var checkDateNumber=function checkDateNumber(value){return!isNaN(value)&&!isNaN(new Date(value).getTime());};var getDeviceInfoFromQR=exports.getDeviceInfoFromQR=function getDeviceInfoFromQR(qrExtraData,deviceType){if(qrExtraData!==undefined){return Object.assign({},_device.DEVICE_TYPE_INFO[_device2.DeviceType.OTHER],qrExtraData.deviceInfo);}if(deviceType===undefined||_device2.DeviceType[deviceType]===undefined){return _device.DEVICE_TYPE_INFO[_device2.DeviceType.OTHER];}return _device.DEVICE_TYPE_INFO[deviceType];};var isJSON=function isJSON(str){if(typeof str!=='string')return false;try{JSON.parse(str);return true;}catch(_e){return false;}};var extraDataEncode=exports.extraDataEncode=function(){var _ref=(0,_asyncToGenerator2.default)(function*(deviceInfo){var isNeedEncrypt=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!isNeedEncrypt){return JSON.stringify({transactionTime:Date.now(),deviceInfo:JSON.stringify(deviceInfo),version:_device.DEVICE_INFO_VERSION});}var deviceInfoJSON=JSON.stringify(deviceInfo);try{var rst=yield _apiDid.request.device.fetchEncrypt({params:{data:[deviceInfoJSON]}});var resultList=rst==null?void 0:rst.result;deviceInfoJSON=(resultList==null?void 0:resultList[0])||'';if(typeof deviceInfoJSON!=='string'||isJSON(deviceInfoJSON)){deviceInfoJSON='';}}catch(error){deviceInfoJSON='';console.log(error);}return JSON.stringify({transactionTime:Date.now(),deviceInfo:deviceInfoJSON,version:_device.DEVICE_INFO_VERSION});});return function extraDataEncode(_x){return _ref.apply(this,arguments);};}();var extraDataListDecode=exports.extraDataListDecode=function(){var _ref2=(0,_asyncToGenerator2.default)(function*(extraDataStrList){var extraDataList=extraDataStrList.map(function(extraDataStr){var extraEncodeData;try{extraEncodeData=JSON.parse(extraDataStr);if(typeof extraEncodeData!=='object'||typeof extraEncodeData==='object'&&Array.isArray(extraEncodeData)){throw new Error('error type');}if(!extraEncodeData.deviceInfo)extraEncodeData.deviceInfo='';if(typeof extraEncodeData.version!=='string')extraEncodeData.version='0.0.1';if(typeof extraEncodeData.transactionTime!=='number'||!checkDateNumber(extraEncodeData.transactionTime)){extraEncodeData.transactionTime=0;}}catch(error){extraEncodeData={deviceInfo:typeof extraDataStr!=='string'?'':extraDataStr,transactionTime:0,version:'0.0.1'};}return extraEncodeData;});var decryptDataList=[];var decryptIndexList=[];extraDataList.forEach(function(item,idx){if(!item.deviceInfo||item.version!=='2.0.0')return;decryptDataList.push(item.deviceInfo);decryptIndexList.push(idx);});try{var rst=yield _apiDid.request.device.fetchDecrypt({params:{data:decryptDataList}});var resultList=rst.result;if(Array.isArray(resultList)){resultList.forEach(function(item,idx){if(typeof item!=='string')return;extraDataList[decryptIndexList[idx]].deviceInfo=item;});}}catch(error){console.log('fetchDecrypt: error',error);}return extraDataList.map(function(item){return extraDataDecode(item);});});return function extraDataListDecode(_x2){return _ref2.apply(this,arguments);};}();var extraDataDecode=exports.extraDataDecode=function extraDataDecode(_extraData){var extraData=Object.assign({},_extraData,{deviceInfo:Object.assign({},_device.DEVICE_TYPE_INFO[_device2.DeviceType.OTHER])});var deviceInfoStr=_extraData.deviceInfo;switch(_extraData.version){case'0.0.1':var extraDataArray=deviceInfoStr.split(',').map(function(itemValue){return Number(itemValue);});var deviceType=_device2.DeviceType.OTHER,transactionTime=undefined;var firstNum=extraDataArray[0];if(firstNum!==undefined&&!isNaN(firstNum)){if(_device2.DeviceType[firstNum]!==undefined){deviceType=firstNum;}else if(checkDateNumber(firstNum)){transactionTime=firstNum;}}var secondNum=extraDataArray[1];if(transactionTime===undefined&&secondNum!==undefined&&checkDateNumber(secondNum)){transactionTime=secondNum;}if(_device.DEVICE_TYPE_INFO[deviceType]!==undefined){extraData.deviceInfo=_device.DEVICE_TYPE_INFO[deviceType];}if(transactionTime){extraData.transactionTime=transactionTime;}break;case'1.0.0':case'2.0.0':try{extraData.deviceInfo=Object.assign({},extraData.deviceInfo,JSON.parse(deviceInfoStr));}catch(error){}break;default:break;}if(extraData.deviceInfo.deviceType===undefined||_device2.DeviceType[extraData.deviceInfo.deviceType]===undefined){extraData.deviceInfo.deviceType=_device2.DeviceType.OTHER;}return extraData;};function compareVersions(v1,v2){var v1Parts=v1.split('.').map(Number);var v2Parts=v2.split('.').map(Number);for(var i=0;i<Math.max(v1Parts.length,v2Parts.length);i++){var v1Part=v1Parts[i]||0;var v2Part=v2Parts[i]||0;if(v1Part<v2Part){return-1;}else if(v1Part>v2Part){return 1;}}return 0;}