var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=GuardianHome;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _theme=require("../../../assets/theme");var _Svg=_interopRequireDefault(require("../../../components/Svg"));var _react=_interopRequireWildcard(require("react"));var _reactNative=require("react-native");var _unit=require("../../../utils/unit");var _PageContainer=_interopRequireDefault(require("../../../components/PageContainer"));var _hooks=require("../../../i18n/hooks");var _GuardianItem=_interopRequireDefault(require("../../Guardian/components/GuardianItem"));var _Touchable=_interopRequireDefault(require("../../../components/Touchable"));var _GStyles=_interopRequireDefault(require("../../../assets/theme/GStyles"));var _core=require("../../../model/verify/core");var _controller=require("../../../network/controller");var _screen=require("../../../utils/screen");var _global=require("../../../model/global");var _UseBaseContainer=_interopRequireDefault(require("../../../model/container/UseBaseContainer"));var _entries=require("../../../config/entries");var _socialRecovery=require("../../../model/verify/social-recovery");var _useEffectOnce=_interopRequireDefault(require("../../../hooks/useEffectOnce"));var _CommonToast=_interopRequireDefault(require("../../../components/CommonToast"));var _Loading=_interopRequireDefault(require("../../../components/Loading"));var _constants=require("../../../global/constants");var _verifier=require("../../../packages/types/verifier");var _handler=require("../../../model/contract/handler");var _jsxFileName="/Users/fengfeiyang/aelf/portkey-wallet/packages/rn-sdk/android/rn-sdk-finally/src/pages/GuardianManage/GuardianHome/index.tsx";function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap(),t=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r;})(e);}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&Object.prototype.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u];}return n.default=e,t&&t.set(e,n),n;}function GuardianHome(_ref){var _this=this;var containerId=_ref.containerId;var _useLanguage=(0,_hooks.useLanguage)(),t=_useLanguage.t;var _useState=(0,_react.useState)([]),_useState2=(0,_slicedToArray2.default)(_useState,2),verifierMap=_useState2[0],setVerifierMap=_useState2[1];var verifierList=(0,_react.useMemo)(function(){return verifierMap?Object.values(verifierMap):[];},[verifierMap]);(0,_useEffectOnce.default)((0,_asyncToGenerator2.default)(function*(){_Loading.default.show();var _yield$getOrReadCache=yield(0,_handler.getOrReadCachedVerifierData)(),data=_yield$getOrReadCache.data;var _ref3=data||{},verifiers=_ref3.verifierServers;console.log('verifiers',JSON.stringify(verifiers));verifiers&&setVerifierMap(verifiers);yield refreshGuardianInfo();_Loading.default.hide();}));var _useBaseContainer=(0,_UseBaseContainer.default)({entryName:_entries.PortkeyEntries.GUARDIAN_HOME_ENTRY,onNewIntent:function(){var _onNewIntent=(0,_asyncToGenerator2.default)(function*(intent){console.log('GuardianHome onNewIntent',intent);switch(intent.type){case _socialRecovery.GuardianVerifyType.ADD_GUARDIAN:{if(intent.result==='success'){_CommonToast.default.success('Add guardian success',1000);}else{_CommonToast.default.fail('Add guardian fail');}break;}case _socialRecovery.GuardianVerifyType.MODIFY_GUARDIAN:{if(intent.result==='success'){_CommonToast.default.success('Edit guardian success',1000);}else{_CommonToast.default.fail('Edit guardian fail');}break;}case _socialRecovery.GuardianVerifyType.REMOVE_GUARDIAN:{if(intent.result==='success'){_CommonToast.default.success('Remove guardian success',1000);}else{_CommonToast.default.fail('Remove guardian fail');}break;}}});function onNewIntent(_x){return _onNewIntent.apply(this,arguments);}return onNewIntent;}(),onShow:function(){var _onShow=(0,_asyncToGenerator2.default)(function*(){_Loading.default.show();yield refreshGuardianInfo();_Loading.default.hide();});function onShow(){return _onShow.apply(this,arguments);}return onShow;}(),containerId:containerId}),navigationTo=_useBaseContainer.navigateTo,navigateForResult=_useBaseContainer.navigateForResult;var _useState3=(0,_react.useState)([]),_useState4=(0,_slicedToArray2.default)(_useState3,2),guardianList=_useState4[0],setGuardianList=_useState4[1];var userGuardiansList=(0,_react.useMemo)(function(){if(!guardianList)return[];return guardianList.map(function(item,index){var verifier=verifierList.find(function(v){return v.id===item.verifierId;});var parsedItem=Object.assign({},item,{identifierHash:item.identifierHash,guardianAccount:item.guardianIdentifier,isLoginAccount:item.isLoginGuardian,guardianType:(0,_global.guardianTypeStrToEnum)(item.type),key:""+index,verifier:verifier});return parsedItem;}).reverse();},[guardianList,verifierList]);var refreshGuardianInfo=(0,_react.useCallback)((0,_asyncToGenerator2.default)(function*(){var _config$caInfo,_guardianInfo$guardia;var config=yield(0,_core.getTempWalletConfig)();var guardianInfo=yield _controller.NetworkController.getGuardianInfo(config.accountIdentifier,config==null?void 0:(_config$caInfo=config.caInfo)==null?void 0:_config$caInfo.caHash);if(guardianInfo!=null&&(_guardianInfo$guardia=guardianInfo.guardianList)!=null&&_guardianInfo$guardia.guardians){var _guardianInfo$guardia2;setGuardianList(guardianInfo==null?void 0:(_guardianInfo$guardia2=guardianInfo.guardianList)==null?void 0:_guardianInfo$guardia2.guardians);}}),[]);var renderGuardianBtn=(0,_react.useCallback)(function(){return _react.default.createElement(_Svg.default,{icon:"right-arrow",color:_theme.defaultColors.icon1,size:(0,_unit.pTd)(16),__self:_this,__source:{fileName:_jsxFileName,lineNumber:117,columnNumber:11}});},[]);return _react.default.createElement(_PageContainer.default,{safeAreaColor:['blue','white'],titleDom:t('Guardians'),containerStyles:pageStyles.pageWrap,scrollViewProps:{disabled:false},rightDom:_react.default.createElement(_reactNative.TouchableOpacity,{style:{padding:(0,_unit.pTd)(16)},onPress:function onPress(){navigationTo(_entries.PortkeyEntries.ADD_GUARDIAN_ENTRY,{});},__self:this,__source:{fileName:_jsxFileName,lineNumber:128,columnNumber:9}},_react.default.createElement(_Svg.default,{icon:"add1",size:(0,_unit.pTd)(20),color:_theme.defaultColors.font2,__self:this,__source:{fileName:_jsxFileName,lineNumber:133,columnNumber:11}})),__self:this,__source:{fileName:_jsxFileName,lineNumber:122,columnNumber:5}},_react.default.createElement(_reactNative.View,{__self:this,__source:{fileName:_jsxFileName,lineNumber:136,columnNumber:7}},userGuardiansList.map(function(guardian,idx){return _react.default.createElement(_Touchable.default,{key:idx,onPress:(0,_asyncToGenerator2.default)(function*(){var _yield$getOrReadCache2,_yield$getOrReadCache3;var chainId=yield _constants.PortkeyConfig.currChainId();var cachedVerifierData=Object.values((_yield$getOrReadCache2=(_yield$getOrReadCache3=(yield(0,_handler.getOrReadCachedVerifierData)()).data)==null?void 0:_yield$getOrReadCache3.verifierServers)!=null?_yield$getOrReadCache2:{});navigateForResult(_entries.PortkeyEntries.GUARDIAN_DETAIL_ENTRY,{closeCurrentScreen:false,params:{info:JSON.stringify({particularGuardianInfo:(0,_global.parseGuardianInfo)(guardianList[Number(guardian.key)],chainId,cachedVerifierData,undefined,'',_core.AccountOriginalType.Email,_verifier.OperationTypeEnum.editGuardian),originalGuardianItem:guardian})}});}),__self:_this,__source:{fileName:_jsxFileName,lineNumber:138,columnNumber:11}},_react.default.createElement(_GuardianItem.default,{guardianItem:guardian,isButtonHide:true,renderBtn:renderGuardianBtn,isBorderHide:idx===guardianList.length-1,__self:_this,__source:{fileName:_jsxFileName,lineNumber:163,columnNumber:13}}));})));}var pageStyles=_reactNative.StyleSheet.create({pageWrap:Object.assign({flex:1,backgroundColor:_theme.defaultColors.bg1,paddingBottom:(0,_screen.getBottomSpace)()},_GStyles.default.paddingArg(16,20))});