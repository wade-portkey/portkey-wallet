var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=VerifierDetails;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _misc=require("../../../packages/constants/misc");var _GStyles=_interopRequireDefault(require("../../../assets/theme/GStyles"));var _CommonText=require("../../../components/CommonText");var _VerifierCountdown=_interopRequireDefault(require("../../../components/VerifierCountdown"));var _PageContainer=_interopRequireDefault(require("../../../components/PageContainer"));var _DigitInput=_interopRequireDefault(require("../../../components/DigitInput"));var _react=_interopRequireWildcard(require("react"));var _reactNative=require("react-native");var _verifier=require("../../../packages/types/verifier");var _styles=require("../../../assets/theme/styles");var _wallet=require("../../../packages/types/types-ca/wallet");var _guardian=_interopRequireWildcard(require("../../../model/verify/guardian"));var _controller=require("../../../network/controller");var _VerifyHumanMachine=require("../../../components/VerifyHumanMachine");var _Loading=_interopRequireDefault(require("../../../components/Loading"));var _UseBaseContainer=_interopRequireDefault(require("../../../model/container/UseBaseContainer"));var _entries=require("../../../config/entries");var _GuardianItem=_interopRequireDefault(require("../components/GuardianItem"));var _CommonToast=_interopRequireDefault(require("../../../components/CommonToast"));var _useEffectOnce=_interopRequireDefault(require("../../../hooks/useEffectOnce"));var _jsxFileName="/Users/fengfeiyang/aelf/portkey-wallet/packages/rn-sdk/android/rn-sdk-finally/src/pages/Guardian/VerifierDetails/index.tsx";function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap(),t=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r;})(e);}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&Object.prototype.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u];}return n.default=e,t&&t.set(e,n),n;}function TipText(_ref){var guardianAccount=_ref.guardianAccount,isRegister=_ref.isRegister;var _useMemo=(0,_react.useMemo)(function(){if(!isRegister)return["Please contact your guardians, and enter the "+_misc.DIGIT_CODE.length+"-digit code sent to "," within "+_misc.DIGIT_CODE.expiration+" minutes."];return["A "+_misc.DIGIT_CODE.length+"-digit code was sent to "," Enter it within "+_misc.DIGIT_CODE.expiration+" minutes"];},[isRegister]),_useMemo2=(0,_slicedToArray2.default)(_useMemo,2),first=_useMemo2[0],last=_useMemo2[1];return _react.default.createElement(_CommonText.TextM,{style:[_styles.FontStyles.font3,_GStyles.default.marginTop(16),_GStyles.default.marginBottom(50)],__self:this,__source:{fileName:_jsxFileName,lineNumber:35,columnNumber:5}},first,_react.default.createElement(_reactNative.Text,{style:_styles.FontStyles.font4,__self:this,__source:{fileName:_jsxFileName,lineNumber:37,columnNumber:7}},guardianAccount),last);}function VerifierDetails(_ref2){var _guardianConfig$name,_guardianConfig$image,_guardianConfig$salt;var guardianConfig=_ref2.guardianConfig,operationType=_ref2.operationType;var _useBaseContainer=(0,_UseBaseContainer.default)({entryName:_entries.PortkeyEntries.VERIFIER_DETAIL_ENTRY}),onFinish=_useBaseContainer.onFinish;var realOperationType=operationType!==_verifier.OperationTypeEnum.unknown?operationType:guardianConfig.sendVerifyCodeParams.operationType;var guardianItem={guardianAccount:guardianConfig.sendVerifyCodeParams.guardianIdentifier,guardianType:guardianConfig.sendVerifyCodeParams.type==='Phone'?_wallet.LoginType.Phone:_wallet.LoginType.Email,verifier:{id:guardianConfig.sendVerifyCodeParams.verifierId,name:(_guardianConfig$name=guardianConfig.name)!=null?_guardianConfig$name:'Portkey',imageUrl:(_guardianConfig$image=guardianConfig.imageUrl)!=null?_guardianConfig$image:''},isLoginAccount:guardianConfig.isLoginGuardian,key:'0',identifierHash:'',salt:(_guardianConfig$salt=guardianConfig.salt)!=null?_guardianConfig$salt:''};var guardianInfo=(0,_react.useMemo)(function(){var parsedGuardian=JSON.parse(JSON.stringify(guardianConfig));parsedGuardian.sendVerifyCodeParams.operationType=realOperationType;return parsedGuardian;},[guardianConfig,realOperationType]);var _usePhoneOrEmailGuard=(0,_guardian.default)(guardianInfo),countDownNumber=_usePhoneOrEmailGuard.countDown,sendVerifyCode=_usePhoneOrEmailGuard.sendVerifyCode,checkVerifyCode=_usePhoneOrEmailGuard.checkVerifyCode;var tryToResendCode=function(){var _ref3=(0,_asyncToGenerator2.default)(function*(){if(countDownNumber>0){console.error("countDown: "+countDownNumber);return;}try{var token;_Loading.default.show();var needRecaptcha=yield _controller.NetworkController.isGoogleRecaptchaOpen(realOperationType);if(needRecaptcha){token=yield(0,_VerifyHumanMachine.verifyHumanMachine)('en');}var sendSuccess=yield sendVerifyCode(token);if(sendSuccess){var _countdown$current;(_countdown$current=countdown.current)==null?void 0:_countdown$current.resetTime(_guardian.INIT_TIME_OUT);_Loading.default.hide();return;}}catch(e){_Loading.default.hide();}_CommonToast.default.fail('Network error, please try again.');});return function tryToResendCode(){return _ref3.apply(this,arguments);};}();var onPageFinish=function onPageFinish(result){onFinish({status:result?'success':'fail',data:{verifiedData:result?JSON.stringify(result):''}});};var onInputFinish=function(){var _ref4=(0,_asyncToGenerator2.default)(function*(code){var _digitInput$current2;try{_Loading.default.show();var result=yield checkVerifyCode(code);_Loading.default.hide();if(result!=null&&result.signature&&result!=null&&result.verificationDoc){onPageFinish(result);return;}else if(result!=null&&result.failedBecauseOfTooManyRequests){var _digitInput$current;(_digitInput$current=digitInput.current)==null?void 0:_digitInput$current.reset();_CommonToast.default.fail('Too many retries');return;}}catch(e){_Loading.default.hide();}(_digitInput$current2=digitInput.current)==null?void 0:_digitInput$current2.reset();_CommonToast.default.fail('Verification code is incorrect');});return function onInputFinish(_x){return _ref4.apply(this,arguments);};}();var onBack=function onBack(){onPageFinish(null);};var countdown=(0,_react.useRef)();var digitInput=(0,_react.useRef)();(0,_useEffectOnce.default)(function(){if(guardianConfig.alreadySent){var _countdown$current2;(_countdown$current2=countdown.current)==null?void 0:_countdown$current2.resetTime(_guardian.INIT_TIME_OUT);}});return _react.default.createElement(_PageContainer.default,{type:"leftBack",titleDom:"VerifierDetails",safeAreaColor:['white'],leftCallback:onBack,containerStyles:styles.containerStyles,scrollViewProps:{disabled:true},__self:this,__source:{fileName:_jsxFileName,lineNumber:145,columnNumber:5}},guardianItem?_react.default.createElement(_GuardianItem.default,{guardianItem:guardianItem,isButtonHide:true,__self:this,__source:{fileName:_jsxFileName,lineNumber:152,columnNumber:23}}):null,_react.default.createElement(TipText,{isRegister:realOperationType===_verifier.OperationTypeEnum.register,guardianAccount:guardianItem==null?void 0:guardianItem.guardianAccount,__self:this,__source:{fileName:_jsxFileName,lineNumber:153,columnNumber:7}}),_react.default.createElement(_DigitInput.default,{ref:digitInput,onFinish:onInputFinish,maxLength:_misc.DIGIT_CODE.length,__self:this,__source:{fileName:_jsxFileName,lineNumber:157,columnNumber:7}}),_react.default.createElement(_VerifierCountdown.default,{style:_GStyles.default.marginTop(24),onResend:tryToResendCode,ref:countdown,__self:this,__source:{fileName:_jsxFileName,lineNumber:158,columnNumber:7}}));}var styles=_reactNative.StyleSheet.create({containerStyles:{paddingTop:8,paddingHorizontal:20}});