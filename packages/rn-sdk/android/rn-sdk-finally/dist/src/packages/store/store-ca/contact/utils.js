Object.defineProperty(exports,"__esModule",{value:true});exports.transIndexesToContactRelationIdMap=exports.transIndexesToContactMap=exports.transIndexesToContactIdMap=exports.transContactsToIndexes=exports.sortContactIndexList=exports.getInitContactIndexList=exports.getContactIdMap=exports.executeEventToContactIndexList=void 0;var CHAR_CODE_A='A'.charCodeAt(0);var OTHER_INDEX=26;var transIndexesToContactMap=exports.transIndexesToContactMap=function transIndexesToContactMap(contactIndexList){var contactMap={};contactIndexList.forEach(function(contactIndex){contactIndex.contacts.forEach(function(contact){var addressList=Array.from(new Set(contact.addresses.map(function(addressItem){return addressItem.address;})));addressList.forEach(function(address){if(contactMap[address])contactMap[address].push(contact);else contactMap[address]=[contact];});});});return contactMap;};var transIndexesToContactRelationIdMap=exports.transIndexesToContactRelationIdMap=function transIndexesToContactRelationIdMap(contactIndexList){var contactRelationIdMap={};contactIndexList.forEach(function(contactIndex){contactIndex.contacts.forEach(function(contact){var _contact$imInfo;if((_contact$imInfo=contact.imInfo)!=null&&_contact$imInfo.relationId){var _contact$imInfo2,_contact$imInfo3,_contact$imInfo4;if(contactRelationIdMap[(_contact$imInfo2=contact.imInfo)==null?void 0:_contact$imInfo2.relationId])contactRelationIdMap[(_contact$imInfo3=contact.imInfo)==null?void 0:_contact$imInfo3.relationId].push(contact);else contactRelationIdMap[(_contact$imInfo4=contact.imInfo)==null?void 0:_contact$imInfo4.relationId]=[contact];}});});return contactRelationIdMap;};var transIndexesToContactIdMap=exports.transIndexesToContactIdMap=function transIndexesToContactIdMap(contactIndexList){var contactIdMap={};contactIndexList.forEach(function(contactIndex){contactIndex.contacts.forEach(function(contact){if(contactIdMap[contact.id])contactIdMap[contact.id].push(contact);else contactIdMap[contact.id]=[contact];});});return contactIdMap;};var getIndexFromChar=function getIndexFromChar(char){return char==='#'?OTHER_INDEX:char.charCodeAt(0)-CHAR_CODE_A;};var getInitContactIndexList=exports.getInitContactIndexList=function getInitContactIndexList(){return new Array(27).fill('').map(function(_,i){var index=i===OTHER_INDEX?'#':String.fromCharCode(CHAR_CODE_A+i);return{index:index,contacts:[]};});};var transContactsToIndexes=exports.transContactsToIndexes=function transContactsToIndexes(contacts){var contactIndexList=getInitContactIndexList();contacts.forEach(function(contact){var idx=getIndexFromChar(contact.index);contactIndexList[idx].contacts.push(contact);});return contactIndexList;};var sortContactIndexList=exports.sortContactIndexList=function sortContactIndexList(contactIndexList){contactIndexList.forEach(function(contactIndex){contactIndex.contacts.sort(function(a,b){return a.name.localeCompare(b.name);});});return contactIndexList;};var getContactIdMap=exports.getContactIdMap=function getContactIdMap(contactIndexList){var contactIdMap={};contactIndexList.forEach(function(contactIndex){contactIndex.contacts.forEach(function(contactItem){contactIdMap[contactItem.id]=contactItem;});});return contactIdMap;};var aggregateEvent=function aggregateEvent(_eventList){var eventMap={};_eventList.forEach(function(event){if(!eventMap[event.id]||eventMap[event.id].modificationTime<event.modificationTime){eventMap[event.id]=event;}});return Object.values(eventMap).sort(function(a,b){return a.modificationTime-b.modificationTime;});};var executeEventToContactIndexList=exports.executeEventToContactIndexList=function executeEventToContactIndexList(contactIndexList,eventList){var contactIdMap=getContactIdMap(contactIndexList);eventList=aggregateEvent(eventList);eventList.forEach(function(event){var contactIndex=contactIndexList[getIndexFromChar(event.index)];if(!contactIdMap[event.id]){if(!event.isDeleted){contactIdMap[event.id]=event;contactIndex.contacts.push(event);}return;}var contactItemIndex=contactIndex.contacts.findIndex(function(item){return item.id===event.id;});if(event.isDeleted){delete contactIdMap[event.id];contactIndex.contacts.splice(contactItemIndex,1);return;}var preContactItem=contactIdMap[event.id];if(preContactItem.modificationTime>event.modificationTime){console.log('expired event:',{event:event,contactIndex:contactIndex,contactItemIndex:contactItemIndex});return;}if(preContactItem.index!==event.index){var preContactIndex=contactIndexList[getIndexFromChar(preContactItem.index)];var preContactItemIndex=preContactIndex.contacts.findIndex(function(item){return item.id===preContactItem.id;});preContactIndex.contacts.splice(preContactItemIndex,1);contactIndex.contacts.push(event);}else{contactIndex.contacts[contactItemIndex]=event;}contactIdMap[event.id]=event;});return contactIndexList;};