var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.DappManager=exports.BaseDappManager=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _actions=require("packages/types/store-ca/dapp/actions");var _index=require("./index");var _browser=require("./browser");var _network=require("../../constants/constants-ca/network");function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=(0,_getPrototypeOf2.default)(Derived),result;if(hasNativeReflectConstruct){var NewTarget=(0,_getPrototypeOf2.default)(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return(0,_possibleConstructorReturn2.default)(this,result);};}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}var BaseDappManager=exports.BaseDappManager=(0,_createClass2.default)(function BaseDappManager(options){(0,_classCallCheck2.default)(this,BaseDappManager);(0,_defineProperty2.default)(this,"store",void 0);this.store=options.store;});var DappManager=exports.DappManager=function(_ref){(0,_inherits2.default)(DappManager,_ref);var _super=_createSuper(DappManager);function DappManager(){(0,_classCallCheck2.default)(this,DappManager);return _super.apply(this,arguments);}(0,_createClass2.default)(DappManager,[{key:"getState",value:function(){var _getState=(0,_asyncToGenerator2.default)(function*(){return this.store.getState();});function getState(){return _getState.apply(this,arguments);}return getState;}()},{key:"getWallet",value:function(){var _getWallet=(0,_asyncToGenerator2.default)(function*(){return(yield this.getState()).wallet;});function getWallet(){return _getWallet.apply(this,arguments);}return getWallet;}()},{key:"walletName",value:function(){var _walletName=(0,_asyncToGenerator2.default)(function*(){return(yield this.getWallet()).walletName;});function walletName(){return _walletName.apply(this,arguments);}return walletName;}()},{key:"networkType",value:function(){var _networkType=(0,_asyncToGenerator2.default)(function*(){return(yield this.getWallet()).currentNetwork;});function networkType(){return _networkType.apply(this,arguments);}return networkType;}()},{key:"getOriginInfo",value:function(){var _getOriginInfo=(0,_asyncToGenerator2.default)(function*(origin){var _yield$this$getState=yield this.getState(),wallet=_yield$this$getState.wallet,dapp=_yield$this$getState.dapp;return(0,_index.handleOriginInfo)({wallet:wallet,dapp:dapp,origin:origin});});function getOriginInfo(_x){return _getOriginInfo.apply(this,arguments);}return getOriginInfo;}()},{key:"originIsAuthorized",value:function(){var _originIsAuthorized=(0,_asyncToGenerator2.default)(function*(origin){return!!(yield this.getOriginInfo(origin));});function originIsAuthorized(_x2){return _originIsAuthorized.apply(this,arguments);}return originIsAuthorized;}()},{key:"getCurrentCAInfo",value:function(){var _getCurrentCAInfo=(0,_asyncToGenerator2.default)(function*(){var wallet=yield this.getWallet();return(0,_index.handleCurrentCAInfo)(wallet);});function getCurrentCAInfo(){return _getCurrentCAInfo.apply(this,arguments);}return getCurrentCAInfo;}()},{key:"getCaInfo",value:function(){var _getCaInfo=(0,_asyncToGenerator2.default)(function*(chainId){var _yield$this$getCurren;return(_yield$this$getCurren=yield this.getCurrentCAInfo())==null?void 0:_yield$this$getCurren[chainId];});function getCaInfo(_x3){return _getCaInfo.apply(this,arguments);}return getCaInfo;}()},{key:"getCurrentChainList",value:function(){var _getCurrentChainList=(0,_asyncToGenerator2.default)(function*(){var _yield$this$getWallet=yield this.getWallet(),chainInfo=_yield$this$getWallet.chainInfo,currentNetwork=_yield$this$getWallet.currentNetwork;return chainInfo==null?void 0:chainInfo[currentNetwork];});function getCurrentChainList(){return _getCurrentChainList.apply(this,arguments);}return getCurrentChainList;}()},{key:"getChainInfo",value:function(){var _getChainInfo=(0,_asyncToGenerator2.default)(function*(chainId){var _yield$this$getCurren2;return(_yield$this$getCurren2=yield this.getCurrentChainList())==null?void 0:_yield$this$getCurren2.find(function(info){return info.chainId===chainId;});});function getChainInfo(_x4){return _getChainInfo.apply(this,arguments);}return getChainInfo;}()},{key:"addDapp",value:function(){var _addDapp2=(0,_asyncToGenerator2.default)(function*(dapp){var _yield$this$getWallet2=yield this.getWallet(),currentNetwork=_yield$this$getWallet2.currentNetwork;this.store.dispatch((0,_actions.addDapp)({networkType:currentNetwork,dapp:dapp}));});function addDapp(_x5){return _addDapp2.apply(this,arguments);}return addDapp;}()},{key:"updateDapp",value:function(){var _updateDapp2=(0,_asyncToGenerator2.default)(function*(dapp){var _yield$Promise$all=yield Promise.all([this.getWallet(),this.getOriginInfo(dapp.origin)]),_yield$Promise$all2=(0,_slicedToArray2.default)(_yield$Promise$all,2),currentNetwork=_yield$Promise$all2[0].currentNetwork,originInfo=_yield$Promise$all2[1];if((0,_browser.isEqDapp)(dapp,originInfo))return;this.store.dispatch((0,_actions.updateDapp)({origin:dapp.origin,networkType:currentNetwork,dapp:dapp}));});function updateDapp(_x6){return _updateDapp2.apply(this,arguments);}return updateDapp;}()},{key:"getOriginChainId",value:function(){var _getOriginChainId=(0,_asyncToGenerator2.default)(function*(){var _yield$Promise$all3=yield Promise.all([this.getWallet(),this.getCurrentCAInfo()]),_yield$Promise$all4=(0,_slicedToArray2.default)(_yield$Promise$all3,2),walletOriginChainId=_yield$Promise$all4[0].originChainId,currentCAInfo=_yield$Promise$all4[1];return(currentCAInfo==null?void 0:currentCAInfo.originChainId)||walletOriginChainId||_network.DefaultChainId;});function getOriginChainId(){return _getOriginChainId.apply(this,arguments);}return getOriginChainId;}()},{key:"isLogged",value:function(){var _isLogged=(0,_asyncToGenerator2.default)(function*(){var _walletInfo$caInfo$cu;var _yield$Promise$all5=yield Promise.all([this.getWallet(),this.getOriginChainId()]),_yield$Promise$all6=(0,_slicedToArray2.default)(_yield$Promise$all5,2),_yield$Promise$all6$=_yield$Promise$all6[0],walletInfo=_yield$Promise$all6$.walletInfo,currentNetwork=_yield$Promise$all6$.currentNetwork,originChainId=_yield$Promise$all6[1];return!!(originChainId&&walletInfo!=null&&(_walletInfo$caInfo$cu=walletInfo.caInfo[currentNetwork])!=null&&_walletInfo$caInfo$cu.managerInfo);});function isLogged(){return _isLogged.apply(this,arguments);}return isLogged;}()},{key:"isActive",value:function(){var _isActive=(0,_asyncToGenerator2.default)(function*(origin){return(yield this.originIsAuthorized(origin))&&(yield this.isLogged());});function isActive(_x7){return _isActive.apply(this,arguments);}return isActive;}()},{key:"accounts",value:function(){var _accounts=(0,_asyncToGenerator2.default)(function*(origin){var _wallet$walletInfo;var _yield$Promise$all7=yield Promise.all([this.getWallet(),this.isActive(origin)]),_yield$Promise$all8=(0,_slicedToArray2.default)(_yield$Promise$all7,2),wallet=_yield$Promise$all8[0],active=_yield$Promise$all8[1];if(!active||!((_wallet$walletInfo=wallet.walletInfo)!=null&&_wallet$walletInfo.caInfo))return{};return(0,_index.handleAccounts)(wallet);});function accounts(_x8){return _accounts.apply(this,arguments);}return accounts;}()},{key:"chainId",value:function(){var _chainId=(0,_asyncToGenerator2.default)(function*(){return this.chainIds();});function chainId(){return _chainId.apply(this,arguments);}return chainId;}()},{key:"chainIds",value:function(){var _chainIds=(0,_asyncToGenerator2.default)(function*(){if(!this.isLogged())return[];var wallet=yield this.getWallet();return(0,_index.handleChainIds)(wallet);});function chainIds(){return _chainIds.apply(this,arguments);}return chainIds;}()},{key:"chainsInfo",value:function(){var _chainsInfo=(0,_asyncToGenerator2.default)(function*(){var _yield$this$getCurren3;var chainsInfo={};(_yield$this$getCurren3=yield this.getCurrentChainList())==null?void 0:_yield$this$getCurren3.forEach(function(chainInfo){var tmpChainInfo=Object.assign({},chainInfo);tmpChainInfo.lastModifyTime&&delete tmpChainInfo.lastModifyTime;tmpChainInfo.id&&delete tmpChainInfo.id;chainsInfo[chainInfo.chainId]=[tmpChainInfo];});return chainsInfo;});function chainsInfo(){return _chainsInfo.apply(this,arguments);}return chainsInfo;}()},{key:"getRpcUrl",value:function(){var _getRpcUrl=(0,_asyncToGenerator2.default)(function*(chainId){var _yield$this$getChainI;return(_yield$this$getChainI=yield this.getChainInfo(chainId))==null?void 0:_yield$this$getChainI.endPoint;});function getRpcUrl(_x9){return _getRpcUrl.apply(this,arguments);}return getRpcUrl;}()},{key:"getSessionInfo",value:function(){var _getSessionInfo=(0,_asyncToGenerator2.default)(function*(origin){var originInfo=yield this.getOriginInfo(origin);return originInfo==null?void 0:originInfo.sessionInfo;});function getSessionInfo(_x10){return _getSessionInfo.apply(this,arguments);}return getSessionInfo;}()},{key:"getRememberMeBlackList",value:function(){var _getRememberMeBlackList=(0,_asyncToGenerator2.default)(function*(){var _state$cms$rememberMe,_state$cms$rememberMe2;var _yield$Promise$all9=yield Promise.all([this.networkType(),this.getState()]),_yield$Promise$all10=(0,_slicedToArray2.default)(_yield$Promise$all9,2),currentNetwork=_yield$Promise$all10[0],state=_yield$Promise$all10[1];return(_state$cms$rememberMe=state.cms.rememberMeBlackListMap)==null?void 0:(_state$cms$rememberMe2=_state$cms$rememberMe[currentNetwork])==null?void 0:_state$cms$rememberMe2.map(function(_ref2){var url=_ref2.url;return url;});});function getRememberMeBlackList(){return _getRememberMeBlackList.apply(this,arguments);}return getRememberMeBlackList;}()}]);return DappManager;}(BaseDappManager);