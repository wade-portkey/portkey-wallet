var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});var _exportNames={IM:true,utils:true};exports.utils=exports.default=exports.IM=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _im=_interopRequireWildcard(require("@relationlabs/im"));var utils=_interopRequireWildcard(require("./utils"));exports.utils=utils;var _types=require("./types");Object.keys(_types).forEach(function(key){if(key==="default"||key==="__esModule")return;if(Object.prototype.hasOwnProperty.call(_exportNames,key))return;if(key in exports&&exports[key]===_types[key])return;Object.defineProperty(exports,key,{enumerable:true,get:function get(){return _types[key];}});});var _utils2=require("../utils");var _config=require("./config");var _request=require("@portkey/request");var _service=require("./service");var _constant=require("./constant");var _apiDid=require("../api/api-did");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap(),t=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r;})(e);}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&Object.prototype.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u];}return n.default=e,t&&t.set(e,n),n;}var IM=exports.IM=function(){function IM(){var _this=this;(0,_classCallCheck2.default)(this,IM);(0,_defineProperty2.default)(this,"_imInstance",void 0);(0,_defineProperty2.default)(this,"_channelMsgObservers",new Map());(0,_defineProperty2.default)(this,"_unreadMsgObservers",new Map());(0,_defineProperty2.default)(this,"_connectObservers",new Map());(0,_defineProperty2.default)(this,"_msgCountObservers",new Map());(0,_defineProperty2.default)(this,"_tokenObservers",new Map());(0,_defineProperty2.default)(this,"_msgCount",{unreadCount:0,mentionsCount:0});(0,_defineProperty2.default)(this,"_account",void 0);(0,_defineProperty2.default)(this,"_caHash",void 0);(0,_defineProperty2.default)(this,"status",_types.IMStatusEnum.INIT);(0,_defineProperty2.default)(this,"config",void 0);(0,_defineProperty2.default)(this,"service",void 0);(0,_defineProperty2.default)(this,"fetchRequest",void 0);(0,_defineProperty2.default)(this,"onConnectOk",function(e){console.log('CONNECT_OK');_this.updateConnectObservers(e);});(0,_defineProperty2.default)(this,"onConnectErr",function(e){console.log('CONNECT_ERR',e);});(0,_defineProperty2.default)(this,"onConnectClose",function(){var _ref=(0,_asyncToGenerator2.default)(function*(e){console.log('CONNECT_CLOSE msg',e);if(_this.status===_types.IMStatusEnum.DESTROY){console.log('CONNECT_CLOSE DESTROY');return;}_this.bindOffRelation();yield(0,_utils2.sleep)(1000);try{_this.status=_types.IMStatusEnum.INIT;_this.initRelationIM();}catch(error){console.log('initRelationIM error',error);}});return function(_x){return _ref.apply(this,arguments);};}());(0,_defineProperty2.default)(this,"onReceiveMessage",function(e){console.log('RECEIVE_MSG_OK msg',e);var rawMsg=e['im-message'];var channelId=rawMsg.channelUuid;var channelObservers=_this._channelMsgObservers.get(channelId);if(channelObservers){channelObservers.forEach(function(cb){cb(e);});}else{_this.updateUnreadMsgObservers(e);if(rawMsg.mute)return;_this.updateMessageCount(Object.assign({},_this._msgCount,{unreadCount:_this._msgCount.unreadCount+1}));}});(0,_defineProperty2.default)(this,"refreshMessageCount",(0,_asyncToGenerator2.default)(function*(){var _yield$im$service$get=yield im.service.getUnreadCount(),messageCount=_yield$im$service$get.data;console.log('refreshMessageCount',messageCount);im.updateMessageCount(messageCount);return messageCount;}));this.config=new _config.IMConfig({requestDefaults:{headers:{'R-Authorization':'invalid_authorization',Accept:'application/json, text/plain, */*'}}});this.fetchRequest=new _request.FetchRequest(this.config.requestConfig);this.service=new _service.IMService(this.fetchRequest);this.rewriteFetch();}(0,_createClass2.default)(IM,[{key:"init",value:function(){var _init=(0,_asyncToGenerator2.default)(function*(account,caHash,token){this.status=_types.IMStatusEnum.INIT;this._account=account;this._caHash=caHash;return this.initRelationIM(token);});function init(_x2,_x3,_x4){return _init.apply(this,arguments);}return init;}()},{key:"initRelationIM",value:function(){var _initRelationIM=(0,_asyncToGenerator2.default)(function*(token){var _this2=this;if(!this._account||!this._caHash){throw new Error('no account or caHash');}if(this.status===_types.IMStatusEnum.AUTHORIZING){throw new Error('IM is authorizing');}this.status=_types.IMStatusEnum.AUTHORIZING;try{var account=this._account;var caHash=this._caHash;if(!token){var _yield$this$service$v=yield this.service.verifySignatureLoop(function(){return utils.getVerifyData(account,caHash);},function(){return caHash===_this2._caHash;}),verifyResult=_yield$this$service$v.data;var addressAuthToken=verifyResult.token;var _yield$this$service$g=yield this.service.getAuthTokenLoop({addressAuthToken:addressAuthToken},function(){return caHash===_this2._caHash;}),autoResult=_yield$this$service$g.data;token=autoResult.token;this.updateToken(token);}else{console.log('use local token',token);}this.setAuthorization(token);this._imInstance=_im.default.init({token:token,apiKey:undefined,connect:true,refresh:true});this.bindRelation(this._imInstance);this.status=_types.IMStatusEnum.AUTHORIZED;this.refreshMessageCount();var _yield$this$service$g2=yield this.service.getUserInfo(),userInfo=_yield$this$service$g2.data;return userInfo;}catch(error){console.log('init error',error);this.status=_types.IMStatusEnum.INIT;throw error;}});function initRelationIM(_x5){return _initRelationIM.apply(this,arguments);}return initRelationIM;}()},{key:"bindRelation",value:function bindRelation(imInstance){imInstance.bind(_im.Im.CONNECT_OK,this.onConnectOk);imInstance.bind(_im.Im.CONNECT_ERR,this.onConnectErr);imInstance.bind(_im.Im.CONNECT_CLOSE,this.onConnectClose);imInstance.bind(_im.Im.RECEIVE_MSG_OK,this.onReceiveMessage);}},{key:"bindOffRelation",value:function bindOffRelation(){if(!this._imInstance)return;var imInstance=this._imInstance;imInstance.bindOff(_im.Im.CONNECT_OK,this.onConnectOk);imInstance.bindOff(_im.Im.CONNECT_ERR,this.onConnectErr);imInstance.bindOff(_im.Im.CONNECT_CLOSE,this.onConnectClose);imInstance.bindOff(_im.Im.RECEIVE_MSG_OK,this.onReceiveMessage);}},{key:"getInstance",value:function getInstance(){return this._imInstance;}},{key:"registerUnreadMsgObservers",value:function registerUnreadMsgObservers(cb){var symbol=Symbol();var unreadMsgObservers=this._unreadMsgObservers;unreadMsgObservers.set(symbol,cb);return{remove:function remove(){unreadMsgObservers.has(symbol)&&unreadMsgObservers.delete(symbol);}};}},{key:"updateUnreadMsgObservers",value:function updateUnreadMsgObservers(e){this._unreadMsgObservers.forEach(function(cb){cb(e);});}},{key:"registerChannelMsgObserver",value:function registerChannelMsgObserver(channelId,cb){var symbol=Symbol();var channelMsgObservers=this._channelMsgObservers;var channelObservers=channelMsgObservers.get(channelId);if(channelObservers){channelObservers.set(symbol,cb);}else{channelObservers=new Map([[symbol,cb]]);channelMsgObservers.set(channelId,channelObservers);}return{remove:function remove(){var channelObservers=channelMsgObservers.get(channelId);if(!channelObservers)return;channelObservers.has(symbol)&&channelObservers.delete(symbol);if(channelObservers.size===0){channelMsgObservers.delete(channelId);}}};}},{key:"registerConnectObserver",value:function registerConnectObserver(cb){var symbol=Symbol();var connectObservers=this._connectObservers;connectObservers.set(symbol,cb);return{remove:function remove(){connectObservers.has(symbol)&&connectObservers.delete(symbol);}};}},{key:"updateConnectObservers",value:function updateConnectObservers(e){this._connectObservers.forEach(function(cb){cb(e);});}},{key:"getMessageCount",value:function getMessageCount(){return this._msgCount||{unreadCount:0,mentionsCount:0};}},{key:"registerMessageCountObserver",value:function registerMessageCountObserver(cb){var symbol=Symbol();var msgCountObservers=this._msgCountObservers;msgCountObservers.set(symbol,cb);return{remove:function remove(){msgCountObservers.has(symbol)&&msgCountObservers.delete(symbol);}};}},{key:"updateMessageCount",value:function updateMessageCount(e){this._msgCount=e;this._msgCountObservers.forEach(function(cb){cb(e);});}},{key:"registerTokenObserver",value:function registerTokenObserver(cb){var symbol=Symbol();var tokenObservers=this._tokenObservers;tokenObservers.set(symbol,cb);return{remove:function remove(){tokenObservers.has(symbol)&&tokenObservers.delete(symbol);}};}},{key:"updateToken",value:function updateToken(e){this._tokenObservers.forEach(function(cb){cb(e);});}},{key:"refreshToken",value:function(){var _refreshToken=(0,_asyncToGenerator2.default)(function*(){var _this3=this;if(!this._account||!this._caHash){throw new Error('no account or caHash');}var account=this._account;var caHash=this._caHash;var _yield$this$service$v2=yield this.service.verifySignatureLoop(function(){return utils.getVerifyData(account,caHash);},function(){return caHash===_this3._caHash;},5),addressAuthToken=_yield$this$service$v2.data.token;var _yield$this$service$g3=yield this.service.getAuthTokenLoop({addressAuthToken:addressAuthToken},function(){return caHash===_this3._caHash;},5),token=_yield$this$service$g3.data.token;this.setAuthorization(token);this.updateToken(token);});function refreshToken(){return _refreshToken.apply(this,arguments);}return refreshToken;}()},{key:"rewriteFetch",value:function rewriteFetch(){var _this4=this;var send=this.fetchRequest.send;this.fetchRequest.send=(0,_asyncToGenerator2.default)(function*(){var _result$code;var caHash=_this4._caHash;for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}var result=yield send.apply(_this4.fetchRequest,args);if(caHash!==_this4._caHash)throw new Error('account changed');if(_constant.IM_TOKEN_ERROR_ARRAY.includes(result.code)){yield _this4.refreshToken();return yield send.apply(_this4.fetchRequest,args);}else if(((_result$code=result.code)==null?void 0:_result$code[0])!=='2'){throw result;}return result;});}},{key:"setUrl",value:function setUrl(_ref4){var apiUrl=_ref4.apiUrl,wsUrl=_ref4.wsUrl;this.config.setConfig({requestDefaults:{baseURL:apiUrl}});_im.config.setSocketURL(wsUrl);}},{key:"setAuthorization",value:function setAuthorization(token){var _this$config$requestC;this.config.setConfig({requestDefaults:{headers:Object.assign({},(_this$config$requestC=this.config.requestConfig)==null?void 0:_this$config$requestC.headers,{'R-Authorization':"Bearer "+token})}});_apiDid.request.set('headers',Object.assign({},_apiDid.request.defaultConfig.headers,{'R-Authorization':"Bearer "+token}));}},{key:"destroy",value:function destroy(){console.log('destroy im',this._caHash);this.status=_types.IMStatusEnum.DESTROY;this.setAuthorization('invalid_authorization');this.bindOffRelation();this._msgCount={unreadCount:0,mentionsCount:0};this._account=undefined;this._caHash=undefined;this._unreadMsgObservers.clear();this._channelMsgObservers.clear();this._connectObservers.clear();this._msgCountObservers.clear();this._tokenObservers.clear();this._imInstance&&this._imInstance.destroy();this._imInstance=undefined;}}]);return IM;}();var im=new IM();var _default=exports.default=im;