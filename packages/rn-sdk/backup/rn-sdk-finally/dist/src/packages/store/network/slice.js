Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _toolkit=require("@reduxjs/toolkit");var _network=require("../../constants/network");var _types=require("./types");var _utils=require("./utils");var _actions=require("./actions");var initialState={currentChain:_network.DefaultChain,networkType:'MAIN',chainList:[],commonList:[],rmCommonList:[]};var combineList=function combineList(list,customList,commonList,rmCommonList){return list==null?void 0:list.map(function(item){var isCommon=item.isCommon;if(item.isFixed){isCommon=true;}else if(commonList!=null&&commonList.includes(item.rpcUrl)){isCommon=true;}else if(rmCommonList!=null&&rmCommonList.includes(item.rpcUrl)){isCommon=false;}if(isCommon)(commonList!=null?commonList:[]).push(item.rpcUrl);return Object.assign({},item,{isCommon:isCommon,key:item.rpcUrl+"&"+item.networkName});}).concat(customList);};var chainSlice=(0,_toolkit.createSlice)({name:'chain',initialState:initialState,reducers:{setCurrentChain:function setCurrentChain(state,action){var rpcUrl=action.payload.rpcUrl;console.log(state.chainList,'chainList===setCurrentChain');var findItem=state.chainList.find(function(item){return item.rpcUrl===rpcUrl;});if(!findItem)throw new Error(_types.ChainActionError.notExist);state.currentChain=findItem;},removeCustomChainItem:function removeCustomChainItem(state,action){var _state$rmCommonList,_state$commonList;var chain=action.payload;var isCurrentChain=state.currentChain.key===chain.key;if(isCurrentChain)state.currentChain=_network.DefaultChain;state.chainList=state.chainList.filter(function(item){return item.key!==chain.key;});if((_state$rmCommonList=state.rmCommonList)!=null&&_state$rmCommonList.includes(chain.rpcUrl))state.rmCommonList.filter(function(item){return item!==chain.rpcUrl;});if((_state$commonList=state.commonList)!=null&&_state$commonList.includes(chain.rpcUrl))state.commonList.filter(function(item){return item!==chain.rpcUrl;});},addCommonList:function addCommonList(state,action){var _state$rmCommonList2;var rpcUrl=action.payload.rpcUrl;state.rmCommonList=((_state$rmCommonList2=state.rmCommonList)!=null?_state$rmCommonList2:[]).filter(function(item){return item!==rpcUrl;});state.commonList?state.commonList.push(rpcUrl):state.commonList=[rpcUrl];state.chainList=state.chainList.map(function(item){if(item.rpcUrl===rpcUrl)return Object.assign({},item,{isCommon:true});return item;});},removeCommonList:function removeCommonList(state,action){var _state$commonList2;var rpcUrl=action.payload.rpcUrl;state.commonList=((_state$commonList2=state.commonList)!=null?_state$commonList2:[]).filter(function(item){return item!==rpcUrl;});state.rmCommonList?state.rmCommonList.push(rpcUrl):state.rmCommonList=[rpcUrl];state.chainList=state.chainList.map(function(item){if(item.rpcUrl===rpcUrl)return Object.assign({},item,{isCommon:false});return item;});},resetNetwork:function resetNetwork(){return initialState;}},extraReducers:function extraReducers(builder){builder.addCase(_actions.fetchChainListAsync.fulfilled,function(state,action){var _action$payload$data,_action$payload$data$,_action$payload$data$2,_state$chainList$filt,_state$chainList,_state$commonList3,_state$rmCommonList3,_chainList$find;var network=(_action$payload$data=action.payload.data)==null?void 0:(_action$payload$data$=_action$payload$data[0])==null?void 0:(_action$payload$data$2=_action$payload$data$.attributes)==null?void 0:_action$payload$data$2.network;var customChainList=(_state$chainList$filt=(_state$chainList=state.chainList)==null?void 0:_state$chainList.filter(function(item){return item.isCustom;}))!=null?_state$chainList$filt:[];state.commonList=Array.from(new Set((_state$commonList3=state.commonList)!=null?_state$commonList3:[]));state.rmCommonList=Array.from(new Set((_state$rmCommonList3=state.rmCommonList)!=null?_state$rmCommonList3:[]));var _chainList=combineList(network,customChainList,state.commonList,state.rmCommonList);state.currentChain=(_chainList$find=_chainList.find(function(item){return item.rpcUrl===state.currentChain.rpcUrl;}))!=null?_chainList$find:_network.DefaultChain;state.chainList=_chainList;}).addCase(_actions.fetchChainListAsync.rejected,function(_state,action){throw Error(action.error.message);}).addCase(_actions.addCustomChainItem.fulfilled,function(state,action){var chain=action.payload;var error;var flag=state.chainList.some(function(item){if(item.rpcUrl===chain.rpcUrl)error=_types.ChainActionError.hasRpcUrl;else if(item.networkName===chain.networkName)error=_types.ChainActionError.hasName;return!!error;});if(flag)throw new Error(error);state.chainList=state.chainList.concat(chain);}).addCase(_actions.addCustomChainItem.rejected,function(_,action){throw action.error;}).addCase(_actions.updateCustomChainItem.fulfilled,function(state,action){var chain=action.payload;var isCurrentChain=state.currentChain.key===chain.key;(0,_utils.checkNetworkName)(state.chainList,chain.networkName,undefined,chain.key);var error;var flag=state.chainList.some(function(item){if(item.key===chain.key)return false;if(item.rpcUrl===chain.rpcUrl)error=_types.ChainActionError.hasRpcUrl;else if(item.networkName===chain.networkName)error=_types.ChainActionError.hasName;return!!error;});if(flag)throw new Error(error);if(isCurrentChain)state.currentChain=Object.assign({},chain,{key:chain.rpcUrl+"&"+chain.networkName});state.chainList=state.chainList.map(function(item){return item.key===chain.key?Object.assign({},chain,{key:chain.rpcUrl+"&"+chain.networkName}):item;});}).addCase(_actions.updateCustomChainItem.rejected,function(_state,action){throw action.error;});}});var _default=exports.default=chainSlice;