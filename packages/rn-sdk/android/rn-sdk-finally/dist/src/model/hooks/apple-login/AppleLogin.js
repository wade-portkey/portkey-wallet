var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _react=_interopRequireWildcard(require("react"));var _reactNative=require("react-native");var _reactNativeWebview=_interopRequireDefault(require("react-native-webview"));var _jsxFileName="/Users/fengfeiyang/aelf/portkey-wallet/packages/rn-sdk/android/rn-sdk-finally/src/model/hooks/apple-login/AppleLogin.tsx";function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap(),t=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r;})(e);}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&Object.prototype.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u];}return n.default=e,t&&t.set(e,n),n;}var styles=_reactNative.StyleSheet.create({webView:{flex:1,backgroundColor:'white'},loadingContainer:{position:'absolute',top:0,left:0,bottom:0,right:0,justifyContent:'center',alignItems:'center'},transparentHeader:{height:'20%',width:'100%',backgroundColor:'transparent'}});var AppleLogin=(0,_react.forwardRef)(function AppleLogin(_ref,ref){var _this=this;var loadingComponent=_ref.loadingComponent,onVerify=_ref.onVerify,onExpire=_ref.onExpire,onError=_ref.onError,onClose=_ref.onClose,onLoad=_ref.onLoad,size=_ref.size,baseUrl=_ref.baseUrl,style=_ref.style;var isClosed=(0,_react.useRef)(false);var webViewRef=(0,_react.useRef)();var _useState=(0,_react.useState)(true),_useState2=(0,_slicedToArray2.default)(_useState,2),setVisible=_useState2[1];var _useState3=(0,_react.useState)(true),_useState4=(0,_slicedToArray2.default)(_useState3,2),loading=_useState4[0],setLoading=_useState4[1];var isInvisibleSize=size==='invisible';var handleLoad=(0,_react.useCallback)(function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}onLoad==null?void 0:onLoad.apply(void 0,args);setLoading(false);},[onLoad]);var handleClose=(0,_react.useCallback)(function(){if(isClosed.current)return;isClosed.current=true;setVisible(false);for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}onClose==null?void 0:onClose.apply(void 0,args);},[onClose]);var handleMessage=(0,_react.useCallback)(function(content){try{var _payload$data,_payload$data2;var payload=JSON.parse(content.nativeEvent.data);console.log('payload',payload);if(payload.close&&isInvisibleSize){handleClose();}if(payload.closeWebView){handleClose();}if(payload.load){handleLoad.apply(void 0,(0,_toConsumableArray2.default)(payload.load));}if(payload.expire){onExpire==null?void 0:onExpire(payload.expire);}if(payload.error){handleClose();onError==null?void 0:onError(payload.error[0]);}if((payload==null?void 0:payload.type)==='PortkeySocialLoginOnSuccess'&&(payload==null?void 0:(_payload$data=payload.data)==null?void 0:_payload$data.provider)==='Apple'&&payload!=null&&(_payload$data2=payload.data)!=null&&_payload$data2.token){var _payload$data3;handleClose('verified');onVerify==null?void 0:onVerify(payload==null?void 0:(_payload$data3=payload.data)==null?void 0:_payload$data3.token);}}catch(err){console.warn(err);}},[onVerify,onExpire,onError,handleClose,handleLoad,isInvisibleSize]);(0,_react.useImperativeHandle)(ref,function(){return{open:function open(){setVisible(true);setLoading(true);isClosed.current=false;},close:handleClose};},[handleClose]);var webViewStyles=(0,_react.useMemo)(function(){return[styles.webView,style];},[style]);var renderLoading=function renderLoading(){if(!loading||!loadingComponent)return null;return _react.default.createElement(_reactNative.View,{style:styles.loadingContainer,__self:_this,__source:{fileName:_jsxFileName,lineNumber:137,columnNumber:12}},loadingComponent);};return _react.default.createElement(_react.default.Fragment,null,_react.default.createElement(_reactNative.TouchableOpacity,{style:styles.transparentHeader,onPress:onClose,__self:this,__source:{fileName:_jsxFileName,lineNumber:142,columnNumber:7}}),_react.default.createElement(_reactNativeWebview.default,{ref:webViewRef,source:{uri:baseUrl},style:webViewStyles,onMessage:handleMessage,injectedJavaScript:"(()=>{\n          try {\n            if(!window.opener) window.opener = {}\n            window.opener.postMessage = obj => {\n              window.ReactNativeWebView.postMessage(JSON.stringify(obj));\n            };\n          } catch (error) {\n            alert(JSON.stringify(error));\n          }\n        })()",__self:this,__source:{fileName:_jsxFileName,lineNumber:143,columnNumber:7}}),renderLoading());});var _default=exports.default=AppleLogin;