var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=exports.PageStyle=exports.InvalidQRCodeText=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _react=_interopRequireWildcard(require("react"));var _expoBarcodeScanner=require("expo-barcode-scanner");var _reactNative=require("react-native");var _Svg=_interopRequireDefault(require("../../components/Svg"));var _unit=require("../../utils/unit");var _theme=require("../../assets/theme");var _hooks=require("../../i18n/hooks");var ImagePicker=_interopRequireWildcard(require("expo-image-picker"));var _CommonText=require("../../components/CommonText");var _GStyles=_interopRequireDefault(require("../../assets/theme/GStyles"));var _styles=require("../../assets/theme/styles");var _device=require("../../packages/utils/mobile/device");var _expoCamera=require("expo-camera");var _qrCode=require("../../packages/utils/qrCode");var _browser=require("../../packages/utils/dapp/browser");var _Loading=_interopRequireDefault(require("../../components/Loading"));var _CommonToast=_interopRequireDefault(require("../../components/CommonToast"));var _qrcode=require("../../packages/types/types-ca/qrcode");var _utils=require("../../packages/utils");var _UseBaseContainer=_interopRequireDefault(require("../../model/container/UseBaseContainer"));var _entries=require("../../config/entries");var _nativeModules=require("../../service/native-modules");var _useEffectOnce=_interopRequireDefault(require("../../hooks/useEffectOnce"));var _core=require("../../model/verify/core");var _scheme=require("../../utils/scheme");var _commonUtil=require("../../utils/commonUtil");var _network=require("../../model/hooks/network");var _this=this,_jsxFileName="/Users/fengfeiyang/aelf/portkey-wallet/packages/rn-sdk/android/rn-sdk-finally/src/pages/QrScanner/index.tsx";function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap(),t=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r;})(e);}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&Object.prototype.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u];}return n.default=e,t&&t.set(e,n),n;}var QrScanner=function QrScanner(){var _useLanguage=(0,_hooks.useLanguage)(),t=_useLanguage.t;var canScan=(0,_react.useRef)(true);var _useState=(0,_react.useState)(),_useState2=(0,_slicedToArray2.default)(_useState,2),refresh=_useState2[0],setRefresh=_useState2[1];var _useState3=(0,_react.useState)(false),_useState4=(0,_slicedToArray2.default)(_useState3,2),permissionGranted=_useState4[0],setPermissionGranted=_useState4[1];var _useBaseContainer=(0,_UseBaseContainer.default)({entryName:_entries.PortkeyEntries.SCAN_QR_CODE}),onFinish=_useBaseContainer.onFinish,navigateForResult=_useBaseContainer.navigateForResult,navigationTo=_useBaseContainer.navigateTo;var navigateBack=function navigateBack(){var res=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{status:'success',data:{}};onFinish(res);};(0,_useEffectOnce.default)((0,_asyncToGenerator2.default)(function*(){setRefresh(false);var isOpen=yield ensurePermission('camera',withoutPermissionWarning);setPermissionGranted(isOpen);}));var withoutPermissionWarning=function withoutPermissionWarning(){var fatal=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;_CommonToast.default.fail("Please allow permissions to use"+(fatal?', page will close in 3 seconds':'')+".");fatal&&setTimeout(function(){navigateBack({status:'fail',data:{}});},3000);};var invalidQRCode=function invalidQRCode(text){_CommonToast.default.fail(text);};var handleQRCodeData=function(){var _ref2=(0,_asyncToGenerator2.default)(function*(data){var address=data.address,chainType=data.chainType;if(!(0,_utils.isAddress)(address,chainType))return invalidQRCode(InvalidQRCodeText.INVALID_QR_CODE);if((0,_qrcode.isLoginQRData)(data)){if(!(yield(0,_core.isWalletUnlocked)()))return invalidQRCode(InvalidQRCodeText.DID_NOT_UNLOCK);navigateForResult(_entries.PortkeyEntries.SCAN_LOG_IN,{params:{data:JSON.stringify(data)}},function(){setRefresh(false);});setRefresh(true);}else{_CommonToast.default.fail('Content not supported by now');}});return function handleQRCodeData(_x){return _ref2.apply(this,arguments);};}();var handlePortKeyScheme=(0,_react.useCallback)(function(portkeyUrl){var isEntry=(0,_scheme.isEntryScheme)(portkeyUrl);console.log('handlePortKeyScheme isEntry',isEntry);if(isEntry){var entry=isEntry.entry;var params=isEntry.query;if(entry!==undefined&&(0,_entries.isPortkeyEntries)(entry)){navigationTo(entry,{params:params});}else{_CommonToast.default.fail("It looks like you want to jump to the page, but you don't have the right entry parameter");}}},[navigationTo]);var handleBarCodeScanned=(0,_commonUtil.myThrottle)(function(){var _ref4=(0,_asyncToGenerator2.default)(function*(_ref3){var _ref3$data=_ref3.data,data=_ref3$data===void 0?'':_ref3$data;if(!canScan.current){return;}canScan.current=false;if(typeof data!=='string')return invalidQRCode(InvalidQRCodeText.INVALID_QR_CODE);var currentNetwork=yield(0,_network.getCurrentNetworkType)();try{var str=data.replace(/("|'|\s)/g,'');if((0,_browser.checkIsUrl)(str)){if((0,_scheme.checkIsPortKeyUrl)(str)){handlePortKeyScheme(str);}else{return invalidQRCode(InvalidQRCodeText.INVALID_QR_CODE);}return;}var qrCodeData=(0,_qrCode.expandQrData)(JSON.parse(data));if(currentNetwork!==qrCodeData.netWorkType){var invalidText=InvalidQRCodeText.INVALID_QR_CODE;switch(qrCodeData.netWorkType){case'MAIN':invalidText=InvalidQRCodeText.SWITCH_TO_MAINNET;break;case'TESTNET':invalidText=InvalidQRCodeText.SWITCH_TO_TESTNET;break;case'TEST1':invalidText=InvalidQRCodeText.SWITCH_TO_TEST1;break;}return invalidQRCode(invalidText);}handleQRCodeData(qrCodeData);}catch(error){console.log(error);return invalidQRCode(InvalidQRCodeText.INVALID_QR_CODE);}finally{_Loading.default.hide();canScan.current=true;}});return function(_x2){return _ref4.apply(this,arguments);};}(),3000);var selectImage=function(){var _ref5=(0,_asyncToGenerator2.default)(function*(){var permission=yield ensurePermission('photo',withoutPermissionWarning,false);if(!permission)return;var uri;if(_reactNative.Platform.OS==='android'){uri=yield(0,_nativeModules.chooseImageAndroid)();}else{var _result$assets$0$uri,_result$assets,_result$assets$;var result=yield ImagePicker.launchImageLibraryAsync({mediaTypes:ImagePicker.MediaTypeOptions.Images,allowsEditing:false});uri=(_result$assets$0$uri=result==null?void 0:(_result$assets=result.assets)==null?void 0:(_result$assets$=_result$assets[0])==null?void 0:_result$assets$.uri)!=null?_result$assets$0$uri:undefined;}console.log('uri',uri);if(uri){var _scanResult$,_scanResult$2;var scanResult=yield _expoBarcodeScanner.BarCodeScanner.scanFromURLAsync(uri,[_expoBarcodeScanner.BarCodeScanner.Constants.BarCodeType.qr]);console.log('qrResult',(_scanResult$=scanResult[0])==null?void 0:_scanResult$.data,uri);if((_scanResult$2=scanResult[0])!=null&&_scanResult$2.data){var _scanResult$3;handleBarCodeScanned({data:((_scanResult$3=scanResult[0])==null?void 0:_scanResult$3.data)||''});}else{_CommonToast.default.fail('No QR code found in the picture');}}});return function selectImage(){return _ref5.apply(this,arguments);};}();var cameraView=function cameraView(){return _react.default.createElement(_expoCamera.Camera,{ratio:'16:9',style:[PageStyle.barCodeScanner,!_device.isIOS&&PageStyle.barCodeScannerAndroid],onBarCodeScanned:handleBarCodeScanned,__self:_this,__source:{fileName:_jsxFileName,lineNumber:175,columnNumber:7}},_react.default.createElement(_reactNative.SafeAreaView,{style:PageStyle.innerView,__self:_this,__source:{fileName:_jsxFileName,lineNumber:183,columnNumber:9}},_react.default.createElement(_reactNative.View,{style:PageStyle.iconWrap,__self:_this,__source:{fileName:_jsxFileName,lineNumber:184,columnNumber:11}},_react.default.createElement(_reactNative.Text,{style:PageStyle.leftBlock,__self:_this,__source:{fileName:_jsxFileName,lineNumber:185,columnNumber:13}}),_react.default.createElement(_reactNative.TouchableOpacity,{style:PageStyle.svgWrap,onPress:function onPress(){navigateBack({status:'cancel',data:{}});},__self:_this,__source:{fileName:_jsxFileName,lineNumber:186,columnNumber:13}},_react.default.createElement(_Svg.default,{icon:"close1",size:(0,_unit.pTd)(14),iconStyle:PageStyle.icon,__self:_this,__source:{fileName:_jsxFileName,lineNumber:191,columnNumber:15}}))),_react.default.createElement(_Svg.default,{icon:"scan-square",size:(0,_unit.pTd)(240),iconStyle:PageStyle.scan,__self:_this,__source:{fileName:_jsxFileName,lineNumber:194,columnNumber:11}}),_react.default.createElement(_CommonText.TextM,{style:PageStyle.tips,__self:_this,__source:{fileName:_jsxFileName,lineNumber:195,columnNumber:11}},t('only support Login code by now')),_react.default.createElement(_reactNative.TouchableOpacity,{style:[PageStyle.albumWrap,_GStyles.default.alignCenter],onPress:selectImage,__self:_this,__source:{fileName:_jsxFileName,lineNumber:197,columnNumber:11}},_react.default.createElement(_Svg.default,{icon:"album",size:(0,_unit.pTd)(48),__self:_this,__source:{fileName:_jsxFileName,lineNumber:198,columnNumber:13}}),_react.default.createElement(_CommonText.TextM,{style:[_styles.FontStyles.font2,PageStyle.albumText],__self:_this,__source:{fileName:_jsxFileName,lineNumber:199,columnNumber:13}},t('Album')))));};var emptyView=function emptyView(){return _react.default.createElement(_reactNative.SafeAreaView,{style:[PageStyle.innerView,PageStyle.blackBg],__self:_this,__source:{fileName:_jsxFileName,lineNumber:208,columnNumber:7}},_react.default.createElement(_reactNative.View,{style:PageStyle.iconWrap,__self:_this,__source:{fileName:_jsxFileName,lineNumber:209,columnNumber:9}},_react.default.createElement(_reactNative.Text,{style:PageStyle.leftBlock,__self:_this,__source:{fileName:_jsxFileName,lineNumber:210,columnNumber:11}}),_react.default.createElement(_reactNative.TouchableOpacity,{style:PageStyle.svgWrap,onPress:function onPress(){navigateBack({status:'cancel',data:{}});},__self:_this,__source:{fileName:_jsxFileName,lineNumber:211,columnNumber:11}},_react.default.createElement(_Svg.default,{icon:"close1",size:(0,_unit.pTd)(14),iconStyle:PageStyle.icon,__self:_this,__source:{fileName:_jsxFileName,lineNumber:216,columnNumber:13}}))),_react.default.createElement(_Svg.default,{icon:"scan-square",size:(0,_unit.pTd)(240),iconStyle:PageStyle.scan,__self:_this,__source:{fileName:_jsxFileName,lineNumber:219,columnNumber:9}}),_react.default.createElement(_CommonText.TextM,{style:PageStyle.tips,__self:_this,__source:{fileName:_jsxFileName,lineNumber:220,columnNumber:9}},t('only support Login code by now')),_react.default.createElement(_reactNative.TouchableOpacity,{style:[PageStyle.albumWrap,_GStyles.default.alignCenter],onPress:selectImage,__self:_this,__source:{fileName:_jsxFileName,lineNumber:222,columnNumber:9}},_react.default.createElement(_Svg.default,{icon:"album",size:(0,_unit.pTd)(48),__self:_this,__source:{fileName:_jsxFileName,lineNumber:223,columnNumber:11}}),_react.default.createElement(_CommonText.TextM,{style:[_styles.FontStyles.font2,PageStyle.albumText],__self:_this,__source:{fileName:_jsxFileName,lineNumber:224,columnNumber:11}},t('Album'))));};return _react.default.createElement(_reactNative.View,{style:PageStyle.wrapper,__self:_this,__source:{fileName:_jsxFileName,lineNumber:230,columnNumber:10}},refresh?null:permissionGranted?cameraView():emptyView());};var _default=exports.default=QrScanner;var PageStyle=exports.PageStyle=_reactNative.StyleSheet.create({wrapper:{width:'100%',height:'100%',opacity:0.85,backgroundColor:_theme.defaultColors.bgColor1},barCodeScanner:{width:'100%',height:'100%',position:'absolute',zIndex:100},barCodeScannerAndroid:{width:_device.screenWidth,height:_device.screenHeight},innerView:{width:'100%',height:'100%'},iconWrap:{marginTop:(0,_unit.pTd)(16),width:'100%',display:'flex',flexDirection:'row',justifyContent:'flex-end',alignItems:'flex-end'},icon:{width:(0,_unit.pTd)(40)},svgWrap:Object.assign({},_GStyles.default.paddingArg(16,0,16,16)),scan:{marginTop:(0,_unit.pTd)(136),marginLeft:'auto',marginRight:'auto'},title:{marginTop:(0,_unit.pTd)(62),fontSize:(0,_unit.pTd)(16),color:_theme.defaultColors.font2,textAlign:'center'},tips:{color:_theme.defaultColors.font7,textAlign:'center',width:_device.screenWidth,lineHeight:(0,_unit.pTd)(20),marginTop:(0,_unit.pTd)(54)},albumWrap:{position:'absolute',bottom:(0,_unit.pTd)(75)},albumText:{marginTop:(0,_unit.pTd)(4),textAlign:'center'},leftBlock:{flex:1},blackBg:{backgroundColor:'black',opacity:0.85}});var InvalidQRCodeText=exports.InvalidQRCodeText=function(InvalidQRCodeText){InvalidQRCodeText["SWITCH_TO_MAINNET"]="Please switch to aelf Mainnet before scanning the QR code";InvalidQRCodeText["SWITCH_TO_TESTNET"]="Please switch to aelf Testnet before scanning the QR code";InvalidQRCodeText["SWITCH_TO_TEST1"]="Please switch to aelf Test1 before scanning the QR code";InvalidQRCodeText["INVALID_QR_CODE"]="The QR code is invalid";InvalidQRCodeText["DID_NOT_UNLOCK"]="Please unlock your wallet first";return InvalidQRCodeText;}({});var ensurePermission=function(){var _ref6=(0,_asyncToGenerator2.default)(function*(permission,ifThrowError){var fatal=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;try{var isOpen=yield _nativeModules.PortkeyModulesEntity.PermissionModule.isPermissionGranted(permission);if(isOpen){return true;}else{yield _nativeModules.PortkeyModulesEntity.PermissionModule.requestPermission(permission);if(!(yield _nativeModules.PortkeyModulesEntity.PermissionModule.isPermissionGranted(permission))){throw new Error('camera permission denied');}return true;}}catch(e){console.error(e);ifThrowError(fatal);}return false;});return function ensurePermission(_x3,_x4){return _ref6.apply(this,arguments);};}();