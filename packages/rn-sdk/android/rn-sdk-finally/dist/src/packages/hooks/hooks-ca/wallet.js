var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.useWallet=exports.useSetWalletName=exports.useOtherNetworkLogged=exports.useOriginChainId=exports.useDeviceList=exports.useCurrentWalletInfo=exports.useCurrentWallet=exports.useCurrentCaInfo=exports.useChainIdList=exports.useCaInfo=exports.useCaAddresses=exports.useCaAddressInfoList=void 0;var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _index=require("./index");var _react=require("react");var _network=require("./network");var _chainList=require("./chainList");var _apiDid=require("../../api/api-did");var _=require("./..");var _actions=require("packages/types/store-ca/wallet/actions");var _device=require("../../utils/device");var _network2=require("../../constants/constants-ca/network");var _queries=require("../../graphql/contract/queries");function getCurrentWalletInfo(walletInfo,currentNetwork,originChainId){var _walletInfo$caInfo,_currentCAInfo$origin,_Object$values,_Object$values$filter;var currentCAInfo=walletInfo==null?void 0:(_walletInfo$caInfo=walletInfo.caInfo)==null?void 0:_walletInfo$caInfo[currentNetwork];var tmpWalletInfo=Object.assign({},walletInfo,currentCAInfo,{caHash:currentCAInfo==null?void 0:(_currentCAInfo$origin=currentCAInfo[originChainId])==null?void 0:_currentCAInfo$origin.caHash,caAddressList:(_Object$values=Object.values(currentCAInfo||{}))==null?void 0:(_Object$values$filter=_Object$values.filter(function(info){return!!(info!=null&&info.caAddress);}))==null?void 0:_Object$values$filter.map(function(i){return i==null?void 0:i.caAddress;})});if(tmpWalletInfo.caInfo)delete tmpWalletInfo.caInfo;return tmpWalletInfo;}var useWallet=exports.useWallet=function useWallet(){return(0,_index.useAppCASelector)(function(state){return state.wallet;});};var useCurrentWalletInfo=exports.useCurrentWalletInfo=function useCurrentWalletInfo(){var _useWallet=useWallet(),currentNetwork=_useWallet.currentNetwork,walletInfo=_useWallet.walletInfo;var originChainId=useOriginChainId();return(0,_react.useMemo)(function(){return getCurrentWalletInfo(walletInfo,currentNetwork,originChainId);},[walletInfo,currentNetwork,originChainId]);};var useCurrentWallet=exports.useCurrentWallet=function useCurrentWallet(){var wallet=useWallet();var originChainId=useOriginChainId();return(0,_react.useMemo)(function(){var walletInfo=wallet.walletInfo,currentNetwork=wallet.currentNetwork,chainInfo=wallet.chainInfo;return Object.assign({},wallet,{walletInfo:getCurrentWalletInfo(walletInfo,currentNetwork,originChainId),chainList:chainInfo==null?void 0:chainInfo[currentNetwork]});},[originChainId,wallet]);};var defaultUseDeviceListConfig={isInit:true,isAmountOnly:false};var useDeviceList=exports.useDeviceList=function useDeviceList(config){var _defaultUseDeviceList=Object.assign({},defaultUseDeviceListConfig,config),isInit=_defaultUseDeviceList.isInit,isAmountOnly=_defaultUseDeviceList.isAmountOnly,onError=_defaultUseDeviceList.onError;var networkInfo=(0,_network.useCurrentNetworkInfo)();var walletInfo=useCurrentWalletInfo();var originChainId=useOriginChainId();var chainInfo=(0,_chainList.useCurrentChain)(originChainId);var _useState=(0,_react.useState)(false),_useState2=(0,_slicedToArray2.default)(_useState,2),loading=_useState2[0],setLoading=_useState2[1];var _useState3=(0,_react.useState)([]),_useState4=(0,_slicedToArray2.default)(_useState3,2),deviceList=_useState4[0],setDeviceList=_useState4[1];var _useState5=(0,_react.useState)(0),_useState6=(0,_slicedToArray2.default)(_useState5,2),deviceAmount=_useState6[0],setDeviceAmount=_useState6[1];var getDeviceList=(0,_react.useCallback)(function(){var _ref=(0,_asyncToGenerator2.default)(function*(managerInfos){var extraDataStrList=managerInfos.map(function(item){return(item==null?void 0:item.extraData)||'';});var extraDataList=yield(0,_device.extraDataListDecode)(extraDataStrList);var _deviceList=managerInfos.map(function(item,idx){return Object.assign({},extraDataList[idx],{managerAddress:item==null?void 0:item.address});}).reverse();setDeviceList(_deviceList);});return function(_x){return _ref.apply(this,arguments);};}(),[]);var refresh=(0,_react.useCallback)((0,_asyncToGenerator2.default)(function*(){setLoading(true);try{var result=yield(0,_queries.getCAHolderManagerInfo)(networkInfo.networkType,{dto:{chainId:chainInfo==null?void 0:chainInfo.chainId,caHash:walletInfo.caHash,skipCount:0,maxResultCount:200}});var _ref3=result||{},data=_ref3.data;if(!data||!data.caHolderManagerInfo||data.caHolderManagerInfo.length<1){throw new Error('no data');}var caHolderManagerInfo=data.caHolderManagerInfo[0];var managersInfos=(caHolderManagerInfo==null?void 0:caHolderManagerInfo.managerInfos)||[];setDeviceAmount(managersInfos.length);if(!isAmountOnly){yield getDeviceList(managersInfos);}}catch(error){console.log('useDeviceList: error',error);setDeviceList([]);setDeviceAmount(0);onError==null?void 0:onError(error);}setLoading(false);}),[chainInfo==null?void 0:chainInfo.chainId,getDeviceList,isAmountOnly,networkInfo.networkType,onError,walletInfo.caHash]);(0,_react.useEffect)(function(){isInit&&refresh();},[]);return{refresh:refresh,deviceList:deviceList,deviceAmount:deviceAmount,loading:loading};};var useSetWalletName=exports.useSetWalletName=function useSetWalletName(){var dispatch=(0,_.useAppCommonDispatch)();var networkInfo=(0,_network.useCurrentNetworkInfo)();return(0,_react.useCallback)(function(){var _ref4=(0,_asyncToGenerator2.default)(function*(nickName){yield _apiDid.request.wallet.editWalletName({baseURL:networkInfo.apiUrl,params:{nickName:nickName}});dispatch((0,_actions.setWalletNameAction)(nickName));});return function(_x2){return _ref4.apply(this,arguments);};}(),[dispatch,networkInfo]);};var useCaAddresses=exports.useCaAddresses=function useCaAddresses(){var _walletInfo$caInfo2;var _useWallet2=useWallet(),walletInfo=_useWallet2.walletInfo,currentNetwork=_useWallet2.currentNetwork;var list=useChainIdList();var currentCAInfo=walletInfo==null?void 0:(_walletInfo$caInfo2=walletInfo.caInfo)==null?void 0:_walletInfo$caInfo2[currentNetwork];return(0,_react.useMemo)(function(){var _Object$entries,_Object$entries$filte;return(_Object$entries=Object.entries(currentCAInfo||{}))==null?void 0:(_Object$entries$filte=_Object$entries.filter(function(info){var _info$;return(list==null?void 0:list.includes(info[0]))&&!!((_info$=info[1])!=null&&_info$.caAddress);}))==null?void 0:_Object$entries$filte.map(function(i){return i[1].caAddress;});},[currentCAInfo,list]);};var useCaAddressInfoList=exports.useCaAddressInfoList=function useCaAddressInfoList(){var _walletInfo$caInfo3;var _useWallet3=useWallet(),walletInfo=_useWallet3.walletInfo,currentNetwork=_useWallet3.currentNetwork;var list=useChainIdList();var currentCAInfo=walletInfo==null?void 0:(_walletInfo$caInfo3=walletInfo.caInfo)==null?void 0:_walletInfo$caInfo3[currentNetwork];return(0,_react.useMemo)(function(){var _Object$entries2,_Object$entries2$filt;return(_Object$entries2=Object.entries(currentCAInfo||{}))==null?void 0:(_Object$entries2$filt=_Object$entries2.filter(function(info){var _info$2;return(list==null?void 0:list.includes(info[0]))&&!!((_info$2=info[1])!=null&&_info$2.caAddress);}))==null?void 0:_Object$entries2$filt.map(function(i){return{chainId:i[0],caAddress:i[1].caAddress};});},[currentCAInfo,list]);};var useChainIdList=exports.useChainIdList=function useChainIdList(){var _useWallet4=useWallet(),walletInfo=_useWallet4.walletInfo,currentNetwork=_useWallet4.currentNetwork;var chainList=(0,_chainList.useCurrentChainList)();return(0,_react.useMemo)(function(){var _walletInfo$caInfo4,_Object$keys;var currentCAInfo=walletInfo==null?void 0:(_walletInfo$caInfo4=walletInfo.caInfo)==null?void 0:_walletInfo$caInfo4[currentNetwork];return(_Object$keys=Object.keys(currentCAInfo||{}))==null?void 0:_Object$keys.filter(function(info){return chainList==null?void 0:chainList.some(function(chain){return chain.chainId===info;});});},[chainList,currentNetwork,walletInfo==null?void 0:walletInfo.caInfo]);};var useCaInfo=exports.useCaInfo=function useCaInfo(){return useWallet().chainInfo;};var useCurrentCaInfo=exports.useCurrentCaInfo=function useCurrentCaInfo(){var _useWallet5=useWallet(),walletInfo=_useWallet5.walletInfo,currentNetwork=_useWallet5.currentNetwork;return(0,_react.useMemo)(function(){var _walletInfo$caInfo5;return walletInfo==null?void 0:(_walletInfo$caInfo5=walletInfo.caInfo)==null?void 0:_walletInfo$caInfo5[currentNetwork];},[walletInfo,currentNetwork]);};var useOriginChainId=exports.useOriginChainId=function useOriginChainId(){var _useWallet6=useWallet(),originChainId=_useWallet6.originChainId;var caInfo=useCurrentCaInfo();return(0,_react.useMemo)(function(){return(caInfo==null?void 0:caInfo.originChainId)||originChainId||_network2.DefaultChainId;},[caInfo==null?void 0:caInfo.originChainId,originChainId]);};var useOtherNetworkLogged=exports.useOtherNetworkLogged=function useOtherNetworkLogged(){var _useWallet7=useWallet(),walletInfo=_useWallet7.walletInfo,currentNetwork=_useWallet7.currentNetwork;var _ref5=walletInfo||{},caInfo=_ref5.caInfo;return(0,_react.useMemo)(function(){return!!Object.keys(caInfo||{}).filter(function(key){return key!==currentNetwork;}).length;},[caInfo,currentNetwork]);};